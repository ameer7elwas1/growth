<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> IraqCell</title>
  
  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Simple CSS (RTL, responsive) -->
  <style>
    :root{
      --bg: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --card: rgba(255,255,255,0.08);
      --accent: #6366f1;
      --accent-hover: #5b5bd6;
      --muted: #94a3b8;
      --success: #10b981;
      --danger: #f43f5e;
      --warning: #f59e0b;
      --panel-bg: rgba(255,255,255,0.05);
      --glass: rgba(255,255,255,0.08);
      --glass-hover: rgba(255,255,255,0.12);
      --shadow-sm: 0 4px 12px rgba(0,0,0,0.15);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.2);
      --shadow-lg: 0 16px 48px rgba(0,0,0,0.3);
      --border-radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: "Inter", "SF Pro Display", "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
    }
    :root.light{
      --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      --card: rgba(255,255,255,0.9);
      --accent: #6366f1;
      --accent-hover: #5b5bd6;
      --muted: #64748b;
      --success: #10b981;
      --danger: #f43f5e;
      --warning: #f59e0b;
      --panel-bg: rgba(255,255,255,0.8);
      --glass: rgba(0,0,0,0.03);
      --glass-hover: rgba(0,0,0,0.06);
      --shadow-sm: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.12);
      --shadow-lg: 0 16px 48px rgba(0,0,0,0.16);
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„ */
    :root.light tbody tr:nth-child(even){background:rgba(0,0,0,0.02);}
    :root.light tbody tr:hover{background:rgba(0,0,0,0.05);}
    :root.light th, :root.light td{border-bottom:1px solid rgba(0,0,0,0.08);}
    :root.light th{border-bottom:1px solid rgba(0,0,0,0.15);}
    :root.light tr.subtotal-title td{background:rgba(0,0,0,0.08); border-bottom:1px solid rgba(0,0,0,0.12);}
    :root.light tr.subtotal-values td{background:rgba(0,0,0,0.04); border-bottom:1px solid rgba(0,0,0,0.08);}
    :root.light .phase-header td{background:rgba(0,0,0,0.08); border-bottom:1px solid rgba(0,0,0,0.12);}
    
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ø±Ø¯Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ */
    :root.light .stat:nth-child(1) {
      background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.03));
      border-color: rgba(99,102,241,0.2);
    }
    :root.light .stat:nth-child(2) {
      background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(16,185,129,0.03));
      border-color: rgba(16,185,129,0.2);
    }
    :root.light .stat:nth-child(3) {
      background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(245,158,11,0.03));
      border-color: rgba(245,158,11,0.2);
    }
    :root.light .stat:nth-child(4) {
      background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03));
      border-color: rgba(239,68,68,0.2);
    }
    body{
      background: var(--bg); 
      color: #e2e8f0; 
      margin: 0; 
      padding: 24px; 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-smooth: always;
      text-rendering: optimizeLegibility;
      backdrop-filter: blur(20px);
      min-height: 100vh;
      font-weight: 400;
      line-height: 1.6;
    }
    body.light{
      background: var(--bg); 
      color:#1e293b;
    }
    .container{max-width:1200px; margin:0 auto;}
    header{
      display: flex; 
      gap: 16px; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 20px;
      padding: 16px 20px;
      background: var(--card);
      border-radius: var(--border-radius);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: var(--shadow-md);
    }
    h1{
      font-size: 24px; 
      margin: 0; 
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), #a78bfa, #ffffff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
      position: relative;
    }
    h1::after{
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, var(--accent), transparent);
      border-radius: 1px;
    }
    p.lead{
      margin:4px 0 0; 
      color:var(--muted); 
      font-size:14px;
      font-weight: 500;
      letter-spacing: -0.01em;
    }
    .card{
      background: var(--card); 
      padding: 20px; 
      border-radius: var(--border-radius); 
      box-shadow: var(--shadow-md);
      margin-bottom: 16px;
      border: 1px solid rgba(99,102,241,0.1);
      backdrop-filter: blur(20px);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0.6;
    }
    .card::after{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(99,102,241,0.02), transparent);
      pointer-events: none;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(99,102,241,0.2);
    }
    .card:hover::before{
      opacity: 1;
    }
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    input[type="file"]{display:none;}
    .btn{
      background: var(--accent); 
      color: #fff; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 12px;
      letter-spacing: -0.01em;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn::before{
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover::before{
      left: 100%;
    }
    .btn:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .btn.secondary{
      background: transparent; 
      border: 1px solid rgba(255,255,255,0.1); 
      color: var(--muted);
      backdrop-filter: blur(10px);
    }
    .btn.secondary:hover{
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.2);
    }
    .btn.warn{
      background: var(--warning); 
      color: #072;
    }
    /* ØªÙ… Ø­Ø°Ù CSS Ù„Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± */
    .flex{display:flex; gap:8px; align-items:center;}
    .stats{display:flex; gap:16px; flex-wrap:wrap;}
    .stat{
      flex: 1 1 160px; 
      background: var(--glass); 
      padding: 16px; 
      border-radius: var(--border-radius); 
      min-width: 140px;
      border: 1px solid rgba(99,102,241,0.15);
      backdrop-filter: blur(20px);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ø±Ø¯Ø§Øª */
    .stat:nth-child(1) {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(99,102,241,0.05));
      border-color: rgba(99,102,241,0.3);
    }
    .stat:nth-child(1)::before {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
    }
    
    .stat:nth-child(2) {
      background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));
      border-color: rgba(16,185,129,0.3);
    }
    .stat:nth-child(2)::before {
      background: linear-gradient(90deg, #10b981, #34d399);
    }
    
    .stat:nth-child(3) {
      background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
      border-color: rgba(245,158,11,0.3);
    }
    .stat:nth-child(3)::before {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }
    
    .stat:nth-child(4) {
      background: linear-gradient(135deg, rgba(239,68,68,0.1), rgba(239,68,68,0.05));
      border-color: rgba(239,68,68,0.3);
    }
    .stat:nth-child(4)::before {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
    .stat::before{
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), rgba(99,102,241,0.5), transparent);
    }
    .stat:hover{
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: rgba(99,102,241,0.4);
    }
    
    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ÙƒØ§Ø±Ø¯Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
    .stat:nth-child(1):hover {
      background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(99,102,241,0.08));
      border-color: rgba(99,102,241,0.5);
    }
    
    .stat:nth-child(2):hover {
      background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.08));
      border-color: rgba(16,185,129,0.5);
    }
    
    .stat:nth-child(3):hover {
      background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.08));
      border-color: rgba(245,158,11,0.5);
    }
    
    .stat:nth-child(4):hover {
      background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.08));
      border-color: rgba(239,68,68,0.5);
    }
    .stat h3{margin:0; font-size:20px; font-weight:700;}
    .stat p{margin:4px 0 0; color:var(--muted); font-size:12px; font-weight:500;}
    
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙƒØ§Ø±Ø¯Ø§Øª */
    .stat:nth-child(1) h3 {
      color: #6366f1;
    }
    .stat:nth-child(1) p {
      color: #8b5cf6;
    }
    
    .stat:nth-child(2) h3 {
      color: #10b981;
    }
    .stat:nth-child(2) p {
      color: #34d399;
    }
    
    .stat:nth-child(3) h3 {
      color: #f59e0b;
    }
    .stat:nth-child(3) p {
      color: #fbbf24;
    }
    
    .stat:nth-child(4) h3 {
      color: #ef4444;
    }
    .stat:nth-child(4) p {
      color: #f87171;
    }
    .row{display:flex; gap:12px;}
    .col{flex:1;}
    table{
      width:100%; 
      border-collapse:collapse; 
      font-size:11px; 
      table-layout:fixed;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      background: var(--card);
      font-weight: 400;
      letter-spacing: -0.01em;
      border: 1px solid rgba(99,102,241,0.15);
      backdrop-filter: blur(20px);
    }
    th, td{
      padding:6px 4px; 
      border-bottom:1px solid rgba(255,255,255,0.08); 
      text-align:center; 
      white-space:nowrap; 
      overflow:hidden; 
      text-overflow:ellipsis;
      transition: var(--transition);
      line-height: 1.3;
    }
    th{
      font-size:10px; 
      color:var(--muted); 
      font-weight:600; 
      border-bottom:1px solid rgba(99,102,241,0.2);
      background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.03));
      backdrop-filter: blur(20px);
      letter-spacing: -0.01em;
      white-space: nowrap;
      padding: 8px 4px;
      text-transform: uppercase;
      overflow: visible;
      text-overflow: unset;
    }
    td small{display:block; color:var(--muted); font-size:9px; font-weight: 400; letter-spacing: -0.01em; line-height: 1.2;}
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙÙˆÙ */
    tbody tr:nth-child(even){background:rgba(99,102,241,0.02);}
    tbody tr:hover{
      background:rgba(99,102,241,0.08);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ ØµÙÙˆÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ */
    tr.subtotal-title td{background:rgba(255,255,255,0.08); border-bottom:1px solid rgba(255,255,255,0.12);}
    tr.subtotal-values td{background:rgba(255,255,255,0.04); border-bottom:1px solid rgba(255,255,255,0.08);}
    .badge{
      padding:6px 12px; 
      border-radius:8px; 
      font-weight:600; 
      font-size:10px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge::before{
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.3s;
    }
    .badge:hover::before{
      left: 100%;
    }
    .badge.good{
      background:rgba(22,163,74,0.15); 
      color:var(--success); 
      border:1px solid rgba(22,163,74,0.25);
      box-shadow: 0 2px 8px rgba(22,163,74,0.1);
    }
    .badge.fail{
      background:rgba(239,68,68,0.12); 
      color:var(--danger); 
      border:1px solid rgba(239,68,68,0.2);
      box-shadow: 0 2px 8px rgba(239,68,68,0.1);
    }
    .badge.ok{
      background:rgba(148,163,184,0.08); 
      color:var(--muted); 
      border:1px solid rgba(148,163,184,0.12);
      box-shadow: 0 2px 8px rgba(148,163,184,0.05);
    }
    .search{
      padding:12px 16px; 
      border-radius:12px; 
      border:1px solid rgba(255,255,255,0.15); 
      background:var(--glass); 
      color:inherit;
      transition: var(--transition);
      backdrop-filter: blur(20px);
      min-width: 120px;
      font-size: 14px;
    }
    .search:focus{
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(14,165,169,0.1);
      background: rgba(255,255,255,0.05);
    }
    .filters{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .modal{
      position:fixed; 
      inset:0; 
      display:none; 
      align-items:center; 
      justify-content:center; 
      background:rgba(2,6,23,0.9); 
      z-index:40;
      backdrop-filter: blur(20px);
    }
    .modal.open{display:flex;}
    .modal .box{
      width:600px; 
      max-width:95%; 
      background:var(--card); 
      padding:32px; 
      border-radius:var(--border-radius);
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      animation: modalSlideIn 0.3s ease-out;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    label{display:block; font-size:14px; margin-bottom:8px; color:var(--muted); font-weight:600;}
    input[type="text"], input[type="number"], input[type="date"], select{
      width:100%; 
      padding:12px 16px; 
      border-radius:12px; 
      border:1px solid rgba(255,255,255,0.15); 
      background:var(--glass); 
      color:inherit;
      transition: var(--transition);
      backdrop-filter: blur(20px);
      font-size:14px;
    }
    input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus{
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(14,165,169,0.1);
      background: rgba(255,255,255,0.05);
    }
    .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:16px;}
    .small{font-size:12px; color:var(--muted);}
    .chart-row{display:flex; gap:16px; margin-top:16px; flex-wrap:wrap;}
    
    /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
    #connectionStatus{
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    #connectionStatus.connected{
      background: rgba(16,185,129,0.2);
      border-color: rgba(16,185,129,0.4);
      color: var(--success);
    }
    #connectionStatus.error{
      background: rgba(244,63,94,0.2);
      border-color: rgba(244,63,94,0.4);
      color: var(--danger);
    }
    #connectionStatus.connecting{
      background: rgba(245,158,11,0.2);
      border-color: rgba(245,158,11,0.4);
      color: var(--warning);
    }
    .chart-card{
      flex:1 1 360px; 
      min-height:260px; 
      padding:16px; 
      background:var(--glass); 
      border-radius:var(--border-radius);
      border: 1px solid rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }
    .chart-card:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    footer{color:var(--muted); margin-top:14px; font-size:13px;}
    .icon{font-size:16px; margin-right:4px;}
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© */
    td:nth-child(1){text-align:right; padding-right:8px; min-width:180px; max-width:220px;}
    td:nth-child(2), td:nth-child(3){min-width:100px; max-width:120px;}
    td:nth-child(4){min-width:100px; max-width:140px;}
    td:nth-child(5){min-width:100px; max-width:120px;}
    td:nth-child(6){min-width:120px; max-width:140px;}
    td:nth-child(7){min-width:100px; max-width:120px;}
    td:nth-child(8){min-width:100px; max-width:120px;}
    td:nth-child(9){min-width:110px; max-width:130px;}
    td:nth-child(10){min-width:120px; max-width:140px;}
    td:nth-child(11){min-width:100px; max-width:120px;}
    td:nth-child(12){min-width:120px; max-width:140px;}
    td:nth-child(13){min-width:60px; max-width:80px;}
    td:nth-child(14){min-width:100px; max-width:120px;}
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„) */
    td:nth-child(1){white-space:normal; word-wrap:break-word;}
    td:nth-child(1) strong{font-size:11px; line-height:1.2; word-break:break-word;}
    td:nth-child(1) small{font-size:8px; margin-top:2px; word-break:break-word;}
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø¹Ù…ÙˆØ¯ FDT */
    td:nth-child(4){white-space:normal; word-wrap:break-word; text-align:center;}
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
    .btn{font-size:12px; padding:8px 12px;}
    
    @media (max-width:1200px){
      table{font-size:11px;}
      th, td{padding:4px 2px;}
      td:nth-child(1){min-width:150px; max-width:180px;}
      td:nth-child(2), td:nth-child(3){min-width:90px; max-width:110px;}
      td:nth-child(4){min-width:90px; max-width:120px;}
      td:nth-child(5){min-width:90px; max-width:110px;}
      td:nth-child(6){min-width:110px; max-width:130px;}
      td:nth-child(7){min-width:90px; max-width:110px;}
      td:nth-child(8){min-width:90px; max-width:110px;}
      td:nth-child(9){min-width:100px; max-width:120px;}
      td:nth-child(10){min-width:110px; max-width:130px;}
      td:nth-child(11){min-width:90px; max-width:110px;}
      td:nth-child(12){min-width:110px; max-width:130px;}
      td:nth-child(13){min-width:50px; max-width:70px;}
      td:nth-child(14){min-width:90px; max-width:110px;}
      .btn{font-size:11px; padding:6px 10px;}
      .badge{font-size:9px; padding:2px 4px;}
    }
    
    @media (max-width:800px){ 
      .row{flex-direction:column;} 
      .stats{flex-direction:column;} 
      th, td{font-size:10px; padding:4px 2px;} 
      table{font-size:10px;}
      td:nth-child(1){min-width:120px; max-width:150px;}
      td:nth-child(2), td:nth-child(3){min-width:80px; max-width:100px;}
      td:nth-child(4){min-width:80px; max-width:100px;}
      td:nth-child(5){min-width:80px; max-width:100px;}
      td:nth-child(6){min-width:100px; max-width:120px;}
      td:nth-child(7){min-width:80px; max-width:100px;}
      td:nth-child(8){min-width:80px; max-width:100px;}
      td:nth-child(9){min-width:90px; max-width:110px;}
      td:nth-child(10){min-width:100px; max-width:120px;}
      td:nth-child(11){min-width:80px; max-width:100px;}
      td:nth-child(12){min-width:100px; max-width:120px;}
      td:nth-child(13){min-width:45px; max-width:65px;}
      td:nth-child(14){min-width:80px; max-width:100px;}
      .btn{font-size:10px; padding:6px 8px;}
      .badge{font-size:8px; padding:2px 4px;}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</h1>
        <p class="lead">Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© Ù„Ø´Ø±ÙƒØ© Ø¹Ø±Ø§Ù‚ Ø³ÙŠÙ„</p>
        <div id="connectionStatus" style="font-size: 12px; margin-top: 4px; padding: 2px 6px; border-radius: 4px; display: inline-block;">
          <span id="statusIcon">ğŸ”„</span>
          <span id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
      </div>
      <div class="controls" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
        <button class="btn secondary" id="btnAddAgent">
          <span class="icon">â•</span>
          Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„
        </button>
        <button class="btn warn" id="btnWeeklyReport">
          <span class="icon">ğŸ“Š</span>
          ØªÙ‚Ø±ÙŠØ±
        </button>
        <button class="btn secondary" id="btnTheme">
          <span class="icon">ğŸŒ™</span>
          Ø§Ù„ÙˆØ¶Ø¹: Ù„ÙŠÙ„ÙŠ
        </button>
      </div>
    </header>

    <section class="card">
      <div class="row" style="align-items:center;">
        <div class="col">
          <div class="filters">
            <select id="phaseFilter" class="search">
              <option value="">ğŸ” ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
              <option value="OLD">ğŸ“œ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…</option>
              <option value="PHASE2">ğŸš€ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
              <option value="PHASE3">â­ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
            </select>
            <input id="searchBox" class="search" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙˆÙƒÙŠÙ„..." />
            <select id="sortBy" class="search">
              <option value="name">ğŸ“ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…</option>
              <option value="total_users_desc">ğŸ“Š Ø£Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ</option>
              <option value="active_desc">ğŸ”¥ Ø£Ø¹Ù„Ù‰ Ù†Ø´Ø·</option>
              <option value="deficit_desc">âš ï¸ Ø£Ø¹Ù„Ù‰ Ø¹Ø¬Ø²</option>
            </select>
          </div>
        </div>

        <div style="min-width:320px;">
          <div class="stats">
            <div class="stat card">
              <h3 id="totalAgents">0</h3>
              <p>ğŸ‘¥ Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</p>
            </div>
            <div class="stat card">
              <h3 id="totalUsers">0</h3>
              <p>ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
            </div>
            <div class="stat card">
              <h3 id="totalActive">0</h3>
              <p>ğŸ”¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</p>
            </div>
            <div class="stat card">
              <h3 id="overallActivation">0%</h3>
              <p>ğŸ“ˆ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø¹Ø§Ù…</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="overflow:auto;">
        <table id="agentsTable">
          <thead>
            <tr>
              <th>Ø§Ù„ÙˆÙƒÙŠÙ„</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</th>
              <th>FDT</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù„ÙˆØ­Ø©</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</th>
              <th>Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„</th>
              <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
              <th>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ÙˆØµÙˆÙ„</th>
              <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø¬Ø²</th>
              <th>Ø¹Ø¬Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="chart-row">
        <div class="chart-card">
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </section>

    <footer>
      <div class="small"</div>
    </footer>
  </div>

  <div id="modalEdit" class="modal">
    <div class="box">
      <h3 id="modalTitle">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</h3>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„</label>
        <input type="text" id="editName" readonly />
      </div>
      <div>
        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
        <input type="number" id="editTotal" readonly />
      </div>
      <div>
        <label>Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚</label>
        <input type="number" id="editPrevActive" readonly />
      </div>
      <div>
        <label>Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ø¯Ø®Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹)</label>
        <input type="number" id="editActive" />
      </div>
      <div class="actions">
        <button class="btn secondary" id="closeModal">
          <span class="icon">âŒ</span>
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn" id="saveActive">
          <span class="icon">ğŸ’¾</span>
          Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Edit Agent Info -->
  <div id="modalEditInfo" class="modal">
    <div class="box">
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:200px;">
          <label>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„</label>
          <input type="text" id="info_name" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>ITPC Site </label>
          <input type="text" id="info_note" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>Ø§Ø³Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
          <input type="text" id="info_board" />
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:160px;">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯</label>
          <input type="date" id="info_date" />
        </div>
        <div style="flex:1; min-width:160px;">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          <select id="info_phase">
            <option value="OLD">OLD</option>
            <option value="PHASE2">PHASE2</option>
            <option value="PHASE3">PHASE3</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:200px;">
          <label>ITPC Site</label>
          <input type="text" id="info_site" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>FDT</label>
          <input type="text" id="info_fdt" />
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:160px;">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
          <input type="number" id="info_total" />
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="closeInfoModal">
          <span class="icon">âŒ</span>
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn warn" id="deleteFromInfoModal">
          <span class="icon">ğŸ—‘ï¸</span>
          Ø­Ø°Ù
        </button>
        <button class="btn" id="saveInfo">
          <span class="icon">ğŸ’¾</span>
          Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>

  <div id="modalAdd" class="modal">
    <div class="box">
      <h3>Ø¥Ø¶Ø§ÙØ© ÙˆÙƒÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„</label>
        <input type="text" id="new_name" />
      </div>
      <div style="display:flex; gap:8px;">
        <div style="flex:1;">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯ </label>
          <input type="date" id="new_date" />
        </div>
        <div style="flex:1;">
          <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          <select id="new_phase">
            <option value="OLD">OLD</option>
            <option value="PHASE2">PHASE2</option>
            <option value="PHASE3">PHASE3</option>
          </select>
        </div>
      </div>
      <div>
        <label>ITPC Site</label>
        <input type="text" id="new_site" />
      </div>
      <div>
        <label>FDT</label>
        <input type="text" id="new_fdt" />
      </div>
      <div>
        <label>Ø§Ø³Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
        <input type="text" id="new_board" />
      </div>
      <div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ø³ÙÙ„ Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="text" id="new_note" placeholder="" />
      </div>
      <div style="display:flex; gap:8px;">
        <div style="flex:1;">
          <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
          <input type="number" id="new_total" />
        </div>
        <div style="flex:1;">
          <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</label>
          <input type="number" id="new_active" />
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="closeAddModal">
          <span class="icon">âŒ</span>
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn" id="saveNewAgent">
          <span class="icon">â•</span>
          Ø¥Ø¶Ø§ÙØ©
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase init
    const SUPABASE_URL = 'https://vpvvjascwgivdjyyhzwp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdnZqYXNjd2dpdmRqeXloendwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDYxMjYsImV4cCI6MjA2NTM4MjEyNn0.6AR2-MG4x9ugNTXe9jUqx-IwGEtj1m6MCYwQkTsSbUQ';
    
    // Ù†Ù…Ø· Singleton Ù„Ù€ Supabase Client
    const SupabaseManager = {
      _instance: null,
      _isInitialized: false,
      connectionStatus: 'disconnected',
      _creationAttempts: 0,
      _maxAttempts: 3,
      
      getInstance() {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
        if (this._instance) {
          return this._instance;
        }
        
        // Ø¥Ø°Ø§ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§ØªØŒ Ù„Ø§ ØªØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
        if (this._creationAttempts >= this._maxAttempts) {
          console.warn('Max creation attempts reached, not creating new instance');
          return null;
        }
        
        if (!this._isInitialized) {
          this._isInitialized = true;
          this._creationAttempts++;
          
          try {
            console.log(`Creating Supabase client (Singleton) - Attempt ${this._creationAttempts}...`);
            this._instance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
              auth: {
                persistSession: false,
                autoRefreshToken: false,
                detectSessionInUrl: false
              }
            });
            console.log('Supabase client created successfully');
          } catch (e) {
            console.error('Failed to create Supabase client:', e);
            this._isInitialized = false;
            return null;
          }
        }
        return this._instance;
      },
      
      reset() {
        console.log('Resetting Supabase client...');
        // Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ù€ instanceØŒ ÙÙ‚Ø· Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
        this.connectionStatus = 'disconnected';
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        this._creationAttempts = 0;
        this._isInitialized = false;
      },
      
      isConnected() {
        return this._instance !== null && this.connectionStatus === 'connected';
      },
      
      hasInstance() {
        return this._instance !== null;
      }
    };
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Supabase Client
    function getSupabaseClient() {
      return SupabaseManager.getInstance();
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Supabase Client
    function reinitializeSupabase() {
      try {
        console.log('Reinitializing Supabase client...');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ instance Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
        if (SupabaseManager.hasInstance()) {
          console.log('Using existing Supabase instance');
          SupabaseManager.connectionStatus = 'disconnected';
          return true;
        }
        
        // ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ instanceØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
        SupabaseManager.reset();
        const client = getSupabaseClient();
        if (client) {
          console.log('Supabase client reinitialized successfully');
          return true;
        } else {
          console.error('Failed to reinitialize Supabase client');
          return false;
        }
      } catch (e) {
        console.error('Failed to reinitialize Supabase client:', e);
        return false;
      }
    }
   
    const STORAGE_KEY = 'agents_dashboard_data_v1';

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connectionStatus');
      const iconEl = document.getElementById('statusIcon');
      const textEl = document.getElementById('statusText');
      
      if (!statusEl || !iconEl || !textEl) return;
      
    
      statusEl.className = '';
      
      switch(status) {
        case 'connected':
          statusEl.classList.add('connected');
          iconEl.textContent = '';
          textEl.textContent = 'Ameer Helwas';
          break;
        case 'error':
          statusEl.classList.add('error');
          iconEl.textContent = 'âŒ';
          textEl.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„';
          break;
        case 'connecting':
          statusEl.classList.add('connecting');
          iconEl.textContent = 'ğŸ”„';
          textEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
          break;
        default:
          statusEl.classList.add('connecting');
          iconEl.textContent = 'ğŸ”„';
          textEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
      }
    }


    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
    function validateAgentData(agent) {
      const errors = [];
      
      if (!agent.name || agent.name.trim() === '') {
        errors.push('Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨');
      }
      
      if (!agent.contract_date) {
        errors.push('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ø·Ù„ÙˆØ¨');
      }
      
      if (!agent.phase || !['PHASE1', 'PHASE2', 'PHASE3', 'OLD'].includes(agent.phase)) {
        errors.push('Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† PHASE1, PHASE2, PHASE3, Ø£Ùˆ OLD');
      }
      
      if (typeof agent.total_users !== 'number' || agent.total_users < 0) {
        errors.push('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨');
      }
      
      if (typeof agent.active !== 'number' || agent.active < 0) {
        errors.push('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨');
      }
      
      if (typeof agent.prev_active !== 'number' || agent.prev_active < 0) {
        errors.push('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙˆÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨');
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    }

    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        console.log('Testing Supabase connection...');
        updateConnectionStatus('connecting');
        console.log('Supabase URL:', SUPABASE_URL);
        console.log('Supabase Key (first 20 chars):', SUPABASE_ANON_KEY.substring(0, 20) + '...');
        console.log('Testing with columns: id, name, active, total_users');
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Supabase client Ù…Ù† Ø§Ù„Ù€ Singleton
        const supabase = getSupabaseClient();
        if (!supabase) {
          console.error('Failed to get Supabase client');
          updateConnectionStatus('error');
          return false;
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        const { data, error } = await supabase
          .from('agents')
          .select('id, name, active, total_users, board_name') // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© + board_name
          .limit(1);
          
        if (error) {
          console.error('Supabase connection test failed:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          console.error('Error details:', error.details);
          console.error('Error hint:', error.hint);
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ board_nameØŒ Ø¬Ø±Ø¨ Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯
          if (error.message && error.message.includes('board_name')) {
            console.warn('board_name column not found, trying without it...');
            const { data: retryData, error: retryError } = await supabase
              .from('agents')
              .select('id, name, active, total_users')
              .limit(1);
              
            if (retryError) {
              console.error('Retry also failed:', retryError);
              SupabaseManager.connectionStatus = 'error';
              updateConnectionStatus('error');
              return false;
            } else {
              console.log('Connection successful without board_name column');
              SupabaseManager.connectionStatus = 'connected';
              updateConnectionStatus('connected');
              return true;
            }
          }
          
          console.error('Note: Make sure the database has the required columns: name, note, contract_date, phase, fdt, total_users, active, prev_active');
          SupabaseManager.connectionStatus = 'error';
          updateConnectionStatus('error');
          return false;
        } else {
          console.log('Supabase connection test successful');
          console.log('Data received:', data);
          if (data && data.length > 0) {
            console.log('Board name in database:', data[0].board_name);
            console.log('Available columns:', Object.keys(data[0]));
          }
          SupabaseManager.connectionStatus = 'connected';
          updateConnectionStatus('connected');
          return true;
        }
      } catch (e) {
        console.error('Supabase connection test error:', e);
        console.error('Error type:', e.name);
        console.error('Error message:', e.message);
        console.error('Error stack:', e.stack);
        SupabaseManager.connectionStatus = 'error';
        updateConnectionStatus('error');
        return false;
      }
    }

    const tbody = document.querySelector('#agentsTable tbody');
    const totalAgentsEl = document.getElementById('totalAgents');
    const totalUsersEl = document.getElementById('totalUsers');
    const totalActiveEl = document.getElementById('totalActive');
    const overallActEl = document.getElementById('overallActivation');
    const phaseFilter = document.getElementById('phaseFilter');
    const searchBox = document.getElementById('searchBox');
    const sortBy = document.getElementById('sortBy');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnAddAgent = document.getElementById('btnAddAgent');
    const btnTheme = document.getElementById('btnTheme');

    const modalEdit = document.getElementById('modalEdit');
    const editName = document.getElementById('editName');
    const editTotal = document.getElementById('editTotal');
    const editPrevActive = document.getElementById('editPrevActive');
    const editActive = document.getElementById('editActive');
    const saveActiveBtn = document.getElementById('saveActive');
    const closeModalBtn = document.getElementById('closeModal');

    const modalAdd = document.getElementById('modalAdd');
    const closeAddModal = document.getElementById('closeAddModal');
    const saveNewAgent = document.getElementById('saveNewAgent');
    const modalEditInfo = document.getElementById('modalEditInfo');
    const closeInfoModal = document.getElementById('closeInfoModal');
    const saveInfo = document.getElementById('saveInfo');

    let barChart=null, pieChart=null;

    let agents = [];
    let dbIdByLocalId = new Map();
    let localIdByDbId = new Map();

    function migrateData(){
      let changed = false;
      agents.forEach(a=>{
        const norm = normalizePhase(a.phase);
        if(a.phase !== norm){ a.phase = norm; changed = true; }
        if((a.name||'').trim() === 'abbas Ø¹Ø¨Ø§Ø³ Ø­Ù„ÙˆØ§Øµ' && a.phase !== 'PHASE1'){
          a.phase = 'PHASE1';
          changed = true;
        }
      });
      if(changed){ saveToStorage(); }
    }

    // ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·

    function parseDateAuto(s){
      if(!s) return null;
      if(s instanceof Date) return s;
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00');
      if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
        const parts = s.split('/');
        return new Date(+parts[2], +parts[1]-1, +parts[0]);
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }

    function monthsBetween(d1, d2){
      const y1=d1.getFullYear(), m1=d1.getMonth();
      const y2=d2.getFullYear(), m2=d2.getMonth();
      return Math.max(0, (y2 - y1)*12 + (m2 - m1));
    }

    function normalizePhase(value){
      const s = String(value||'').trim().toLowerCase();
      if(!s) return '';
      if(s.includes('phase2') || s.includes('phase 2') || s.includes('phase-2') || s.includes('Ø§Ù„Ù…Ø±Ø­Ù„Ø©') && s.includes('2')) return 'PHASE2';
      if(s.includes('phase3') || s.includes('phase 3') || s.includes('phase-3') || (s.includes('Ø§Ù„Ù…Ø±Ø­Ù„Ø©') && s.includes('3'))) return 'PHASE3';
      if(s.includes('old') || s.includes('Ù‚Ø¯ÙŠÙ…') || s.includes('Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…')) return 'OLD';
      if(s.includes('phase1') || s.includes('phase 1') || s.includes('phase-1') || s.includes('Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯')) return 'PHASE1';
      const up = s.toUpperCase();
      if(['PHASE1','PHASE2','PHASE3','OLD'].includes(up)) return up;
      return '';
    }

    function arabicPhaseLabel(phase){
      switch(String(phase||'').toUpperCase()){
        case 'PHASE1': return ' Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ';
        case 'PHASE2': return ' Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ';
        case 'PHASE3': return 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©';
        case 'OLD': return 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…';
        default: return '';
      }
    }

    function toYMDLocal(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function genId(){
      return 'a_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4);
    }

    function computeAgent(agent){
      if(!agent._id) agent._id = genId();
      const now = new Date();
      const contract = parseDateAuto(agent.contract_date) || now;
      const months = monthsBetween(contract, now);
      agent.contract_date = toYMDLocal(contract); 
      agent.months_since = months;
      agent.phase = normalizePhase(agent.phase);
      let required = months >= 8 ? 80 : 60;
      agent.required_rate = required;

      agent.total_users = Number(agent.total_users) || 0;
      agent.active = Number(agent.active) || 0;
      agent.prev_active = Number(agent.prev_active || 0);

      if(Array.isArray(agent.history) && agent.history.length>0){
        const last = agent.history[agent.history.length-1];
        agent.growth = Math.round(agent.active - Number(last.active||0));
      } else {
        agent.growth = Math.round(agent.active - agent.prev_active);
      }
      agent.activation_rate = agent.total_users ? +( (agent.active / agent.total_users) * 100 ) : 0;
      agent.activation_rate = Math.round(agent.activation_rate*10)/10; // one decimal
      if(required !== null){
        const rawDeficit = required - agent.activation_rate;
        agent.deficit_percent = Math.max(0, Math.round(rawDeficit*10)/10);
        const neededUsers = Math.round((required/100) * agent.total_users);
        agent.required_users = neededUsers;
        agent.deficit_users = Math.max(0, neededUsers - agent.active);
      } else {
        agent.deficit_percent = 0;
        agent.required_users = 0;
        agent.deficit_users = 0;
      }

      if(months < 6) agent.status='Ø¬Ø¯ÙŠØ¯';
      else if(agent.activation_rate >= required + 5) agent.status='Ù…ØªÙÙˆÙ‚';
      else if(agent.activation_rate >= required) agent.status='Ù…Ø·Ø§Ø¨Ù‚';
      else agent.status='Ø¹Ø¬Ø²';

      return agent;
    }

    function renderTable(){
      let filtered = agents.slice();

      const phase = phaseFilter.value;
      if(phase) filtered = filtered.filter(a => (a.phase || '').toUpperCase() === phase.toUpperCase());

      const q = (searchBox.value || '').trim().toLowerCase();
      if(q){
        filtered = filtered.filter(a => ((a.name||'') + ' ' + (a.itpc_site||'') + ' ' + arabicPhaseLabel(a.phase)).toLowerCase().includes(q));
      }

      // sorting
      const sort = sortBy.value;
      if(sort === 'total_users_desc') filtered.sort((a,b)=>b.total_users - a.total_users);
      else if(sort === 'active_desc') filtered.sort((a,b)=> b.active - a.active );
      else if(sort === 'deficit_desc') filtered.sort((a,b)=>b.deficit_users - a.deficit_users);
      else filtered.sort((a,b)=> (a.name||'').localeCompare(b.name || '', 'ar') );

      tbody.innerHTML = '';
      const PHASE_ORDER = ['OLD','PHASE2','PHASE3'];
      const phaseToItems = {};
      filtered.forEach((a)=>{
        const key = (a.phase||'').toUpperCase();
        if(!phaseToItems[key]) phaseToItems[key] = [];
        phaseToItems[key].push(a);
      });
      const allPhases = PHASE_ORDER.filter(p=>phaseToItems[p] && phaseToItems[p].length>0);
      let runningIndex = 0;
      allPhases.forEach(phaseKey=>{
        const items = phaseToItems[phaseKey];
        const hdr = document.createElement('tr');
        hdr.className = 'phase-header';
        hdr.innerHTML = `<td colspan="14" style="text-align:right; font-weight:700; background:rgba(255,255,255,0.08); font-size:11px; padding:8px; border-bottom:1px solid rgba(255,255,255,0.12);">${arabicPhaseLabel(phaseKey)}</td>`;
        tbody.appendChild(hdr);

        items.forEach((a)=>{
          const idx = runningIndex++;
        const tr = document.createElement('tr');
        const todayStr = toYMDLocal(new Date());
        tr.innerHTML = `
          <td style="text-align:right; padding-right:8px; white-space:normal; word-wrap:break-word;">
            <div style="line-height:1.1;">
              <strong style="font-size:11px; display:block; word-break:break-word;">${escapeHtml(a.name||'---')}</strong>
              <small style="font-size:8px; color:var(--muted); word-break:break-word;">${escapeHtml(a.note||'')}</small>
            </div>
          </td>
          <td>${a.contract_date}</td>
            <td>${todayStr}</td>
            <td>${escapeHtml(a.fdt||'')}</td>
          <td>${escapeHtml(a.board_name||'')}</td>
          <td>${num(a.total_users)}</td>
          <td>${num(a.active)}</td>
            
          <td>${a.activation_rate}%</td>
          <td>${a.required_rate === null ? '-' : a.required_rate + '%'}</td>
            <td>${a.required_rate === null ? '-' : num(a.required_users)}</td>
          <td>${a.required_rate === null ? '-' : a.deficit_percent + '%'}</td>
          <td>${a.deficit_users ? num(a.deficit_users) : '-'}</td>
          <td>${statusBadge(a.status)}</td>
          <td>
              <div class="flex" style="justify-content:center; gap:4px; flex-wrap:wrap;">
                <button class="btn secondary" data-action="edit" data-id="${a._id}" style="font-size:8px; padding:2px 4px;">
                  <span class="icon">ğŸ”„</span>
                  ØªØ­Ø¯ÙŠØ«
                </button>
                <button class="btn" data-action="edit-info" data-id="${a._id}" style="font-size:8px; padding:2px 4px;">
                  <span class="icon">âœï¸</span>
                  ØªØ¹Ø¯ÙŠÙ„
                </button>
              </div>
          </td>
        `;
        tbody.appendChild(tr);
        });

        const totals = items.reduce((acc, a)=>{
          acc.total += Number(a.total_users||0);
          acc.active += Number(a.active||0);
          acc.deficit_users += Number(a.deficit_users||0);
          return acc;
        }, {total:0, active:0, deficit_users:0});
        const sub = document.createElement('tr');
        sub.className = 'subtotal-title';
        sub.innerHTML = `
          <td colspan="4" style="text-align:right; font-weight:600; font-size:9px; padding:4px;">Ù…Ø¬Ù…ÙˆØ¹ ${escapeHtml(arabicPhaseLabel(phaseKey))}</td>
          <td></td>
          <td style="font-weight:600; font-size:9px; padding:4px;">${num(totals.total)}</td>
          <td style="font-weight:600; font-size:9px; padding:4px;">${num(totals.active)}</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td style="font-weight:600; font-size:9px; padding:4px;">${totals.deficit_users ? num(totals.deficit_users) : '-'}</td>
          <td></td>
          <td></td>
        `;
        tbody.appendChild(sub);
      });

      updateStats(filtered);
      updateCharts(filtered);
    }

    function updateStats(list){
      const totalAgents = list.length;
      const totalUsers = list.reduce((s,a)=>s + Number(a.total_users||0), 0);
      const totalActive = list.reduce((s,a)=>s + Number(a.active||0), 0);
      const overallActivation = totalUsers ? Math.round((totalActive / totalUsers) * 1000)/10 : 0;
      totalAgentsEl.textContent = num(totalAgents);
      totalUsersEl.textContent = num(totalUsers);
      totalActiveEl.textContent = num(totalActive);
      overallActEl.textContent = overallActivation + '%';
    }

    function updateCharts(filtered){
      const top = filtered.slice().sort((a,b)=>b.total_users - a.total_users).slice(0,10);
      const labels = top.map(a=>a.name || a.itpc_site || 'â€”');
      const totalData = top.map(a=>a.total_users);
      const activeData = top.map(a=>a.active);

      const barCtx = document.getElementById('barChart').getContext('2d');
      if(barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', data: totalData },
            { label:'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†', data: activeData }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{display:true, position:'top'}},
          scales:{x:{ticks:{color:'#e6eef8'}}, y:{beginAtZero:true, ticks:{color:'#e6eef8'}}}
        }
      });

      const sumActive = filtered.reduce((s,a)=>s + a.active,0);
      const sumTotal = filtered.reduce((s,a)=>s + a.total_users,0);
      const inactive = Math.max(0, sumTotal - sumActive);
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if(pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type:'doughnut',
        data:{
          labels:['Ù†Ø´Ø·ÙˆÙ†','ØºÙŠØ± Ù†Ø´Ø·ÙŠÙ†'],
          datasets:[{ data:[sumActive, inactive] }]
        },
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}
      });
    }

    function num(n){ return new Intl.NumberFormat('en-US').format(Number(n||0)); }
    function signedNum(n){ if(n>0) return '+'+num(n); if(n<0) return num(n); return num(0); }
    function statusBadge(status){
      if(status==='Ù…ØªÙÙˆÙ‚') return `<span class="badge good">${status}</span>`;
      if(status==='Ù…Ø·Ø§Ø¨Ù‚') return `<span class="badge ok">${status}</span>`;
      if(status==='Ø¹Ø¬Ø²') return `<span class="badge fail">${status}</span>`;
      return `<span class="badge" style="background:rgba(245,158,11,0.08); color:var(--warning);">${status}</span>`;
    }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    tbody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit"]');
      if(!btn) return;
      const id = btn.dataset.id;
      if(!id) return;
      const idx = agents.findIndex(a=>a._id === id);
      openEditModal(idx);
    });

    tbody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit-info"]');
      if(!btn) return;
      const id = btn.dataset.id;
      const idx = agents.findIndex(a=>a._id === id);
      if(idx < 0) return;
      const a = agents[idx];
      modalEditInfo.classList.add('open');
      document.getElementById('info_name').value = a.name || '';
      document.getElementById('info_note').value = a.note || '';
      document.getElementById('info_date').value = a.contract_date || '';
      document.getElementById('info_phase').value = a.phase || '';
      document.getElementById('info_site').value = a.itpc_site || '';
      document.getElementById('info_fdt').value = a.fdt || '';
      document.getElementById('info_total').value = a.total_users || 0;
      const infoBoardEl = document.getElementById('info_board'); if(infoBoardEl) infoBoardEl.value = a.board_name || '';
      modalEditInfo.dataset.editIndex = String(idx);
    });

    closeInfoModal.addEventListener('click', ()=> modalEditInfo.classList.remove('open'));
    saveInfo.addEventListener('click', async ()=>{
      const idx = Number(modalEditInfo.dataset.editIndex || -1);
      if(idx < 0) return;
      const a = agents[idx];
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
      a.name = document.getElementById('info_name').value.trim() || a.name;
      a.note = document.getElementById('info_note').value.trim();
      a.contract_date = document.getElementById('info_date').value || a.contract_date;
      a.phase = normalizePhase(document.getElementById('info_phase').value);
      a.itpc_site = document.getElementById('info_site').value.trim();
      a.fdt = document.getElementById('info_fdt').value.trim();
      a.total_users = Number(document.getElementById('info_total').value || a.total_users);
      a.board_name = (document.getElementById('info_board')?.value || '').trim();
      computeAgent(a);
      
      try{
        const dbId = dbIdByLocalId.get(a._id);
        console.log('Updating agent:', a.name, 'Local ID:', a._id, 'DB ID:', dbId);
        
        if(dbId){
          console.log('Updating agent info in Supabase:', a.name);
          const supabase = getSupabaseClient();
          if (!supabase) {
            console.error('Supabase client not available');
            return;
          }
          
          const updateData = {
            name: a.name,
            note: a.note,
            contract_date: a.contract_date,
            phase: a.phase,
            fdt: a.fdt,
            board_name: a.board_name,
            total_users: a.total_users,
            active: a.active,
            prev_active: a.prev_active
          };
          
          console.log('Updating with data:', updateData);
          console.log('Board name value:', a.board_name);
          console.log('Board name type:', typeof a.board_name);
          
          const { error } = await supabase
            .from('agents')
            .update(updateData)
            .eq('id', dbId);
            
          if(error) {
            console.error('Supabase update info error:', error);
            console.error('Error details:', error.message, error.details, error.hint);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ board_nameØŒ Ø¬Ø±Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯
            if (error.message && error.message.includes('board_name')) {
              console.warn('board_name column not found, updating without it...');
              const updateDataWithoutBoard = {
                name: a.name,
                note: a.note,
                contract_date: a.contract_date,
                phase: a.phase,
                fdt: a.fdt,
                total_users: a.total_users,
                active: a.active,
                prev_active: a.prev_active
              };
              
              const { error: retryError } = await supabase
                .from('agents')
                .update(updateDataWithoutBoard)
                .eq('id', dbId);
                
              if (retryError) {
                console.error('Retry update also failed:', retryError);
              } else {
                console.log('Agent info updated successfully without board_name');
              }
            }
          } else {
            console.log('Agent info updated successfully in Supabase');
          }
        } else {
          console.log('No database ID found for agent, saving locally only');
          console.log('Available dbIdByLocalId:', Array.from(dbIdByLocalId.entries()));
        }
      }catch(e){ 
        console.error('Error updating agent info:', e); 
      }
      
      // Ø§Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
      saveToStorage();
      renderTable();
      modalEditInfo.classList.remove('open');
      console.log('Agent info updated successfully');
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
      alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ "${a.name}" Ø¨Ù†Ø¬Ø§Ø­!`);
    });

    // Delete handler for info modal
    document.getElementById('deleteFromInfoModal').addEventListener('click', async ()=>{
      const idx = Number(modalEditInfo.dataset.editIndex || -1);
      if(idx < 0) return;
      const a = agents[idx];
      if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙˆÙƒÙŠÙ„: ${a.name || ''} ØŸ`)) return;
      try{
        const dbId = dbIdByLocalId.get(a._id);
        if(dbId){
          const supabase = getSupabaseClient();
          if (supabase) {
          const { error } = await supabase.from('agents').delete().eq('id', dbId);
          if(error) console.error('Delete error:', error);
          }
          localIdByDbId.delete(dbId);
          dbIdByLocalId.delete(a._id);
        }
      }catch(e){ console.error(e); }
      agents.splice(idx,1);
      saveToStorage();
      renderTable();
      modalEditInfo.classList.remove('open');
    });


    function openEditModal(idx){
      const agent = agents[idx];
      if(!agent) return;
      modalEdit.classList.add('open');
      editName.value = agent.name || '';
      editTotal.value = agent.total_users || 0;
      editPrevActive.value = '';
      editActive.value = agent.active || 0;
      modalEdit.dataset.editIndex = idx;
    }

    closeModalBtn.addEventListener('click', ()=> modalEdit.classList.remove('open'));
    saveActiveBtn.addEventListener('click', async ()=>{
      const idx = Number(modalEdit.dataset.editIndex || -1);
      if(idx < 0) return;
      const agent = agents[idx];
      if(!agent) return;
      const newActive = Number(editActive.value || 0);
      
      if(!Array.isArray(agent.history)) agent.history = [];
      agent.history.push({ date: toYMDLocal(new Date()), active: Number(agent.active||0) });
      agent.active = newActive;
      computeAgent(agent);
      
      try{
        const dbId = dbIdByLocalId.get(agent._id);
        if(dbId){
          console.log('Updating active users for agent:', agent.name, 'to:', newActive);
          const supabase = getSupabaseClient();
          if (supabase) {
          const { error } = await supabase
            .from('agents')
              .update({ 
                active: agent.active, // Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                prev_active: agent.prev_active,
                board_name: agent.board_name
              })
            .eq('id', dbId);
          if(error) {
            console.error('Supabase update active error:', error);
          } else {
            console.log('Active users updated successfully in Supabase');
            }
          } else {
            console.log('Supabase client not available, saving locally only');
          }
        } else {
          console.log('No database ID found for agent, saving locally only');
        }
      }catch(e){ 
        console.error('Error updating active users:', e); 
      }
      
      // Ø§Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
      saveToStorage();
      renderTable();
      modalEdit.classList.remove('open');
      console.log('Active users updated successfully');
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
      alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ù„Ù„ÙˆÙƒÙŠÙ„ "${agent.name}" Ø¨Ù†Ø¬Ø§Ø­!`);
    });

    btnAddAgent.addEventListener('click', ()=> modalAdd.classList.add('open'));
    
    closeAddModal.addEventListener('click', ()=> modalAdd.classList.remove('open'));
    saveNewAgent.addEventListener('click', async ()=>{
      const name = document.getElementById('new_name').value.trim();
      const date = document.getElementById('new_date').value;
      const phase = normalizePhase(document.getElementById('new_phase').value);
      const site = document.getElementById('new_site').value.trim();
      const fdt = document.getElementById('new_fdt').value.trim();
      const note = document.getElementById('new_note').value.trim();
      const board = (document.getElementById('new_board')?.value || '').trim();
      const total = Number(document.getElementById('new_total').value || 0);
      const active = Number(document.getElementById('new_active').value || 0);
      
      if(!name){
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆÙƒÙŠÙ„');
        return;
      }
      
      const obj = { 
        name, 
        contract_date: date || toYMDLocal(new Date()), 
        phase, 
        itpc_site: site, 
        fdt, 
        note, 
        board_name: board, // Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
        total_users: total, 
        active, 
        prev_active: 0 
      };
      
      console.log('Created obj with keys:', Object.keys(obj));
      console.log('obj.board_name:', obj.board_name);
      
      computeAgent(obj);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const validation = validateAgentData(obj);
      if (!validation.isValid) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n' + validation.errors.join('\n'));
        return;
      }
      
      try{
        console.log('Attempting to insert new agent:', obj);
        console.log('Supabase URL:', SUPABASE_URL);
        
        const supabase = getSupabaseClient();
        if (!supabase) {
          console.error('Supabase client not available, saving locally only');
          obj._id = genId();
          agents.push(obj);
          saveToStorage();
          renderTable();
          modalAdd.classList.remove('open');
          alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ "${name}" Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø· (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)`);
          return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ insertData Ù…Ø¹ board_name - Ù†Ø³Ø® ØµØ±ÙŠØ­ Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const insertData = {
          name: String(obj.name || ''),
          note: String(obj.note || ''),
          contract_date: String(obj.contract_date || ''),
          phase: String(obj.phase || ''),
          fdt: String(obj.fdt || ''),
          board_name: String(obj.board_name || ''),
          total_users: Number(obj.total_users || 0),
          active: Number(obj.active || 0),
          prev_active: Number(obj.prev_active || 0)
        };
        
        console.log('Insert data (before send):', JSON.stringify(insertData, null, 2));
        console.log('Original obj keys:', Object.keys(obj));
        console.log('Insert data keys:', Object.keys(insertData));
        console.log('Board name in obj:', obj.board_name);
        console.log('Board name in insertData:', insertData.board_name);
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ board_name ÙÙŠ insertData
        if (insertData.hasOwnProperty('board_name')) {
          console.log('SUCCESS: board_name found in insertData!');
        } else {
          console.error('ERROR: board_name NOT found in insertData!');
        }
        
        console.log('Final insert data:', insertData);
        
        const { data, error } = await supabase
          .from('agents')
          .insert(insertData)
          .select('*')
          .single();
          
        if(error){
          console.error('Supabase insert error:', error);
          console.error('Error details:', error.message, error.details, error.hint);
          console.error('Error code:', error.code);
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø·Ø£ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù€ board_nameØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯
          if (error.message && error.message.includes('board_name')) {
            console.warn('board_name column not found, inserting without it...');
            const insertDataWithoutBoard = {
              name: String(obj.name || ''),
              note: String(obj.note || ''),
              contract_date: String(obj.contract_date || ''),
              phase: String(obj.phase || ''),
              fdt: String(obj.fdt || ''),
              total_users: Number(obj.total_users || 0),
              active: Number(obj.active || 0),
              prev_active: Number(obj.prev_active || 0)
            };
            
            const { data: retryData, error: retryError } = await supabase
              .from('agents')
              .insert(insertDataWithoutBoard)
              .select('*')
              .single();
              
            if (retryError) {
              console.error('Retry insert also failed:', retryError);
              // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ SupabaseØŒ Ø§Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
              obj._id = genId();
              agents.push(obj);
              console.log('Agent added locally due to Supabase error');
            } else {
              console.log('Agent inserted successfully without board_name:', retryData);
              obj._id = genId();
              obj.db_id = retryData.id;
              dbIdByLocalId.set(obj._id, retryData.id);
              localIdByDbId.set(retryData.id, obj._id);
              agents.push(obj);
            }
          } else {
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…ÙØµÙ„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n';
            if (error.message) errorMessage += error.message + '\n';
            if (error.details) errorMessage += 'Ø§Ù„ØªÙØ§ØµÙŠÙ„: ' + error.details + '\n';
            if (error.hint) errorMessage += 'Ù†ØµÙŠØ­Ø©: ' + error.hint;
            
            alert(errorMessage);
            
            // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ ÙÙŠ SupabaseØŒ Ø§Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
            obj._id = genId();
            agents.push(obj);
            console.log('Agent added locally due to Supabase error');
          }
        } else {
          console.log('Agent inserted successfully in Supabase:', data);
          obj._id = genId();
          obj.db_id = data.id;
          dbIdByLocalId.set(obj._id, data.id);
          localIdByDbId.set(data.id, obj._id);
          agents.push(obj);
        }
      }catch(e){
        console.error('Error inserting agent:', e);
        console.error('Error stack:', e.stack);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
        obj._id = genId();
        agents.push(obj);
      }
      
      // Ø§Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
      saveToStorage();
      renderTable();
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
      modalAdd.classList.remove('open');
      document.getElementById('new_name').value='';
      document.getElementById('new_date').value='';
      document.getElementById('new_site').value='';
      document.getElementById('new_fdt').value='';
      document.getElementById('new_note').value='';
      document.getElementById('new_total').value='';
      document.getElementById('new_active').value='';
      
      console.log('New agent added successfully. Total agents:', agents.length);
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
      alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙƒÙŠÙ„ "${name}" Ø¨Ù†Ø¬Ø§Ø­!`);
    });

    function saveToStorage(){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(agents));
        localStorage.setItem(STORAGE_KEY + '_timestamp', Date.now().toString());
        console.log('Data saved to local storage successfully at:', new Date().toLocaleString());
        console.log('Agents count:', agents.length);
        return true;
      } catch (error) {
        console.error('Error saving to local storage:', error);
        return false;
      }
    }
    function loadFromStorage(){
      try{
        const s = localStorage.getItem(STORAGE_KEY);
        if(!s) return null;
        const arr = JSON.parse(s);
        arr.forEach(a => {
          computeAgent(a);
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† dbIdByLocalId Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
          if(a.db_id) {
            dbIdByLocalId.set(a._id, a.db_id);
            localIdByDbId.set(a.db_id, a._id);
          }
        });
        console.log('Loaded from storage, dbIdByLocalId entries:', Array.from(dbIdByLocalId.entries()));
        return arr;
      }catch(e){ return null; }
    }

    function computeAll(){
      agents.forEach(a=>computeAgent(a));
      renderTable();
    }

    // ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© loadFromSupabaseWithLocalMerge - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·

    async function loadFromSupabase(){
      try {
        console.log('Attempting to load data from Supabase...');
        console.log('Supabase URL:', SUPABASE_URL);
        
        const supabase = getSupabaseClient();
        if (!supabase) {
          console.error('Supabase client not available');
          return;
        }
        
        const { data, error } = await supabase
          .from('agents')
          .select('*')
          .order('id', { ascending: true });

        if(error){
          console.error('Supabase load error:', error);
          console.error('Error details:', error.message, error.details, error.hint);
          // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº
          agents = [];
          computeAll();
          return;
        }

        if(!data || data.length === 0){
          console.log('No data in Supabase, starting with empty table');
          agents = [];
          computeAll();
          return;
        }

        console.log('Data loaded from Supabase:', data.length, 'agents');
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase Ø¨Ù†Ø¬Ø§Ø­
        agents = data.map(row=>{
          const obj = {
            _id: genId(),
            db_id: row.id,
            name: row.name,
            note: row.note,
            contract_date: row.contract_date,
            phase: row.phase,
            itpc_site: '', // Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
            fdt: row.fdt,
            board_name: row.board_name || '', // Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            total_users: row.total_users,
            active: row.active, // Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            prev_active: row.prev_active || 0,
            history: []
          };
          dbIdByLocalId.set(obj._id, row.id);
          localIdByDbId.set(row.id, obj._id);
          console.log('Loaded agent:', obj.name, 'Local ID:', obj._id, 'DB ID:', row.id, 'Board:', obj.board_name);
          return computeAgent(obj);
        });
        
        console.log('dbIdByLocalId entries:', Array.from(dbIdByLocalId.entries()));
        computeAll();
        console.log('Data loaded successfully from Supabase:', agents.length, 'agents');
      } catch(e) {
        console.error('Error loading from Supabase:', e);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±Øº
        agents = [];
        computeAll();
      }
    }

    phaseFilter.addEventListener('change', renderTable);
    searchBox.addEventListener('input', renderTable);
    sortBy.addEventListener('change', renderTable);

    function safeNum(x){ return Number(x||0) || 0; }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    async function initializeData() {
      try {
        console.log('Initializing application...');
        updateConnectionStatus('connecting');
        
        let connectionOk = await testSupabaseConnection();
        
        if (!connectionOk && !SupabaseManager.hasInstance()) {
          console.warn('Supabase connection failed, trying to reinitialize...');
          updateConnectionStatus('connecting');
          reinitializeSupabase();
          connectionOk = await testSupabaseConnection();
        } else if (!connectionOk) {
          console.warn('Supabase connection failed, but instance exists - using local storage');
        }
        
        if (!connectionOk) {
          console.warn('Supabase connection failed after retry, starting with empty table');
          updateConnectionStatus('error');
          agents = [];
          computeAll();
          return;
        }
        
        await loadFromSupabase();
      } catch (e) {
        console.error('Error initializing data:', e);
        agents = [];
        computeAll();
      }
    }
    
    function initializeSupabase() {
      console.log('Initializing Supabase client...');
      const client = getSupabaseClient();
      if (client) {
        console.log('Supabase client initialized successfully');
        return true;
      } else {
        console.error('Failed to initialize Supabase client');
        return false;
      }
    }

    window.addEventListener('beforeunload', function() {
      console.log('Cleaning up Supabase instance...');
      SupabaseManager.reset();
    });

    
    initializeSupabase();
    initializeData();
    
    function applyTheme(theme){
      const root = document.documentElement;
      const bodyEl = document.body;
      if(theme === 'light'){
        root.classList.add('light');
        bodyEl.classList.add('light');
        btnTheme.innerHTML = '<span class="icon">â˜€ï¸</span>  ';
      } else {
        root.classList.remove('light');
        bodyEl.classList.remove('light');
        btnTheme.innerHTML = '<span class="icon">ğŸŒ™</span>  ';
      }
    }
    const savedTheme = localStorage.getItem('theme') || 'dark';
    applyTheme(savedTheme);
    btnTheme.addEventListener('click', ()=>{
      const current = localStorage.getItem('theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });


    document.addEventListener('click', (e)=>{
      if(e.target === modalEdit) modalEdit.classList.remove('open');
      if(e.target === modalAdd) modalAdd.classList.remove('open');
    });


    document.getElementById('btnWeeklyReport').addEventListener('click', ()=>{
      const todayStr = toYMDLocal(new Date());
      const headers = ['Ø§Ù„ÙˆÙƒÙŠÙ„','ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù‚Ø¯','ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…','FDT','Ø§Ø³Ù… Ø§Ù„Ù„ÙˆØ­Ø©','Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†','Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ','Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„','Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©','Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ÙˆØµÙˆÙ„','Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø¬Ø²','Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¬Ø²','Ø§Ù„Ø­Ø§Ù„Ø©'];

      const PHASE_ORDER = ['OLD','PHASE2','PHASE3'];
      let list = agents.slice();
      const sort = (document.getElementById('sortBy')||{}).value || 'name';
      if(sort === 'total_users_desc') list.sort((a,b)=> b.total_users - a.total_users);
      else if(sort === 'active_desc') list.sort((a,b)=> b.active - a.active);
      else if(sort === 'deficit_desc') list.sort((a,b)=> b.deficit_users - a.deficit_users);
      else list.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ar'));

      const phaseToItems = {};
      list.forEach(a=>{
        const key = (a.phase||'').toUpperCase();
        if(!phaseToItems[key]) phaseToItems[key] = [];
        phaseToItems[key].push(a);
      });

      let html = '';
      html += `<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ØªÙ‚Ø±ÙŠØ± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆÙƒÙ„Ø§Ø¡</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      width: 100%; 
      height: 100vh; 
      margin: 0; 
      padding: 0; 
      font-family: "Arial", "Helvetica", sans-serif;
      color: #000;
      overflow: hidden;
    }
    @page { 
      size: A4 landscape; 
      margin: 5mm; 
    }
    table { 
      width: calc(100vw - 10mm); 
      height: calc(100vh - 10mm); 
      border-collapse: collapse; 
      table-layout: fixed; 
      font-size: 10px; 
      font-weight: bold;
      margin: 5mm;
    }
    th, td { 
      border: 1px solid #000; 
      padding: 3px 4px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
      vertical-align: middle;
    }
    th { 
      background: #000; 
      color: #fff; 
      font-weight: bold;
      font-size: 11px;
      height: 25px;
    }
    td:nth-child(1) { 
      text-align: right; 
      width: 10%;
    }
    td:nth-child(2), td:nth-child(3) { 
      width: 5%;
    }
    td:nth-child(4) { 
      width: 6%;
    }
    td:nth-child(5) { 
      width: 5%;
    }
    td:nth-child(6) { 
      width: 7%;
    }
    td:nth-child(7) { 
      width: 5%;
    }
    td:nth-child(8) { 
      width: 6%;
    }
    td:nth-child(9) { 
      width: 6%;
    }
    td:nth-child(10) { 
      width: 7%;
    }
    td:nth-child(11) { 
      width: 5%;
    }
    td:nth-child(12) { 
      width: 7%;
    }
    td:nth-child(13) { 
      width: 3%;
    }
    td:nth-child(14) { 
      width: 5%;
    }
    tr.phase-row td { 
      background: #d0d0d0; 
      font-weight: bold; 
      text-align: right; 
      color: #000;
      font-size: 10px;
      height: 20px;
    }
    tr.subtotal-title td { 
      background: #c0c0c0; 
      font-weight: bold; 
      text-align: right; 
      color: #000;
      height: 18px;
    }
    tr.subtotal-values td { 
      background: #e0e0e0; 
      font-weight: bold; 
      color: #000;
      height: 16px;
    }
    tr.grand-total td { 
      background: #a0a0a0; 
      font-weight: bold; 
      color: #000;
      height: 18px;
    }
    .left { text-align: right; }
    @media print { 
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      html, body { 
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        font-family: "Arial", "Helvetica", sans-serif !important;
        color: #000 !important;
      } 
      table {
        width: calc(100% - 10mm) !important;
        height: calc(100% - 10mm) !important;
        font-size: 10px !important;
        font-weight: bold !important;
        border-collapse: collapse !important;
        margin: 5mm !important;
      }
      th, td {
        padding: 3px 4px !important;
        font-size: 10px !important;
        font-weight: bold !important;
        border: 1px solid #000 !important;
        color: #000 !important;
      }
      th {
        font-size: 11px !important;
        height: 25px !important;
        background: #000 !important;
        color: #fff !important;
      }
      tr.phase-row td {
        height: 20px !important;
        font-size: 10px !important;
        background: #d0d0d0 !important;
        color: #000 !important;
      }
      tr.subtotal-title td {
        height: 18px !important;
        background: #c0c0c0 !important;
        color: #000 !important;
      }
      tr.subtotal-values td {
        height: 16px !important;
        background: #e0e0e0 !important;
        color: #000 !important;
      }
      tr.grand-total td {
        height: 18px !important;
        background: #a0a0a0 !important;
        color: #000 !important;
      }
      thead { display: table-header-group !important; } 
      tfoot { display: table-footer-group !important; } 
      tr, td, th { page-break-inside: avoid !important; } 
      @page {
        size: A4 landscape !important;
        margin: 5mm !important;
      }
    }
  </style>
</head>
<body>`;
      html += '<table><thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';

      let grand = { total:0, active:0, deficit_users:0 };

      PHASE_ORDER.forEach(phaseKey=>{
        const items = phaseToItems[phaseKey];
        if(!items || items.length===0) return;

        html += `<tr class=\"phase-row\"><td colspan=\"${headers.length}\" class=\"left\">${arabicPhaseLabel(phaseKey)}</td></tr>`;

        items.forEach(a=>{
          html += '<tr>' + [
            escapeHtml(a.name || ''),
            a.contract_date || '',
            todayStr,
            a.fdt || '',
            (a.board_name || ''),
            num(a.total_users),
            num(a.active),
            (a.activation_rate||0) + '%',
            (a.required_rate === null ? '-' : a.required_rate + '%'),
            (a.required_rate === null ? '-' : num(a.required_users)),
            (a.required_rate === null ? '-' : (a.deficit_percent||0) + '%'),
            (a.deficit_users ? num(a.deficit_users) : '-'),
            a.status || ''
          ].map(v=>`<td>${v}</td>`).join('') + '</tr>';
        });

        const totals = items.reduce((acc, a)=>{
          acc.total += Number(a.total_users||0);
          acc.active += Number(a.active||0);
          acc.deficit_users += Number(a.deficit_users||0);
          return acc;
        }, {total:0, active:0, deficit_users:0});
        grand.total += totals.total; grand.active += totals.active; grand.deficit_users += totals.deficit_users;

        html += `<tr class=\"subtotal-title\"><td colspan=\"${headers.length}\" class=\"left\">Ù…Ø¬Ù…ÙˆØ¹ ${arabicPhaseLabel(phaseKey)}</td></tr>`;
        const cells = new Array(headers.length).fill('');
        cells[5] = num(totals.total);
        cells[6] = num(totals.active);
        cells[11] = totals.deficit_users ? num(totals.deficit_users) : '-';
        html += '<tr class=\"subtotal-values\">' + cells.map(v=>`<td>${v}</td>`).join('') + '</tr>';
      });

      const grandCells = new Array(headers.length).fill('');
      grandCells[5] = num(grand.total);
      grandCells[6] = num(grand.active);
      grandCells[11] = grand.deficit_users ? num(grand.deficit_users) : '-';
      html += `<tr class=\"grand-total\"><td colspan=\"${headers.length}\" class=\"left\">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„</td></tr>`;
      html += '<tr class=\"grand-total\">' + grandCells.map(v=>`<td>${v}</td>`).join('') + '</tr>';

      html += '</tbody></table>';
      html += '<script>setTimeout(function(){ if(window.print) window.print(); }, 300);<\/script>';
      html += '</body></html>';

      const w = window.open('about:blank','_blank');
      if(w){ w.document.open(); w.document.write(html); w.document.close(); }
    });


  </script>
</body>
</html>

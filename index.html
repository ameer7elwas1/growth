<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> Agents Growth Iraqcell</title>
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap">

  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f5;
      --bg-tertiary: #ebebeb;
      --text-primary: #1a1a1a;
      --text-secondary: #4a4a4a;
      --text-tertiary: #7a7a7a;
      --border-color: #801c32;
      --border-light: rgba(128, 28, 50, 0.25);
      --primary-color: #801c32;
      --primary-hover: #9d2338;
      --primary-light: rgba(128, 28, 50, 0.12);
      --shadow-sm: rgba(128, 28, 50, 0.1);
      --shadow-md: rgba(128, 28, 50, 0.2);
      --shadow-lg: rgba(128, 28, 50, 0.3);
      --card-bg: #ffffff;
      --sidebar-bg: #f5f5f5;
      --nav-bg: rgba(255, 255, 255, 0.9);
      --nav-hover: rgba(128, 28, 50, 0.1);
      --input-bg: #ffffff;
      --input-border: #801c32;
      --input-focus: rgba(128, 28, 50, 0.5);
      --modal-bg: #ffffff;
      --table-bg: #ffffff;
      --table-header: #801c32;
      --table-border: #d0d0d0;
      --success-color: #28a745;
      --success-light: rgba(40, 167, 69, 0.12);
      --error-color: #dc3545;
      --error-light: rgba(220, 53, 69, 0.12);
      --info-color: #17a2b8;
      --info-light: rgba(23, 162, 184, 0.12);
      --warning-color: #ffc107;
      --warning-light: rgba(255, 193, 7, 0.12);
      --bg: #ffffff;
      --card: #ffffff;
      --accent: #801c32;
      --accent-hover: #9d2338;
      --accent-secondary: #801c32;
      --accent-pink: #ffffff;
      --muted: #7a7a7a;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --panel-bg: rgba(255,255,255,0.98);
      --glass: rgba(128, 28, 50, 0.08);
      --glass-hover: rgba(128, 28, 50, 0.15);
      --border-radius: 12px;
      --transition: all 0.3s ease;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
    }

    [data-theme="dark"] {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #252525;
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-tertiary: #b0b0b0;
      --border-color: rgba(255, 255, 255, 0.25);
      --border-light: rgba(255, 255, 255, 0.15);
      --primary-color: #ff4757;
      --primary-hover: #ff6b7a;
      --primary-light: rgba(255, 71, 87, 0.2);
      --shadow-sm: rgba(0, 0, 0, 0.5);
      --shadow-md: rgba(0, 0, 0, 0.7);
      --shadow-lg: rgba(0, 0, 0, 0.9);
      --card-bg: #1a1a1a;
      --sidebar-bg: #141414;
      --nav-bg: rgba(20, 20, 20, 0.95);
      --nav-hover: rgba(255, 71, 87, 0.25);
      --input-bg: #252525;
      --input-border: rgba(255, 255, 255, 0.3);
      --input-focus: rgba(255, 71, 87, 0.6);
      --modal-bg: #1a1a1a;
      --table-bg: #1a1a1a;
      --table-header: #ff4757;
      --table-border: #3a3a3a;
      --success-color: #4ade80;
      --success-light: rgba(74, 222, 128, 0.2);
      --error-color: #f87171;
      --error-light: rgba(248, 113, 113, 0.2);
      --info-color: #60a5fa;
      --info-light: rgba(96, 165, 250, 0.2);
      --warning-color: #fbbf24;
      --warning-light: rgba(251, 191, 36, 0.2);
      --bg: #0f0f0f;
      --card: #1a1a1a;
      --accent: #ff4757;
      --accent-hover: #ff6b7a;
      --accent-secondary: #ff4757;
      --accent-pink: #ffffff;
      --muted: #b0b0b0;
      --success: #4ade80;
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #60a5fa;
      --panel-bg: rgba(26, 26, 26, 0.95);
      --glass: rgba(255,255,255,0.1);
      --glass-hover: rgba(255,255,255,0.15);
    }

    [data-theme="dark"] * {
      text-shadow: none;
    }
    
    * {
      color: inherit;
    }
    
    body, p, span, div, td, th, label, input, select, textarea {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    [data-theme="dark"] body, 
    [data-theme="dark"] p, 
    [data-theme="dark"] span, 
    [data-theme="dark"] div, 
    [data-theme="dark"] td, 
    [data-theme="dark"] th, 
    [data-theme="dark"] label, 
    [data-theme="dark"] input, 
    [data-theme="dark"] select, 
    [data-theme="dark"] textarea,
    [data-theme="dark"] strong,
    [data-theme="dark"] small,
    [data-theme="dark"] b,
    [data-theme="dark"] i,
    [data-theme="dark"] em {
      color: #ffffff !important;
      font-weight: 500;
    }
    
    h1, h2, h3, h4, h5, h6 {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    [data-theme="dark"] h1, 
    [data-theme="dark"] h2, 
    [data-theme="dark"] h3, 
    [data-theme="dark"] h4, 
    [data-theme="dark"] h5, 
    [data-theme="dark"] h6 {
      color: #ffffff !important;
      font-weight: 700;
    }
    
    :root:not([data-theme="dark"]) body, 
    :root:not([data-theme="dark"]) p, 
    :root:not([data-theme="dark"]) span, 
    :root:not([data-theme="dark"]) div, 
    :root:not([data-theme="dark"]) td, 
    :root:not([data-theme="dark"]) th, 
    :root:not([data-theme="dark"]) label, 
    :root:not([data-theme="dark"]) input, 
    :root:not([data-theme="dark"]) select, 
    :root:not([data-theme="dark"]) textarea {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    :root:not([data-theme="dark"]) tbody tr:nth-child(even){background:transparent;}
    :root:not([data-theme="dark"]) tbody tr:hover{background:transparent;}
    :root:not([data-theme="dark"]) th, :root:not([data-theme="dark"]) td{border-bottom:none;}
    :root:not([data-theme="dark"]) th{border-bottom:none;}
    :root:not([data-theme="dark"]) tr.subtotal-title td{background:var(--card-bg); border-bottom:none; border: 1px solid var(--border-color); border-radius: var(--border-radius);}
    :root:not([data-theme="dark"]) tr.subtotal-values td{background:var(--card-bg); border-bottom:none; border: 1px solid var(--border-color); border-radius: var(--border-radius);}
    :root:not([data-theme="dark"]) .phase-header td{background:var(--card-bg); border-bottom:none; border: 1px solid var(--border-color); border-radius: var(--border-radius);}
    
    :root:not([data-theme="dark"]) .stat:nth-child(1),
    :root:not([data-theme="dark"]) .stat:nth-child(2),
    :root:not([data-theme="dark"]) .stat:nth-child(3),
    :root:not([data-theme="dark"]) .stat:nth-child(4),
    :root:not([data-theme="dark"]) .stat:nth-child(5),
    :root:not([data-theme="dark"]) .stat:nth-child(6) {
      border: none !important;
    }
    
    :root:not([data-theme="dark"]) .stat:nth-child(1) {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .stat:nth-child(2) {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .stat:nth-child(3) {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .stat:nth-child(4) {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .stat:nth-child(5) {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .stat:nth-child(6) {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .card .stat:nth-child(1),
    :root:not([data-theme="dark"]) section.card .stat:nth-child(1) {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .card .stat:nth-child(2),
    :root:not([data-theme="dark"]) section.card .stat:nth-child(2) {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .card .stat:nth-child(3),
    :root:not([data-theme="dark"]) section.card .stat:nth-child(3) {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .card .stat:nth-child(4),
    :root:not([data-theme="dark"]) section.card .stat:nth-child(4) {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .card .stat:nth-child(5),
    :root:not([data-theme="dark"]) section.card .stat:nth-child(5) {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }
    
    :root:not([data-theme="dark"]) .card .stat:nth-child(6),
    :root:not([data-theme="dark"]) section.card .stat:nth-child(6) {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    }
    
    /* Light mode button styles */
    :root:not([data-theme="dark"]) .btn.secondary {
      background: var(--primary-light);
      border: 1.5px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 700;
    }
    :root:not([data-theme="dark"]) .btn.secondary:hover {
      background: var(--primary-color);
      color: white;
    }
    
    :root:not([data-theme="dark"]) .btn {
      background: var(--primary-color);
      color: white;
      font-weight: 700;
    }
    :root:not([data-theme="dark"]) .btn:hover {
      background: var(--primary-hover);
    }
    
    :root:not([data-theme="dark"]) .modal {
      background: rgba(0, 0, 0, 0.5);
    }
    :root:not([data-theme="dark"]) .modal .box {
      background: var(--modal-bg);
      border: 2px solid var(--border-color);
      box-shadow: 0 8px 24px var(--shadow-lg);
    }
    
    :root:not([data-theme="dark"]) input[type="text"], 
    :root:not([data-theme="dark"]) input[type="number"], 
    :root:not([data-theme="dark"]) input[type="date"], 
    :root:not([data-theme="dark"]) select {
      background: var(--input-bg);
      border: 2px solid var(--input-border);
      color: var(--text-primary);
      font-weight: 500;
    }
    
    :root:not([data-theme="dark"]) input[type="text"]:focus, 
    :root:not([data-theme="dark"]) input[type="number"]:focus, 
    :root:not([data-theme="dark"]) input[type="date"]:focus, 
    :root:not([data-theme="dark"]) select:focus {
      background: var(--input-bg);
      border-color: var(--primary-color);
      box-shadow: 0 0 20px var(--shadow-md);
    }
    
    :root:not([data-theme="dark"]) .badge.good {
      background: var(--success-light);
      color: var(--success-color);
      border: 1.5px solid var(--success-color);
      font-weight: 700;
    }
    
    :root:not([data-theme="dark"]) .badge.fail {
      background: var(--error-light);
      color: var(--error-color);
      border: 1.5px solid var(--error-color);
      font-weight: 700;
    }
    
    :root:not([data-theme="dark"]) .badge.ok {
      background: var(--warning-light);
      color: var(--warning-color);
      border: 1.5px solid var(--warning-color);
      font-weight: 700;
    }
    
    /* Light mode deficit colors for reports */
    :root:not([data-theme="dark"]) .deficit-green,
    :root:not([data-theme="dark"]) .deficit-orange,
    :root:not([data-theme="dark"]) .deficit-red {
      color: var(--text-primary) !important;
      font-weight: 700 !important;
    }
    
    /* Dark mode button improvements */
    .btn.secondary{
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .btn.secondary:hover{
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
    }
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-size: 16px;
      font-weight: 500;
      line-height: 1.6;
      overflow-x: hidden;
    }
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, var(--shadow-sm) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, var(--shadow-sm) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      opacity: 0.5;
    }
    [data-theme="dark"] body::before {
      opacity: 0.3;
    }
    .container {
      display: flex;
      width: 100%;
      max-width: 100vw;
      min-height: 100vh;
      position: relative;
      z-index: 1;
      overflow-x: hidden;
      box-sizing: border-box;
      padding: 0;
      margin: 0;
    }
    header {
      display: flex; 
      gap: 24px; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 20px;
      padding: 20px 25px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      border: 1.5px solid var(--border-light);
      box-shadow: 
        0 4px 12px var(--shadow-sm),
        0 2px 6px var(--shadow-sm);
      position: relative;
      overflow: hidden;
      flex-wrap: wrap;
      transition: all 0.3s ease;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .container {
        max-width: 100%;
      }
      
      header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
        padding: 16px;
      }
      
      .header-left,
      .header-right {
        margin-left: 0;
        justify-content: center;
      }
      
      .controls {
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .controls-group {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      h1 {
        font-size: 24px;
        text-align: center;
      }
      
      .lead {
        text-align: center;
        font-size: 14px;
      }
      
      .stats {
        flex-direction: column;
        gap: 12px;
      }
      
      .stat {
        min-width: 100%;
        text-align: center;
      }
      
      .filters {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }
      
      .search, select {
        width: 100%;
        font-size: 14px;
        padding: 12px;
      }
      
      .row {
        flex-direction: column;
        gap: 16px;
      }
      
      .chart-row {
        flex-direction: column;
        gap: 16px;
      }
      
      .chart-card {
        min-height: 200px;
        width: 100%;
      }
    }
    header::before{
      display: none;
    }
    header::after{
      display: none;
    }
    .header-content{
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      z-index: 1;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0; 
      font-weight: 900;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
      color: var(--primary-color);
      letter-spacing: 0.5px;
      position: relative;
      text-shadow: 0 2px 4px rgba(128, 28, 50, 0.15);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      line-height: 1.3;
    }
    [data-theme="dark"] h1 {
      color: var(--primary-color);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    p.lead {
      margin: 0; 
      color: var(--text-secondary); 
      font-size: 0.95rem;
      font-weight: 500;
      letter-spacing: 0.2px;
      opacity: 1;
    }
    
    [data-theme="dark"] p.lead {
      color: var(--text-secondary);
    }
    .card {
      background: var(--card-bg);
      border: 1.5px solid var(--border-color);
      border-radius: 10px;
      padding: 18px 20px;
      box-shadow: 0 2px 6px var(--shadow-sm);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      color: var(--text-primary);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    section.card:has(.stats),
    .card:has(.stats) {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      padding: 20px 0 !important;
    }
    
    .card h3 {
      color: var(--primary-color);
      font-size: 1.15rem;
      font-weight: 700;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1.5px solid var(--border-light);
    }
    .card:hover {
      box-shadow: 0 4px 12px var(--shadow-md);
      border-color: var(--primary-color);
    }
    
    section.card:has(.stats):hover,
    .card:has(.stats):hover {
      box-shadow: none !important;
      border-color: transparent !important;
    }
    .controls{
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      align-items: center;
      position: relative;
      z-index: 1;
      order: 2;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
      order: 1;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      order: 3;
      margin-left: auto;
    }
    .controls-group{
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
    }
    input[type="file"]{display:none;}
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 700;
      margin: 6px 5px;
      transition: all 0.3s ease;
      box-shadow: 
        0 3px 8px rgba(0, 0, 0, 0.12),
        0 2px 4px rgba(0, 0, 0, 0.08);
      position: relative;
      background: var(--primary-color);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
    }
    .btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 
        0 6px 16px rgba(0, 0, 0, 0.18),
        0 4px 8px rgba(0, 0, 0, 0.12);
    }
    .btn:active {
      transform: translateY(0);
      box-shadow: 
        0 2px 4px rgba(0, 0, 0, 0.12),
        0 1px 2px rgba(0, 0, 0, 0.08);
    }
    .btn.secondary {
      background: var(--primary-light);
      border: 1.5px solid var(--primary-color);
      color: var(--primary-color);
      font-weight: 700;
    }
    .btn.secondary:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    .btn.warn {
      background: var(--warning-color);
      color: #000000;
    }
    .btn.warn:hover {
      background: var(--warning-color);
      opacity: 0.9;
    }
    .btn.danger {
      background: var(--error-color);
      color: white;
    }
    .btn.danger:hover {
      background: var(--error-color);
      opacity: 0.9;
    }
    .btn.small{
      padding: 6px 10px;
      font-size: 11px;
      min-height: 28px;
      border-radius: 6px;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn.small.secondary{
      background: rgba(99,102,241,0.15); 
      border: 1px solid rgba(99,102,241,0.4); 
      color: #a5b4fc;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn.small.secondary:hover{
      background: rgba(99,102,241,0.25);
      border-color: rgba(99,102,241,0.6);
      color: #c7d2fe;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }
    
    .btn.tiny{
      padding: 2px 6px;
      font-size: 8px;
      min-height: 20px;
      border-radius: 4px;
    }
    .modal .btn{
      min-width: 90px;
      justify-content: center;
    }
    .btn-icon{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 12px;
      margin-right: 4px;
    }
    .flex{display:flex; gap:8px; align-items:center;    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border: none;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 160px;
      cursor: pointer;
      flex: none;
      min-width: auto;
    }
    
    .stat::before {
      content: '';
      position: absolute;
      bottom: -20px;
      left: -20px;
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 50%;
      opacity: 0.6;
      transition: all 0.3s ease;
      z-index: 0;
    }
    
    .stat:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
    }
    
    .stat:hover::before {
      transform: scale(1.2);
      opacity: 0.8;
    }
    
    .stat:nth-child(1) {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    }
    
    .stat:nth-child(2) {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    }
    
    .stat:nth-child(3) {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }
    
    .stat:nth-child(4) {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
    }
    
    .stat:nth-child(5) {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }
    
    .stat:nth-child(6) {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    }
    
    .card .stat,
    section.card .stat {
      border: none !important;
    }
    
    .card .stat:nth-child(1),
    section.card .stat:nth-child(1) {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    }
    
    .card .stat:nth-child(2),
    section.card .stat:nth-child(2) {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
    }
    
    .card .stat:nth-child(3),
    section.card .stat:nth-child(3) {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }
    
    .card .stat:nth-child(4),
    section.card .stat:nth-child(4) {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%) !important;
    }
    
    .card .stat:nth-child(5),
    section.card .stat:nth-child(5) {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }
    
    .card .stat:nth-child(6),
    section.card .stat:nth-child(6) {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    }
    
    .stat h3 {
      margin: 0;
      font-size: 5.5rem;
      font-weight: 900;
      line-height: 1;
      font-family: 'Cairo', sans-serif;
      letter-spacing: -4px;
      position: relative;
      z-index: 1;
      margin-bottom: 12px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    .stat p {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.4px;
      position: relative;
      z-index: 1;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      line-height: 1.5;
    }
    
    :root:not([data-theme="dark"]) .stat h3 {
      color: #000000 !important;
      text-shadow: 0 2px 4px rgba(255, 255, 255, 0.5), 0 4px 8px rgba(255, 255, 255, 0.3);
      font-size: 5.5rem;
      font-weight: 900;
    }
    
    :root:not([data-theme="dark"]) .stat p {
      color: #000000 !important;
      text-shadow: 0 1px 3px rgba(255, 255, 255, 0.5), 0 2px 6px rgba(255, 255, 255, 0.3);
      font-size: 1.4rem;
      font-weight: 800;
    }
    
    /* ضمان الخط الأسود في الوضع النهاري */
    .card .stat h3,
    section.card .stat h3 {
      color: inherit;
    }
    
    :root:not([data-theme="dark"]) .card .stat h3,
    :root:not([data-theme="dark"]) section.card .stat h3 {
      color: #000000 !important;
    }
    
    .card .stat p,
    section.card .stat p {
      color: inherit;
    }
    
    :root:not([data-theme="dark"]) .card .stat p,
    :root:not([data-theme="dark"]) section.card .stat p {
      color: #000000 !important;
    }
    
    /* الوضع الليلي - خط أبيض على خلفيات ملونة */
    [data-theme="dark"] .stat {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
    
    [data-theme="dark"] .stat:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    }
    
    [data-theme="dark"] .stat h3 {
      color: #ffffff !important;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.6), 0 6px 18px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.1);
      font-size: 5.5rem;
      font-weight: 900;
      letter-spacing: -4px;
    }
    
    [data-theme="dark"] .stat p {
      color: #ffffff !important;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(255, 255, 255, 0.08);
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.4px;
    }
    
    [data-theme="dark"] .card .stat h3,
    [data-theme="dark"] section.card .stat h3 {
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .card .stat p,
    [data-theme="dark"] section.card .stat p {
      color: #ffffff !important;
    }
    
    @media (min-width: 1400px) {
      :root:not([data-theme="dark"]) .stat h3 {
        font-size: 6rem;
        letter-spacing: -4.5px;
      }
      
      :root:not([data-theme="dark"]) .stat p {
        font-size: 1.5rem;
        letter-spacing: 0.5px;
      }
    }
    
    @media (min-width: 1920px) {
      :root:not([data-theme="dark"]) .stat h3 {
        font-size: 6.5rem;
        letter-spacing: -5px;
      }
      
      :root:not([data-theme="dark"]) .stat p {
        font-size: 1.6rem;
        letter-spacing: 0.6px;
      }
    }
    
    @media (min-width: 1400px) {
      [data-theme="dark"] .stat h3 {
        font-size: 6rem;
        letter-spacing: -4.5px;
      }
      
      [data-theme="dark"] .stat p {
        font-size: 1.5rem;
        letter-spacing: 0.5px;
      }
    }
    
    @media (min-width: 1920px) {
      [data-theme="dark"] .stat h3 {
        font-size: 6.5rem;
        letter-spacing: -5px;
      }
      
      [data-theme="dark"] .stat p {
        font-size: 1.6rem;
        letter-spacing: 0.6px;
      }
    }
    
    @media (max-width: 768px) {
      .stat h3 {
        font-size: 3.5rem;
        letter-spacing: -2.5px;
        margin-bottom: 8px;
      }
      
      .stat p {
        font-size: 1.1rem;
        letter-spacing: 0.3px;
      }
      
      :root:not([data-theme="dark"]) .stat h3 {
        color: #000000 !important;
        font-size: 3.5rem;
      }
      
      :root:not([data-theme="dark"]) .stat p {
        color: #000000 !important;
        font-size: 1.1rem;
      }
      
      [data-theme="dark"] .stat h3 {
        color: #ffffff !important;
        font-size: 3.5rem;
      }
      
      [data-theme="dark"] .stat p {
        color: #ffffff !important;
        font-size: 1.1rem;
      }
    }
    .row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      width: 100%;
    }
    .col {
      flex: 1;
      min-width: 300px;
    }
    
    .filters {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: stretch;
      width: 100%;
      justify-content: flex-start;
    }
    
    .filters .search,
    .filters select {
      flex: 1 1 250px;
      min-width: 200px;
      max-width: 100%;
    }
    
    @media (min-width: 1400px) {
      .filters {
        gap: 20px;
      }
      
      .filters .search,
      .filters select {
        flex: 1 1 280px;
        min-width: 220px;
      }
    }
    
    @media (min-width: 1920px) {
      .filters {
        gap: 24px;
      }
      
      .filters .search,
      .filters select {
        flex: 1 1 300px;
        min-width: 250px;
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--table-bg);
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
    }
    th {
      background: var(--table-header);
      color: white;
      padding: 16px 18px;
      text-align: right;
      font-weight: 800;
      font-size: 0.95rem;
      letter-spacing: 0.4px;
      border: 1px solid var(--table-border);
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
    }
    
    :root:not([data-theme="dark"]) th {
      background: var(--table-header);
      color: #ffffff;
      font-weight: 800;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      font-size: 0.95rem;
      letter-spacing: 0.4px;
    }
    
    [data-theme="dark"] th {
      background: var(--table-header);
      color: #ffffff;
      font-weight: 800;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 71, 87, 0.25);
      font-size: 0.95rem;
      letter-spacing: 0.4px;
    }
    
    td {
      padding: 14px 18px;
      border: 1px solid var(--table-border);
      border-bottom: 1.5px solid var(--border-light);
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      letter-spacing: 0.1px;
      text-align: center;
      white-space: nowrap;
      overflow: visible;
      text-overflow: ellipsis;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      line-height: 1.5;
    }
    
    :root:not([data-theme="dark"]) td {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
    }
    
    [data-theme="dark"] td {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
    }
    
    tbody tr td strong {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.4;
    }
    
    tbody tr td small {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    [data-theme="dark"] tbody tr td strong {
      color: var(--text-primary);
      font-weight: 700;
    }
    
    [data-theme="dark"] tbody tr td small {
      color: var(--text-secondary);
    }
    
    tbody tr {
      background: var(--card-bg);
      transition: all 0.2s ease;
      border: none;
    }
    
    tbody tr:nth-child(even) {
      background: var(--bg-tertiary);
    }
    
    tbody tr:hover {
      background: var(--bg-secondary);
      transform: scale(1.01);
      box-shadow: 0 2px 8px var(--shadow-sm);
    }
    
    tbody tr:nth-child(even):hover {
      background: var(--bg-secondary);
    }
    
    tbody tr td {
      background: transparent !important;
      border: 1px solid var(--table-border);
      border-bottom: 1.5px solid var(--border-light);
      padding: 14px 18px;
      overflow: visible;
      white-space: normal;
      font-size: 1rem;
      font-weight: 600;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    tbody tr:nth-child(even) td {
      background: transparent !important;
    }
    
    tbody tr:hover td {
      background: transparent !important;
    }
    
    tbody tr td div,
    tbody tr td strong,
    tbody tr td small,
    tbody tr td .flex {
      background: transparent !important;
    }
    /* تم تحديث td small أعلاه */
    
    /* تمييز صفوف الوكلاء - تم تحديثه أعلاه */
    
    tr.subtotal-title td {
      background: var(--primary-light) !important;
      border: 1.5px solid var(--primary-color);
      font-weight: 700;
      padding: 16px 20px;
      color: var(--primary-color);
    }
    
    tr.subtotal-values td {
      background: var(--card-bg);
      border: 1px solid var(--table-border);
      border-bottom: 1.5px solid var(--border-light);
      font-weight: 600;
      padding: 16px 20px;
    }
    
    tr.phase-header td {
      background: var(--primary-light) !important;
      border: 1.5px solid var(--primary-color);
      font-weight: 700;
      padding: 16px 20px;
      color: var(--primary-color);
    }
    
    tr.subtotal-title:hover td,
    tr.phase-header:hover td {
      background: var(--primary-light) !important;
      transform: none;
    }
    .badge {
      padding: 6px 12px; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 0.75rem;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge.good {
      background: var(--success-light); 
      color: var(--success-color); 
      border: 1.5px solid var(--success-color);
      font-weight: 700;
    }
    .badge.fail {
      background: var(--error-light); 
      color: var(--error-color); 
      border: 1.5px solid var(--error-color);
      font-weight: 700;
    }
    .badge.ok {
      background: var(--warning-light); 
      color: var(--warning-color); 
      border: 1.5px solid var(--warning-color);
      font-weight: 700;
    }
    
    [data-theme="dark"] .badge.good,
    [data-theme="dark"] .badge.fail,
    [data-theme="dark"] .badge.ok {
      font-weight: 700;
    }
    .search {
      padding: 15px 20px; 
      border-radius: 15px; 
      border: 2px solid var(--input-border); 
      background: var(--input-bg); 
      color: var(--text-primary);
      transition: all 0.3s ease;
      min-width: 140px;
      flex: 1 1 200px;
      font-size: 16px;
      font-weight: 500;
      text-align: right;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      line-height: 1.5;
    }
    .search:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 20px var(--shadow-md);
      transform: translateY(-2px);
      background: var(--input-bg);
      font-weight: 600;
    }
    .filters{
      display:flex; 
      gap:16px; 
      flex-wrap:wrap; 
      align-items:center;
      width: 100%;
    }
    .modal {
      position: fixed; 
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none; 
      align-items: center; 
      justify-content: center; 
      background: rgba(0, 0, 0, 0.5); 
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    .modal.open {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal .box {
      width: 700px; 
      max-width: 90%; 
      background: var(--modal-bg); 
      padding: 40px; 
      border-radius: 16px;
      box-shadow: 0 8px 24px var(--shadow-lg);
      border: 2px solid var(--border-color);
      animation: modalSlideIn 0.3s ease-out;
      margin: auto;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      transform: none;
      flex-shrink: 0;
    }
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .modal {
      animation: modalFadeIn 0.3s ease-out;
    }
    
    /* Ensure proper positioning */
    .modal.open {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    
    .modal .box {
      margin: auto !important;
      position: relative !important;
      top: auto !important;
      left: auto !important;
      transform: none !important;
    }
    .modal h3 {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0 0 30px 0;
      color: var(--primary-color);
      text-align: center;
      font-family: 'Cairo', 'Segoe UI', 'Arial', sans-serif;
    }
    
    label {
      display: block; 
      font-size: 0.95rem; 
      margin-bottom: 8px; 
      color: var(--text-primary); 
      font-weight: bold;
      transition: color 0.3s ease;
    }
    input[type="text"], input[type="number"], input[type="date"], select {
      width: 100%; 
      padding: 15px 20px; 
      border-radius: 15px; 
      border: 2px solid var(--input-border); 
      background: var(--input-bg); 
      color: var(--text-primary);
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 10px;
      box-sizing: border-box;
      text-align: right;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      line-height: 1.5;
    }
    input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 20px var(--shadow-md);
      transform: translateY(-2px);
      background: var(--input-bg);
      font-weight: 600;
    }
    .actions{
      display: flex; 
      gap: 10px; 
      justify-content: center; 
      margin-top: 16px; 
      flex-wrap: wrap;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .actions .btn{
      min-width: 100px;
      justify-content: center;
    }
    
    table .actions .btn {
      min-width: 80px;
      padding: 6px 12px;
      font-size: 11px;
      margin: 2px;
      white-space: nowrap;
      border: 1px solid rgba(0,0,0,0.1);
      background: var(--card);
      color: var(--text);
      transition: all 0.2s ease;
    }
    
    table .actions .btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    table .actions .btn.secondary {
      background: rgba(99,102,241,0.1);
      color: var(--accent);
      border-color: rgba(99,102,241,0.2);
    }
    
    table .actions .btn.secondary:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    table .actions .btn.warn {
      background: rgba(128,28,50,0.1);
      color: #801c32;
      border-color: rgba(128,28,50,0.2);
    }
    
    :root:not([data-theme="dark"]) table .actions .btn {
      background: #f8fafc;
      color: #333333;
      border-color: rgba(0,0,0,0.1);
    }
    
    :root:not([data-theme="dark"]) table .actions .btn:hover {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    :root:not([data-theme="dark"]) table .actions .btn.secondary {
      background: rgba(128,28,50,0.1);
      color: var(--primary-color);
      border-color: rgba(128,28,50,0.2);
    }
    
    :root:not([data-theme="dark"]) table .actions .btn.warn {
      background: rgba(128,28,50,0.1);
      color: #801c32;
      border-color: rgba(128,28,50,0.2);
    }
    
    @media (max-width: 768px) {
      table .actions .btn {
        min-width: 70px;
        padding: 4px 8px;
        font-size: 10px;
        margin: 1px;
      }
      
      table .actions .flex {
        gap: 4px;
      }
      
      table td:last-child {
        min-width: 120px;
        padding: 6px 2px;
      }
    }
    
    table .actions .flex {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    table td:last-child {
      text-align: center;
      vertical-align: middle;
      padding: 10px 6px;
      width: 9%;
      white-space: normal;
    }
    
    table .btn {
      margin: 2px 3px;
      flex-shrink: 0;
      padding: 8px 12px;
      font-size: 11px;
      min-width: 75px;
      font-weight: 600;
    }
    .form-group{margin-bottom: 12px;}
    .form-row{display: flex; gap: 12px; margin-bottom: 12px;}
    .form-row .form-group{flex: 1; margin-bottom: 0;}
    
    .form-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-grid .form-group{
      margin-bottom: 0;
    }
    .small{font-size:12px; color:var(--muted);}
    .chart-row{display:flex; gap:16px; margin-top:16px; flex-wrap:wrap;}
    
    #connectionStatus{
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    #connectionStatus.connected{
      background: rgba(16,185,129,0.2);
      border-color: rgba(16,185,129,0.4);
      color: var(--success);
    }
    #connectionStatus.error{
      background: rgba(244,63,94,0.2);
      border-color: rgba(244,63,94,0.4);
      color: var(--danger);
    }
    #connectionStatus.connecting{
      background: rgba(245,158,11,0.2);
      border-color: rgba(245,158,11,0.4);
      color: var(--warning);
    }
    
    .user-contact-popup {
      position: fixed;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      min-width: 250px;
      max-width: 300px;
      z-index: 10001;
      display: none;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(0);
      will-change: transform, opacity;
    }
    .user-contact-popup.show {
      display: block;
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      animation: popupFadeIn 0.15s ease-out forwards;
    }
    @keyframes popupFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes popupFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-5px);
      }
    }
    .user-contact-popup::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-bottom-color: var(--card-bg);
      filter: drop-shadow(0 -2px 4px rgba(0, 0, 0, 0.1));
      pointer-events: none;
    }
    .user-contact-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
    }
    .user-contact-item:last-child {
      border-bottom: none;
    }
    .user-contact-item a {
      color: var(--primary-color);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .user-contact-item a:hover {
      color: var(--primary-hover);
      text-decoration: underline;
    }
    .user-contact-icon {
      font-size: 1.0rem;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chart-card {
      flex: 1 1 400px; 
      min-height: 300px; 
      padding: 20px; 
      background: var(--card-bg); 
      border-radius: var(--border-radius);
      border: 1.5px solid var(--border-light);
      transition: all 0.3s ease;
      box-shadow: 
        0 4px 12px var(--shadow-sm),
        0 2px 6px var(--shadow-sm);
    }
    .chart-card:hover {
      box-shadow: 
        0 20px 50px var(--shadow-md),
        0 10px 30px var(--shadow-sm);
      border-color: var(--primary-color);
    }
    footer {
      color: var(--text-tertiary); 
      margin-top: 20px; 
      font-size: 0.9rem;
      font-weight: 500;
    }
    .icon{font-size:16px; margin-right:4px;}
    th:nth-child(1), td:nth-child(1){text-align:right; padding-right:12px; width: 10%;}
    th:nth-child(2), td:nth-child(2){width: 7%;}
    th:nth-child(3), td:nth-child(3), th:nth-child(4), td:nth-child(4){width: 5%;}
    th:nth-child(5), td:nth-child(5){width: 5.5%;}
    th:nth-child(6), td:nth-child(6){width: 5.5%;}
    th:nth-child(7), td:nth-child(7){width: 6.5%;}
    th:nth-child(8), td:nth-child(8){width: 6.5%;}
    th:nth-child(9), td:nth-child(9){width: 5%;}
    th:nth-child(10), td:nth-child(10){width: 5.5%;}
    th:nth-child(11), td:nth-child(11){width: 5.5%;}
    th:nth-child(12), td:nth-child(12){width: 5.5%;}
    th:nth-child(13), td:nth-child(13){width: 5.5%;}
    th:nth-child(14), td:nth-child(14){width: 5.5%;}
    th:nth-child(15), td:nth-child(15){width: 5.5%;}
    th:nth-child(16), td:nth-child(16){width: 8%;}
    
   
    td:nth-child(1){white-space:normal; word-wrap:break-word; background:transparent !important;}
    td:nth-child(1) strong{font-size:12px; line-height:1.3; word-break:break-word; font-weight:600; background:transparent !important;}
    td:nth-child(1) small{font-size:9px; margin-top:3px; word-break:break-word; color:var(--muted); background:transparent !important;}
    td:nth-child(1) div{background:transparent !important;}
    
    td:nth-child(4){white-space:normal; word-wrap:break-word; text-align:center; background:transparent !important;}
    
    td:last-child{background:transparent !important;}
    td:last-child .flex{background:transparent !important;}
    
    .btn{font-size:12px; padding:8px 12px;}
    
    @media (min-width: 1400px) {
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 12px 10px;
        font-size: 12px;
      }
      
      th {
        font-size: 1rem;
        font-weight: 800;
        padding: 16px 12px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        letter-spacing: 0.4px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      td {
        font-size: 1.05rem;
        font-weight: 600;
      }
      
      [data-theme="dark"] th {
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 71, 87, 0.25);
      }
      
      table .btn {
        padding: 10px 16px;
        font-size: 12px;
        min-width: 90px;
      }
      
      table .actions .flex {
        gap: 8px;
      }
      
      table td:last-child {
        padding: 12px 10px;
        width: 9%;
      }
      
      .stat {
        min-width: 220px;
        padding: 22px;
      }
      
      .stat h3 {
        font-size: 22px;
      }
      
      .stat p {
        font-size: 13px;
      }
      
      .filters {
        gap: 18px;
      }
      
      .search {
        flex: 1 1 200px;
        min-width: 150px;
      }
    }
    
    @media (min-width: 1920px) {
      table {
        font-size: 13px;
      }
      
      th, td {
        padding: 14px 10px;
        font-size: 13px;
      }
      
      th {
        font-size: 1.05rem;
        font-weight: 800;
        padding: 18px 12px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        letter-spacing: 0.5px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      td {
        font-size: 1.1rem;
        font-weight: 600;
      }
      
      [data-theme="dark"] th {
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 71, 87, 0.25);
      }
      
      table .btn {
        padding: 12px 18px;
        font-size: 13px;
        min-width: 100px;
      }
      
      table .actions .flex {
        gap: 10px;
      }
      
      table td:last-child {
        padding: 14px 10px;
        width: 9%;
      }
      
      .stat {
        min-width: 250px;
        padding: 24px;
      }
      
      .stat h3 {
        font-size: 24px;
      }
      
      .stat p {
        font-size: 14px;
      }
      
      header {
        padding: 28px 40px;
      }
      
      .card {
        padding: 28px 36px;
      }
      
      .filters {
        gap: 20px;
      }
      
      .search {
        flex: 1 1 220px;
        min-width: 170px;
        padding: 14px 18px;
      }
    }
    
    @media (max-width:1200px){
      table{font-size:11px;}
      th, td{padding:4px 2px;}
      
      th {
        font-size: 0.85rem;
        font-weight: 800;
        padding: 10px 6px;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        letter-spacing: 0.3px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      td {
        font-size: 0.95rem;
        font-weight: 600;
      }
      
      [data-theme="dark"] th {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8), 0 0 6px rgba(255, 71, 87, 0.25);
      }
      td:nth-child(1){min-width:140px; max-width:160px;}
      td:nth-child(2), td:nth-child(3){min-width:70px; max-width:90px;}
      td:nth-child(4){min-width:70px; max-width:100px;}
      td:nth-child(5){min-width:70px; max-width:90px;}
      td:nth-child(6){min-width:100px; max-width:120px;}
      td:nth-child(7){min-width:100px; max-width:120px;}
      td:nth-child(8){min-width:60px; max-width:80px;}
      td:nth-child(9){min-width:80px; max-width:100px;}
      td:nth-child(10){min-width:60px; max-width:80px;}
      td:nth-child(11){min-width:80px; max-width:100px;}
      td:nth-child(12){min-width:60px; max-width:80px;}
      td:nth-child(13){min-width:80px; max-width:100px;}
      td:nth-child(14){min-width:100px; max-width:120px;}
      .btn{font-size:11px; padding:6px 10px;}
      .badge{font-size:9px; padding:2px 4px;}
    }
    
    @media (max-width: 768px) {
      table {
        font-size: 9px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      
      thead, tbody, tr {
        display: block;
      }
      
      thead {
        position: sticky;
        top: 0;
        z-index: 10;
      }
      
      tr {
        display: table;
        width: 100%;
        table-layout: fixed;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
      
      th, td {
        padding: 6px 4px;
        font-size: 9px;
        text-align: center;
        border-right: 1px solid rgba(255,255,255,0.05);
      }
      
      th {
        background: var(--table-header);
        color: white;
        font-weight: 900;
        font-size: 0.75rem;
        padding: 10px 6px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        letter-spacing: 0.4px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      [data-theme="dark"] th {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(255, 71, 87, 0.3);
      }
      
      td:nth-child(1) {
        min-width: 120px;
        max-width: 150px;
        text-align: right;
        padding-right: 8px;
      }
      
      td:nth-child(2), td:nth-child(3) {
        min-width: 70px;
        max-width: 90px;
      }
      
      td:nth-child(4) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(5) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(6) {
        min-width: 80px;
        max-width: 100px;
      }
      
      td:nth-child(7) {
        min-width: 70px;
        max-width: 90px;
      }
      
      td:nth-child(8) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(9) {
        min-width: 70px;
        max-width: 90px;
      }
      
      td:nth-child(10) {
        min-width: 80px;
        max-width: 100px;
      }
      
      td:nth-child(11) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(12) {
        min-width: 80px;
        max-width: 100px;
      }
      
      td:nth-child(13) {
        min-width: 40px;
        max-width: 60px;
      }
      
      td:nth-child(14) {
        min-width: 80px;
        max-width: 100px;
      }
      
      .btn {
        font-size: 8px;
        padding: 4px 6px;
        min-height: 24px;
      }
      
      .badge {
        font-size: 7px;
        padding: 2px 4px;
      }
      
      .modal .box {
        width: 95%;
        max-width: 600px;
        padding: 16px;
        margin: 10px;
        max-height: 85vh;
      }
      
      .modal h3 {
        font-size: 16px;
        margin-bottom: 12px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .form-row .form-group {
        flex: 1;
        min-width: 100%;
      }
      
      .actions {
        flex-direction: column;
        gap: 8px;
      }
      
      .actions .btn {
        width: 100%;
        min-width: auto;
      }
    }
    
    @media (max-width: 600px) {
      body {
        padding: 8px;
      }
      
      .container {
        padding: 0;
      }
      
      header {
        padding: 12px;
        margin-bottom: 16px;
      }
      
      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }
      
      .lead {
        font-size: 12px;
      }
      
      .card {
        padding: 12px;
        margin-bottom: 12px;
      }
      
      .stats {
        gap: 8px;
      }
      
      .stat {
        padding: 12px;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      
      .stat h3 {
        font-size: 18px;
        margin-bottom: 4px;
      }
      
      .stat p {
        font-size: 10px;
        margin: 0;
      }
      
      table {
        font-size: 8px;
        border-radius: 8px;
      }
      
      th, td {
        padding: 4px 2px;
        font-size: 8px;
        line-height: 1.1;
      }
      
      th {
        font-size: 7px;
        padding: 6px 2px;
      }
      
      td:nth-child(1) {
        min-width: 100px;
        max-width: 120px;
        font-size: 8px;
      }
      
      td:nth-child(1) strong {
        font-size: 9px;
        line-height: 1.1;
      }
      
      td:nth-child(1) small {
        font-size: 6px;
        margin-top: 1px;
      }
      
      td:nth-child(2), td:nth-child(3) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(4) {
        min-width: 50px;
        max-width: 70px;
      }
      
      td:nth-child(5) {
        min-width: 50px;
        max-width: 70px;
      }
      
      td:nth-child(6) {
        min-width: 70px;
        max-width: 90px;
      }
      
      td:nth-child(7) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(8) {
        min-width: 50px;
        max-width: 70px;
      }
      
      td:nth-child(9) {
        min-width: 60px;
        max-width: 80px;
      }
      
      td:nth-child(10) {
        min-width: 70px;
        max-width: 90px;
      }
      
      td:nth-child(11) {
        min-width: 50px;
        max-width: 70px;
      }
      
      td:nth-child(12) {
        min-width: 70px;
        max-width: 90px;
      }
      
      td:nth-child(13) {
        min-width: 35px;
        max-width: 55px;
      }
      
      td:nth-child(14) {
        min-width: 70px;
        max-width: 90px;
      }
      
      .btn {
        font-size: 7px;
        padding: 3px 5px;
        min-height: 20px;
        border-radius: 4px;
      }
      
      .btn.tiny {
        font-size: 6px;
        padding: 2px 4px;
        min-height: 18px;
      }
      
      .badge {
        font-size: 6px;
        padding: 1px 3px;
        border-radius: 4px;
      }
      
      .modal .box {
        width: 98%;
        max-width: 500px;
        padding: 12px;
        margin: 5px;
        max-height: 85vh;
        overflow-y: auto;
      }
      
      .modal {
        padding: 8px;
        align-items: flex-start !important;
      }
      
      .modal h3 {
        font-size: 14px;
        margin-bottom: 10px;
        padding-bottom: 6px;
      }
      
      .form-group {
        margin-bottom: 12px;
      }
      
      .form-group label {
        font-size: 12px;
        margin-bottom: 4px;
      }
      
      input[type="text"], 
      input[type="number"], 
      input[type="date"], 
      select {
        font-size: 12px;
        padding: 8px 10px;
        border-radius: 6px;
      }
      
      .actions {
        margin-top: 16px;
        padding-top: 12px;
      }
      
      .chart-card {
        min-height: 180px;
        padding: 12px;
      }
      
      .user-info {
        position: relative;
        top: auto;
        left: auto;
        right: auto;
        margin: 0 0 16px 0;
        padding: 8px 12px;
        width: 100%;
        box-sizing: border-box;
      }
      
      .user-avatar {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
      
      .user-details h3 {
        font-size: 11px;
      }
      
      .user-details p {
        font-size: 9px;
      }
      
      .logout-btn {
        padding: 5px;
        font-size: 9px;
        min-height: 22px;
        min-width: 22px;
      }
    }

    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      pointer-events: auto;
    }
    
    .auth-overlay[style*="display: none"] {
      pointer-events: none !important;
    }
    
    .auth-container {
      width: 100%;
      max-width: 400px;
      background: var(--card-bg);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 16px 48px var(--shadow-md);
      border: 1px solid var(--border-color);
      position: relative;
      overflow: visible;
      z-index: 1;
    }
    
    .auth-container::before {
      display: none;
    }
    
    .auth-logo {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .auth-logo h1 {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .auth-logo p {
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }
    
    .auth-form-group {
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }
    
    .auth-form-group label {
      display: block;
      margin-bottom: 8px;
      color: #94a3b8;
      font-weight: 600;
      font-size: 14px;
    }
    
    .auth-form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      color: inherit;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      pointer-events: auto !important;
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      cursor: text !important;
      opacity: 1 !important;
      z-index: 10 !important;
      position: relative !important;
    }
    
    .auth-form-group input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.1);
      background: rgba(255,255,255,0.05);
    }
    
    .auth-form-group input:not(:disabled) {
      cursor: text;
      pointer-events: auto;
    }
    
    .auth-form-group input:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .auth-form-group input::placeholder {
      color: #94a3b8;
    }
    
    .auth-form-group input[type="text"],
    .auth-form-group input[type="password"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: #e2e8f0;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      padding: 12px 16px;
      width: 100%;
      box-sizing: border-box;
      pointer-events: auto;
      user-select: text;
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      cursor: text;
    }
    
    .auth-form-group input[type="text"]:focus,
    .auth-form-group input[type="password"]:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.1);
      background-color: rgba(255,255,255,0.05);
    }
    
    .auth-btn {
      width: 100%;
      background: #6366f1;
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .auth-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .auth-btn:hover::before {
      left: 100%;
    }
    
    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      background: #5b5bd6;
    }
    
    .auth-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .auth-error {
      background: rgba(244,63,94,0.1);
      border: 1px solid rgba(244,63,94,0.2);
      color: #f43f5e;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .auth-success {
      background: rgba(16,185,129,0.1);
      border: 1px solid rgba(16,185,129,0.2);
      color: #10b981;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .auth-loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    
    .auth-loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .auth-demo {
      background: rgba(99,102,241,0.1);
      border: 1px solid rgba(99,102,241,0.2);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 12px;
    }
    
    .auth-demo h4 {
      color: #6366f1;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .auth-demo p {
      margin: 4px 0;
      color: #94a3b8;
    }
    
    .auth-demo strong {
      color: #fff;
    }
    
    .auth-footer {
      text-align: center;
      margin-top: 30px;
      color: #94a3b8;
      font-size: 12px;
    }
    
    .user-info {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: rgba(0,0,0,0.7);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .user-info:hover {
      background: rgba(0,0,0,0.8);
      border-color: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    }
    
    :root:not([data-theme="dark"]) .user-info {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    :root:not([data-theme="dark"]) .user-info:hover {
      background: rgba(255,255,255,0.95);
      border-color: rgba(0,0,0,0.2);
      box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #a78bfa);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(99,102,241,0.3);
      border: 2px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }
    .user-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(99,102,241,0.4);
    }
    
    :root:not([data-theme="dark"]) .user-avatar {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
      color: white;
      box-shadow: 0 2px 8px rgba(128,28,50,0.3);
      border: 2px solid rgba(128,28,50,0.3);
    }
    
    :root:not([data-theme="dark"]) .user-avatar:hover {
      box-shadow: 0 4px 12px rgba(128,28,50,0.4);
      border-color: rgba(128,28,50,0.5);
    }
    
    .user-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .user-details h3 {
      font-size: 13px;
      margin: 0;
      font-weight: 600;
      color: #fff;
      line-height: 1.2;
    }
    
    .user-details p {
      font-size: 11px;
      color: #94a3b8;
      margin: 0;
      font-weight: 500;
      line-height: 1.2;
    }
    
    :root:not([data-theme="dark"]) .user-details h3 {
      color: #333333;
      font-weight: 700;
      text-shadow: none;
    }
    
    :root:not([data-theme="dark"]) .user-details p {
      color: #666666;
      font-weight: 600;
    }
    
    .logout-btn {
      background: linear-gradient(135deg, #f43f5e, #dc2626);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(244,63,94,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 28px;
      min-width: 28px;
    }
    
    .logout-btn:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 4px 12px rgba(244,63,94,0.4);
    }
    
    .logout-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    :root:not([data-theme="dark"]) .logout-btn {
      background: linear-gradient(135deg, #801c32, #a52d45);
      color: white;
      box-shadow: 0 2px 6px rgba(128,28,50,0.3);
    }
    
    :root:not([data-theme="dark"]) .logout-btn:hover {
      background: linear-gradient(135deg, #a52d45, #801c32);
      box-shadow: 0 4px 12px rgba(128,28,50,0.4);
    }
    
    @media (max-width: 768px) {
      .user-info {
        top: 10px;
        left: 10px;
        right: 10px;
        padding: 6px 12px;
        gap: 8px;
      }
      
      .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
      
      .user-details h3 {
        font-size: 12px;
      }
      
      .user-details p {
        font-size: 10px;
      }
      
      .logout-btn {
        padding: 6px;
        font-size: 10px;
        min-height: 24px;
        min-width: 24px;
      }
    }
    
    .permission-restricted {
      opacity: 0.5;
      pointer-events: none;
    }
    
    #authUsername, #authPassword {
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background-color: rgba(255,255,255,0.08) !important;
      border: 1px solid rgba(255,255,255,0.15) !important;
      color: #e2e8f0 !important;
      font-family: inherit !important;
      font-size: 14px !important;
      line-height: 1.5 !important;
      padding: 12px 16px !important;
      width: 100% !important;
      box-sizing: border-box !important;
      pointer-events: auto !important;
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      cursor: text !important;
      z-index: 10 !important;
      position: relative !important;
      opacity: 1 !important;
      display: block !important;
      visibility: visible !important;
    }
    
    #authUsername:focus, #authPassword:focus {
      outline: none !important;
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.1) !important;
      background-color: rgba(255,255,255,0.05) !important;
    }
    
    #authUsername:hover, #authPassword:hover {
      border-color: rgba(255,255,255,0.3) !important;
    }
    
    .auth-form-group input[type="text"]:not(:disabled),
    .auth-form-group input[type="password"]:not(:disabled) {
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      background-color: rgba(255,255,255,0.08) !important;
      border: 1px solid rgba(255,255,255,0.15) !important;
      color: #e2e8f0 !important;
      font-family: inherit !important;
      font-size: 14px !important;
      line-height: 1.5 !important;
      padding: 12px 16px !important;
      width: 100% !important;
      box-sizing: border-box !important;
      pointer-events: auto !important;
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      cursor: text !important;
      z-index: 10 !important;
      position: relative !important;
      opacity: 1 !important;
      display: block !important;
      visibility: visible !important;
      -webkit-touch-callout: text !important;
      -webkit-tap-highlight-color: rgba(99,102,241,0.2) !important;
    }
    
    .auth-form-group input[type="text"]:not(:disabled):focus,
    .auth-form-group input[type="password"]:not(:disabled):focus {
      outline: none !important;
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.1) !important;
      background-color: rgba(255,255,255,0.05) !important;
    }
    
    .auth-form-group input[type="text"]:not(:disabled):hover,
    .auth-form-group input[type="password"]:not(:disabled):hover {
      border-color: rgba(255,255,255,0.3) !important;
    }
    
    @media (max-width: 480px) {
      .auth-container {
        padding: 30px 20px;
      }
      
      .auth-logo h1 {
        font-size: 24px;
      }
    }
    
    .notification-badge {
      position: relative;
    }
    
    .notification-badge::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: var(--danger);
      border-radius: 50%;
      border: 2px solid var(--card-bg);
      display: none;
    }
    
    .notification-badge.has-notifications::after {
      display: block;
    }
    
    .notification-item {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }
    
    .notification-item:hover {
      background: var(--bg-tertiary);
    }
    
    .notification-item.unread {
      background: rgba(59, 130, 246, 0.1);
    }
    
    
    .phone-link {
      color: var(--info);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .phone-link:hover {
      text-decoration: underline;
    }
    
    .agent-group-select {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px;
      background: var(--input-bg);
    }
    
    .agent-group-select::-webkit-scrollbar {
      width: 8px;
    }
    
    .agent-group-select::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }
    
    .agent-group-select::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    .agent-group-select::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }
    
    .agent-group-item {
      padding: 10px 12px;
      margin: 4px 0;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 6px;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .agent-group-item:hover {
      background: var(--bg-tertiary);
    }
    
    .agent-group-item.selected {
      background: var(--primary-color);
      color: white;
    }
    
    .time-input-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .time-input-group input {
      flex: 1;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-container">
      <div class="auth-logo">
        <h1>قسم العمليات التجارية </h1>
        <p> متابعة نمو الوكلاء</p>
      </div>

      <div id="authError" class="auth-error"></div>
      <div id="authSuccess" class="auth-success"></div>

  

      <form id="authForm">
        <div class="auth-form-group">
          <label for="authUsername">اسم المستخدم</label>
          <input type="text" id="authUsername" name="username" placeholder="أدخل اسم المستخدم" required autocomplete="username" spellcheck="false">
        </div>

        <div class="auth-form-group">
          <label for="authPassword">كلمة المرور</label>
          <input type="password" id="authPassword" name="password" placeholder="أدخل كلمة المرور" required autocomplete="current-password" spellcheck="false">
        </div>

        <button type="submit" class="auth-btn" id="authLoginBtn">
          تسجيل الدخول
        </button>
      </form>

      <div id="authLoading" class="auth-loading">
        <div class="spinner"></div>
        <p>جاري تسجيل الدخول...</p>
      </div>

      <div class="auth-footer">
        <p>© 2025 عراق سيل   </p>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="header-left">
        <div class="header-content">
          <h1>متابعة الوكلاء</h1>
          <p class="lead">قسم العمليات التجارية لشركة عراق سيل</p>
          <div id="connectionStatus" style="font-size: 12px; margin-top: 4px; padding: 2px 6px; border-radius: 4px; display: inline-block; position: relative;">
            <span id="statusIcon">🔄</span>
            <span id="statusText">جاري الاتصال...</span>
          </div>
          <div id="sidebarUser" class="sidebar-user-name" style="background: linear-gradient(135deg, #801c32, #a52d45); color: white; padding: 14px 18px; border-radius: 12px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(128, 28, 50, 0.4); text-align: center; letter-spacing: 0.5px; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; cursor: pointer; user-select: none; -webkit-user-select: none; transition: all 0.3s ease; width: 100%; box-sizing: border-box; margin-top: 12px;" onclick="toggleUserContactPopup(event)" onmouseenter="if(!document.getElementById('userContactPopup').classList.contains('show')) { this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 16px rgba(128, 28, 50, 0.5)'; }" onmouseleave="if(!document.getElementById('userContactPopup').classList.contains('show')) { this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(128, 28, 50, 0.4)'; }">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
              <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 1.3rem;"></span>
                <span style="font-size: 1.05rem; font-weight: 700;">Ameer Helwas</span>
              </div>
              <div style="font-size: 0.75rem; opacity: 0.9; font-weight: 500;"></div>
            </div>
            <div id="userContactPopup" class="user-contact-popup" onmouseenter="event.stopPropagation();" onmouseleave="event.stopPropagation();" onclick="event.stopPropagation();">
              <div class="user-contact-item">
                <span class="user-contact-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#0078d4"/>
                  </svg>
                </span>
                <a href="mailto:ameeralgaraawi@hotmail.com">Email</a>
              </div>
              <div class="user-contact-item">
                <span class="user-contact-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" fill="#E4405F"/>
                  </svg>
                </span>
                <a href="https://instagram.com/ameer_7elwas" target="_blank">instagram</a>
              </div>
              <div class="user-contact-item">
                <span class="user-contact-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z" fill="#0088cc"/>
                  </svg>
                </span>
                <a href="https://t.me/ameer_7elwas" target="_blank">Telegram</a>
              </div>
              <div class="user-contact-item">
                <span class="user-contact-icon">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.98 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="#25D366"/>
                  </svg>
                </span>
                <a href="https://wa.me/9647701024143" target="_blank">واتساب</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="controls">
        <div class="controls-group">
          <button class="btn secondary" id="btnAddAgent">
            <span class="icon">➕</span>
            إضافة وكيل
          </button>
          <button class="btn warn" id="btnWeeklyReport">
            <span class="icon">📊</span>
            تقرير
          </button>
          <button class="btn secondary" id="btnNotifications">
            <span class="icon"></span>
            إرسال تبليغ
          </button>
          <button class="btn secondary" id="btnTheme">
            <span class="icon">☀️</span>
            
          </button>
        </div>
      </div>
      
      <div class="header-right">
        <button class="btn secondary" id="btnUserManagement" style="display: none;">
          <span class="icon">👥</span>
           المستخدمين
        </button>
        <div class="user-info" id="userInfo" style="display: none;">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-details">
            <h3 id="userName">مدير النظام</h3>
            <p id="userRole">مدير</p>
          </div>
          <button class="logout-btn" id="logoutBtn">
            <span class="icon">⏻</span>
          </button>
        </div>
      </div>
    </header>

    <!-- بطاقات الإحصائيات -->
    <section class="card" style="padding: 20px; margin-bottom: 20px;">
      <div class="stats">
        <div class="stat">
          <h3 id="totalActive">0</h3>
          <p>المستخدمون النشطون</p>
        </div>
        <div class="stat">
          <h3 id="totalUsers">0</h3>
          <p>إجمالي المستخدمين</p>
        </div>
        <div class="stat">
          <h3 id="totalAgents">0</h3>
          <p>الوكلاء</p>
        </div>
        <div class="stat">
          <h3 id="overallActivation">0%</h3>
          <p>معدل النمو العام</p>
        </div>
      </div>
    </section>

    <!-- حقول الفلترة -->
    <section class="card" style="padding: 20px; margin-bottom: 20px;">
      <div class="filters">
        <select id="phaseFilter" class="search">
          <option value="">🔍 كل المراحل</option>
          <option value="OLD">المشروع القديم</option>
          <option value="PHASE2">المرحلة الثانية</option>
          <option value="PHASE3">المرحلة الثالثة</option>
        </select>
        <input id="searchBox" class="search" placeholder="🔍 بحث عن وكيل..." />
        <select id="sortBy" class="search">
          <option value="name">ترتيب حسب الاسم</option>
          <option value="total_users_desc">📊 أعلى إجمالي</option>
          <option value="active_desc">أعلى نشط</option>
          <option value="deficit_desc">أعلى عجز</option>
        </select>
      </div>
    </section>

    <section class="card" style="padding: 0; background: transparent; border: none; box-shadow: none;">
      <div style="overflow-x:auto; overflow-y:visible; width:100%; padding: 0;">
        <table id="agentsTable" style="min-width:100%; width:100%;">
          <thead>
            <tr>
              <th>الوكيل</th>
              <th>رقم الهاتف</th>
              <th>تاريخ العقد</th>
              <th>تاريخ اليوم</th>
              <th>FDT</th>
              <th> اللوحة</th>
              <th>إجمالي المستخدمين</th>
              <th>النشط الحالي</th>
              <th>النمو الأسبوعي</th>
              <th>معدل التفعيل</th>
              <th>النسبة المطلوبة</th>
              <th>المطلوب للوصول</th>
              <th>نسبة العجز</th>
              <th>عجز المستخدمين</th>
              <th>الحالة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="chart-row">
        <div class="chart-card">
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-card">
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </section>

    <footer>
      <div class="small"</div>
    </footer>
  </div>

  <div id="modalEdit" class="modal">
    <div class="box">
      <h3 id="modalTitle">تحديث المستخدمين النشطين</h3>
      <div>
        <label>اسم الوكيل</label>
        <input type="text" id="editName" readonly />
      </div>
      <div>
        <label>إجمالي المستخدمين</label>
        <input type="number" id="editTotal" readonly />
      </div>
      <div>
        <label>النشط الحالي </label>
        <input type="number" id="editActive" />
      </div>
      <div class="actions">
        <button class="btn secondary" id="closeModal">
          <span class="icon">❌</span>
          إلغاء
        </button>
        <button class="btn" id="saveActive">
          <span class="icon">💾</span>
          حفظ
        </button>
      </div>
    </div>
  </div>

  <div id="modalEditInfo" class="modal">
    <div class="box">
      <h3>تعديل معلومات الوكيل</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:200px;">
          <label>اسم الوكيل</label>
          <input type="text" id="info_name" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>ملاحظة </label>
          <input type="text" id="info_note" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label> اللوحة</label>
          <input type="text" id="info_board" />
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:160px;">
          <label>تاريخ العقد</label>
          <input type="date" id="info_date" />
        </div>
        <div style="flex:1; min-width:160px;">
          <label>المرحلة</label>
          <select id="info_phase">
            <option value="OLD">OLD</option>
            <option value="PHASE2">PHASE2</option>
            <option value="PHASE3">PHASE3</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:200px;">
          <label>ITPC Site</label>
          <input type="text" id="info_site" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>FDT</label>
          <input type="text" id="info_fdt" />
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:160px;">
          <label>أرقام الهواتف (مفصولة بفواصل)</label>
          <input type="text" id="info_phone" placeholder="07901234567, 07501234567" />
          <small style="color:var(--text-tertiary); font-size:11px;"</small>
        </div>
        <div style="flex:1; min-width:160px;">
          <label>إجمالي المستخدمين</label>
          <input type="number" id="info_total" />
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="closeInfoModal">
          <span class="icon">❌</span>
          إلغاء
        </button>
        <button class="btn warn" id="deleteFromInfoModal">
          <span class="icon">🗑️</span>
          حذف
        </button>
        <button class="btn" id="saveInfo">
          <span class="icon">💾</span>
          حفظ
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Modal -->
  <div id="modalNotifications" class="modal">
    <div class="box" style="max-width: 600px;">
      <h3>إرسال تبليغ للوكلاء</h3>
      
      <!-- الخطوة 1: اختيار الوكلاء -->
      <div style="margin-bottom: 20px;">
        <label style="display:block; margin-bottom: 8px; font-weight: 600;">الوكلاء</label>
        <select id="notificationGroup" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary);" required>
          <option value="">-- اختر ITPC Site --</option>
        </select>
        <div id="agentGroupsList" class="agent-group-select" style="max-height: 200px; min-height: 100px; margin-top: 8px;"></div>
        <div style="margin-top: 8px; text-align: center;">
          <span id="selectedCount" style="color:var(--primary-color); font-weight:600;">0 وكيل محدد</span>
        </div>
      </div>

      <!-- الخطوة 2: الرسالة -->
      <div style="margin-bottom: 20px;">
        <label style="display:block; margin-bottom: 8px; font-weight: 600;">الرسالة</label>
        <textarea id="notificationMessage" rows="5" placeholder="اكتب الرسالة هنا..." style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text-primary); font-family:inherit; resize:vertical;"></textarea>
      </div>

      <!-- شريط التقدم -->
      <div id="sendingProgress" style="display:none; margin-top:16px; padding:16px; background:var(--bg-tertiary); border-radius:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <span id="progressText" style="font-weight:600;">جاري الإرسال...</span>
          <button class="btn small danger" id="stopSending" style="display:none;">إيقاف</button>
        </div>
        <div style="width:100%; height:8px; background:var(--border-color); border-radius:4px; overflow:hidden;">
          <div id="progressBar" style="height:100%; background:var(--primary-color); width:0%; transition:width 0.3s ease;"></div>
        </div>
        <div id="progressDetails" style="margin-top:8px; font-size:12px; color:var(--text-secondary);"></div>
      </div>

      <!-- الأزرار -->
      <div class="actions">
        <button class="btn secondary" id="closeNotificationsModal">إلغاء</button>
        <button class="btn" id="sendNotification">إرسال</button>
      </div>
    </div>
  </div>

  <div id="modalAdd" class="modal">
    <div class="box">
      <h3>إضافة وكيل جديد</h3>
      <div>
        <label>اسم الوكيل</label>
        <input type="text" id="new_name" />
      </div>
      <div style="display:flex; gap:8px;">
        <div style="flex:1;">
          <label>تاريخ العقد </label>
          <input type="date" id="new_date" />
        </div>
        <div style="flex:1;">
          <label>المرحلة</label>
          <select id="new_phase">
            <option value="OLD">OLD</option>
            <option value="PHASE2">PHASE2</option>
            <option value="PHASE3">PHASE3</option>
          </select>
        </div>
      </div>
      <div>
        <label>ITPC Site</label>
        <input type="text" id="new_site" />
      </div>
      <div>
        <label>FDT</label>
        <input type="text" id="new_fdt" />
      </div>
      <div>
        <label> اللوحة</label>
        <input type="text" id="new_board" />
      </div>
      <div>
        <label>ملاحظة أسفل الاسم (اختياري)</label>
        <input type="text" id="new_note" placeholder="" />
      </div>
      <div style="display:flex; gap:8px;">
        <div style="flex:1;">
          <label>أرقام الهواتف (مفصولة بفواصل)</label>
          <input type="text" id="new_phone" placeholder="07901234567, 07501234567" />
          <small style="color:var(--text-tertiary); font-size:11px;">يمكنك إدخال أكثر من رقم مفصول بفواصل</small>
        </div>
        <div style="flex:1;">
          <label>إجمالي المستخدمين</label>
          <input type="number" id="new_total" />
        </div>
        <div style="flex:1;">
          <label>المستخدمون النشطون</label>
          <input type="number" id="new_active" />
        </div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="closeAddModal">
          <span class="icon">❌</span>
          إلغاء
        </button>
        <button class="btn" id="saveNewAgent">
          <span class="icon">➕</span>
          إضافة
        </button>
      </div>
    </div>
  </div>

  <script>
    class AuthSystem {
      constructor() {
        this.currentUser = null;
        this.permissions = {
          admin: ['view', 'add', 'edit', 'delete', 'manage_users', 'export', 'reports'],
          supervisor: ['view', 'add', 'edit', 'export', 'reports'],
          viewer: ['view', 'export']
        };
        this.init();
      }

      init() {
        // Ensure overlay is properly initialized
        const overlay = document.getElementById('authOverlay');
        if (overlay) {
          // Set initial state based on whether user is logged in
          const session = localStorage.getItem('userSession');
          if (!session) {
            overlay.style.display = 'flex';
            overlay.style.pointerEvents = 'auto';
          } else {
            overlay.style.display = 'none';
            overlay.style.pointerEvents = 'none';
          }
        }
        
        this.loadCurrentUser();
        this.checkAuthentication();
        this.setupEventListeners();
        
        // Ensure inputs are editable after initialization
        setTimeout(() => {
          const overlay = document.getElementById('authOverlay');
          if (overlay && overlay.style.display === 'none') {
            ensureAllInputsEditable();
          } else {
            ensureInputFieldsEditable();
          }
        }, 100);
      }

      loadCurrentUser() {
        const session = localStorage.getItem('userSession');
        if (session) {
          try {
            this.currentUser = JSON.parse(session);
            const loginTime = new Date(this.currentUser.loginTime);
            const now = new Date();
            const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
            
            if (hoursDiff >= 24) {
              this.logout();
              return;
            }
            this.hideAuthOverlay();
            this.updateUI();
          } catch (error) {
            this.logout();
          }
        }
      }

      checkAuthentication() {
        if (!this.currentUser) {
          this.showAuthOverlay();
          return false;
        }
        return true;
      }

      hasPermission(permission) {
        if (!this.currentUser) {
          return false;
        }
        const result = this.permissions[this.currentUser.role]?.includes(permission) || false;
        return result;
      }

      canView() { return this.hasPermission('view'); }
      canAdd() { return this.hasPermission('add'); }
      canEdit() { 
        const result = this.hasPermission('edit');
        return result;
      }
      canDelete() { return this.hasPermission('delete'); }
      canManageUsers() { return this.hasPermission('manage_users'); }
      canExport() { return this.hasPermission('export'); }
      canGenerateReports() { return this.hasPermission('reports'); }

      getCurrentUser() { return this.currentUser; }
      getUserRole() { return this.currentUser?.role || 'viewer'; }
      getUserName() { return this.currentUser?.name || 'مستخدم'; }

      getRoleName(role) {
        const roles = {
          'admin': 'مدير',
          'supervisor': 'مشرف',
          'viewer': 'مشاهد'
        };
        return roles[role] || role;
      }

      showAuthOverlay() {
        const overlay = document.getElementById('authOverlay');
        overlay.style.display = 'flex';
        overlay.style.pointerEvents = 'auto';
        document.querySelector('.container').style.display = 'none';
        // Ensure auth inputs are editable when overlay is shown
        setTimeout(() => {
          ensureInputFieldsEditable();
          // إعادة التأكد بعد فترة قصيرة
          setTimeout(() => ensureInputFieldsEditable(), 200);
        }, 50);
      }

      hideAuthOverlay() {
        const overlay = document.getElementById('authOverlay');
        overlay.style.display = 'none';
        overlay.style.pointerEvents = 'none';
        const container = document.querySelector('.container');
        if (container) {
          container.style.display = 'block';
        }
        // Ensure all inputs in the main container are editable
        setTimeout(() => ensureAllInputsEditable(), 50);
      }

      showError(message) {
        const errorEl = document.getElementById('authError');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        document.getElementById('authSuccess').style.display = 'none';
      }

      showSuccess(message) {
        const successEl = document.getElementById('authSuccess');
        successEl.textContent = message;
        successEl.style.display = 'block';
        document.getElementById('authError').style.display = 'none';
      }

      hideMessages() {
        document.getElementById('authError').style.display = 'none';
        document.getElementById('authSuccess').style.display = 'none';
      }

      showLoading() {
        document.getElementById('authLoading').style.display = 'block';
        document.getElementById('authLoginBtn').disabled = true;
        document.getElementById('authLoginBtn').textContent = 'جاري تسجيل الدخول...';
      }

      hideLoading() {
        document.getElementById('authLoading').style.display = 'none';
        document.getElementById('authLoginBtn').disabled = false;
        document.getElementById('authLoginBtn').textContent = 'تسجيل الدخول';
      }

      async validateUser(username, password) {
        try {
          const supabase = getSupabaseClient();
          if (supabase) {
            const { data, error } = await supabase
              .from('users')
              .select('*')
              .eq('username', username)
              .eq('password_hash', password)
              .eq('status', 'active')
              .single();

            if (error) {
              console.error('Database validation error:', error);
              return this.validateUserFromLocalStorage(username, password);
            }

            if (data) {
              return {
                success: true,
                user: {
                  id: data.id,
                  username: data.username,
                  role: data.role,
                  name: data.full_name || data.username
                }
              };
            }
          }

          return this.validateUserFromLocalStorage(username, password);
        } catch (error) {
          console.error('User validation error:', error);
          return this.validateUserFromLocalStorage(username, password);
        }
      }

      validateUserFromLocalStorage(username, password) {
        try {
          const savedUsers = localStorage.getItem('systemUsers');
          if (savedUsers) {
            const users = JSON.parse(savedUsers);
            const user = users.find(u => 
              u.username === username && 
              u.password_hash === password && 
              u.status === 'active'
            );
            
            if (user) {
              return {
                success: true,
                user: {
                  id: user.id,
                  username: user.username,
                  role: user.role,
                  name: user.full_name || user.username
                }
              };
            }
          }

          

          const user = demoUsers[username];
          if (user && user.password === password) {
            return {
              success: true,
              user: {
                id: username,
                username: username,
                role: user.role,
                name: user.name
              }
            };
          }

          return { success: false, message: 'اسم المستخدم أو كلمة المرور غير صحيحة' };
        } catch (error) {
          console.error('Local storage validation error:', error);
          return { success: false, message: 'خطأ في التحقق من بيانات المستخدم' };
        }
      }

      saveUserSession(user) {
        const session = {
          username: user.username,
          role: user.role,
          name: user.name,
          loginTime: new Date().toISOString()
        };
        localStorage.setItem('userSession', JSON.stringify(session));
      }

      updateUI() {
        if (!this.currentUser) {
          
          return;
        }

        

        document.getElementById('userName').textContent = this.getUserName();
        document.getElementById('userRole').textContent = this.getRoleName(this.getUserRole());
        document.getElementById('userAvatar').textContent = this.getUserName().charAt(0);
        document.getElementById('userInfo').style.display = 'flex';

        this.updateElementVisibility();
        
        this.updateTableActionButtons();
      }

      updateTableActionButtons() {
        const canEdit = this.canEdit();
        const canDelete = this.canDelete();
        
        
        
        const editButtons = document.querySelectorAll('button[data-action="edit"]');
        const editInfoButtons = document.querySelectorAll('button[data-action="edit-info"]');
        const deleteButtons = document.querySelectorAll('button[data-action="delete"]');
        
        
        
        editButtons.forEach(btn => {
          btn.style.display = canEdit ? 'inline-flex' : 'none';
          
        });
        
        editInfoButtons.forEach(btn => {
          btn.style.display = canEdit ? 'inline-flex' : 'none';
          
        });
        
        deleteButtons.forEach(btn => {
          btn.style.display = canDelete ? 'inline-flex' : 'none';
          
        });
      }

      updateElementVisibility() {
        const addButton = document.getElementById('btnAddAgent');
        if (addButton) {
          addButton.style.display = this.canAdd() ? 'inline-flex' : 'none';
        }

        const exportButton = document.getElementById('btnWeeklyReport');
        if (exportButton) {
          exportButton.style.display = this.canExport() ? 'inline-flex' : 'none';
        }

        const userMgmtButton = document.getElementById('btnUserManagement');
        if (userMgmtButton) {
          userMgmtButton.style.display = this.canManageUsers() ? 'inline-flex' : 'none';
        }

        if (this.getUserRole() === 'viewer') {
          const inputs = document.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            input.disabled = true;
          });
        }
      }

      setupEventListeners() {
        document.getElementById('authForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
          this.logout();
        });

        document.getElementById('btnUserManagement').addEventListener('click', () => {
          window.open('user_management_database.html', '_blank');
        });

        const usernameInput = document.getElementById('authUsername');
        const passwordInput = document.getElementById('authPassword');
        
        if (usernameInput) {
          usernameInput.addEventListener('focus', () => {
            usernameInput.style.pointerEvents = 'auto';
            usernameInput.style.userSelect = 'text';
          });
          
          usernameInput.addEventListener('click', () => {
            usernameInput.focus();
          });
        }
        
        if (passwordInput) {
          passwordInput.addEventListener('focus', () => {
            passwordInput.style.pointerEvents = 'auto';
            passwordInput.style.userSelect = 'text';
          });
          
          passwordInput.addEventListener('click', () => {
            passwordInput.focus();
          });
        }
      }

      async handleLogin() {
        this.hideMessages();

        const username = document.getElementById('authUsername').value.trim();
        const password = document.getElementById('authPassword').value;

        if (!username || !password) {
          this.showError('يرجى إدخال اسم المستخدم وكلمة المرور');
          return;
        }

        this.showLoading();

        try {
          await new Promise(resolve => setTimeout(resolve, 1000));

          const validation = await this.validateUser(username, password);
          
          
          if (validation.success) {
            this.currentUser = validation.user;
            
            this.saveUserSession(validation.user);
            
            this.showSuccess(`مرحباً ${validation.user.name}! تم تسجيل الدخول بنجاح`);
            
            setTimeout(() => {
              this.hideAuthOverlay();
              this.updateUI();
            }, 1500);
          } else {
            this.hideLoading();
            this.showError(validation.message);
          }
        } catch (error) {
          this.hideLoading();
          this.showError('حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى');
          console.error('Login error:', error);
        }
      }

      logout() {
        this.currentUser = null;
        localStorage.removeItem('userSession');
        this.showAuthOverlay();
        document.getElementById('authForm').reset();
        this.hideMessages();
        // إيقاف inactivity timer عند تسجيل الخروج
        if (window.stopInactivityTimer) {
          window.stopInactivityTimer();
        }
      }
    }

    const authSystem = new AuthSystem();
    
    // نظام تسجيل الخروج التلقائي عند عدم النشاط
    (function() {
      const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 دقيقة بالميلي ثانية
      let inactivityTimer = null;
      
      // دالة لإعادة تعيين الـ timer
      function resetInactivityTimer(event) {
        // تجاهل الأحداث من حقول تسجيل الدخول (لا نريد إعادة تعيين الـ timer عند الكتابة في حقول تسجيل الدخول)
        if (event && event.target) {
          const target = event.target;
          if (target.id === 'authUsername' || target.id === 'authPassword' || 
              target.closest('#authOverlay') || target.closest('.auth-container')) {
            // إذا كان المستخدم في شاشة تسجيل الدخول، لا نعيد تعيين الـ timer
            if (!authSystem.getCurrentUser()) {
              return;
            }
          }
        }
        
        // إلغاء الـ timer السابق إن وجد
        if (inactivityTimer) {
          clearTimeout(inactivityTimer);
        }
        
        // التحقق من أن المستخدم مسجل دخول
        if (!authSystem.getCurrentUser()) {
          return;
        }
        
        // إنشاء timer جديد
        inactivityTimer = setTimeout(() => {
          // التحقق مرة أخرى من أن المستخدم لا يزال مسجل دخول
          if (authSystem.getCurrentUser()) {
            console.log('تم تسجيل الخروج تلقائياً بسبب عدم النشاط');
            authSystem.logout();
            alert('تم تسجيل الخروج تلقائياً بسبب عدم النشاط لمدة 30 دقيقة');
          }
        }, INACTIVITY_TIMEOUT);
      }
      
      // دالة لإيقاف الـ timer (مثلاً عند تسجيل الخروج اليدوي)
      function stopInactivityTimer() {
        if (inactivityTimer) {
          clearTimeout(inactivityTimer);
          inactivityTimer = null;
        }
      }
      
      // أحداث لتتبع نشاط المستخدم
      const activityEvents = [
        'mousedown',
        'mousemove',
        'keypress',
        'scroll',
        'touchstart',
        'click'
      ];
      
      // إضافة مستمعات الأحداث مع استثناء حقول تسجيل الدخول
      activityEvents.forEach(event => {
        document.addEventListener(event, function(e) {
          // تجاهل الأحداث من حقول تسجيل الدخول والـ overlay
          if (e.target && (
            e.target.id === 'authUsername' || 
            e.target.id === 'authPassword' ||
            e.target.closest('#authOverlay') ||
            e.target.closest('.auth-container')
          )) {
            // إذا كان المستخدم في شاشة تسجيل الدخول، لا نعيد تعيين الـ timer
            if (!authSystem.getCurrentUser()) {
              return;
            }
          }
          resetInactivityTimer(e);
        }, true);
      });
      
      // إعادة تعيين الـ timer عند تحميل الصفحة إذا كان المستخدم مسجل دخول
      // استخدام setTimeout للتأكد من أن authSystem تم تهيئته بالكامل
      setTimeout(() => {
        if (authSystem.getCurrentUser()) {
          resetInactivityTimer();
        }
      }, 500);
      
      // إعادة تعيين الـ timer بعد تسجيل الدخول
      const originalHideAuthOverlay = authSystem.hideAuthOverlay.bind(authSystem);
      authSystem.hideAuthOverlay = function() {
        originalHideAuthOverlay();
        resetInactivityTimer();
      };
      
      // إيقاف الـ timer عند تسجيل الخروج
      const originalLogout = authSystem.logout.bind(authSystem);
      authSystem.logout = function() {
        stopInactivityTimer();
        originalLogout();
      };
      
      // حفظ المرجع في window للوصول إليه من أي مكان
      window.resetInactivityTimer = resetInactivityTimer;
      window.stopInactivityTimer = stopInactivityTimer;
      
      // إعادة تعيين الـ timer عند التركيز على النافذة
      window.addEventListener('focus', () => {
        if (authSystem.getCurrentUser()) {
          resetInactivityTimer();
        }
      });
      
      // إيقاف الـ timer عند فقدان التركيز (اختياري - يمكن إزالته)
      // window.addEventListener('blur', () => {
      //   // يمكن إبقاء الـ timer يعمل حتى عند فقدان التركيز
      // });
    })();
    
    // Function to position modals at center
    function positionModal(modalElement) {
      if (!modalElement) return;
      
      // Reset to default centered position
      modalElement.style.top = '0';
      modalElement.style.left = '0';
      modalElement.style.width = '100vw';
      modalElement.style.height = '100vh';
      modalElement.style.display = 'flex';
      modalElement.style.alignItems = 'center';
      modalElement.style.justifyContent = 'center';
      modalElement.style.padding = '20px';
      
      const modalBox = modalElement.querySelector('.box');
      if (modalBox) {
        modalBox.style.margin = 'auto';
        modalBox.style.position = 'relative';
        modalBox.style.top = 'auto';
        modalBox.style.left = 'auto';
        modalBox.style.transform = 'none';
      }
    }
    
    // Function to close modals properly
    function closeModal(modalElement) {
      if (!modalElement) return;
      modalElement.classList.remove('open');
      modalElement.style.display = 'none';
      // Reset positioning
      modalElement.style.top = '0';
      modalElement.style.left = '0';
      modalElement.style.width = '100vw';
      modalElement.style.height = '100vh';
      modalElement.style.padding = '20px';
    }
    
    // Function to ensure input fields are editable
    function ensureInputFieldsEditable() {
      const usernameInput = document.getElementById('authUsername');
      const passwordInput = document.getElementById('authPassword');
      
      if (usernameInput) {
        // إزالة جميع القيود
        usernameInput.style.pointerEvents = 'auto';
        usernameInput.style.userSelect = 'text';
        usernameInput.style.cursor = 'text';
        usernameInput.removeAttribute('readonly');
        usernameInput.removeAttribute('disabled');
        usernameInput.setAttribute('autocomplete', 'username');
        usernameInput.setAttribute('spellcheck', 'false');
        usernameInput.style.opacity = '1';
        usernameInput.style.zIndex = '10000';
        usernameInput.style.position = 'relative';
        usernameInput.tabIndex = 0;
        usernameInput.disabled = false;
        usernameInput.readOnly = false;
        
        // إزالة جميع event listeners السابقة لتجنب التكرار
        const newUsernameInput = usernameInput.cloneNode(true);
        usernameInput.parentNode.replaceChild(newUsernameInput, usernameInput);
        
        // إضافة event listeners جديدة
        newUsernameInput.addEventListener('click', function(e) {
          e.stopPropagation();
          this.focus();
        }, true);
        
        newUsernameInput.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          this.style.pointerEvents = 'auto';
        }, true);
        
        newUsernameInput.addEventListener('focus', function(e) {
          e.stopPropagation();
          this.style.pointerEvents = 'auto';
          this.style.userSelect = 'text';
        }, true);
        
        newUsernameInput.addEventListener('input', function(e) {
          e.stopPropagation();
        }, true);
        
        newUsernameInput.addEventListener('keydown', function(e) {
          e.stopPropagation();
        }, true);
      }
      
      if (passwordInput) {
        // إزالة جميع القيود
        passwordInput.style.pointerEvents = 'auto';
        passwordInput.style.userSelect = 'text';
        passwordInput.style.cursor = 'text';
        passwordInput.removeAttribute('readonly');
        passwordInput.removeAttribute('disabled');
        passwordInput.setAttribute('autocomplete', 'current-password');
        passwordInput.setAttribute('spellcheck', 'false');
        passwordInput.style.opacity = '1';
        passwordInput.style.zIndex = '10000';
        passwordInput.style.position = 'relative';
        passwordInput.tabIndex = 0;
        passwordInput.disabled = false;
        passwordInput.readOnly = false;
        
        // إزالة جميع event listeners السابقة لتجنب التكرار
        const newPasswordInput = passwordInput.cloneNode(true);
        passwordInput.parentNode.replaceChild(newPasswordInput, passwordInput);
        
        // إضافة event listeners جديدة
        newPasswordInput.addEventListener('click', function(e) {
          e.stopPropagation();
          this.focus();
        }, true);
        
        newPasswordInput.addEventListener('mousedown', function(e) {
          e.stopPropagation();
          this.style.pointerEvents = 'auto';
        }, true);
        
        newPasswordInput.addEventListener('focus', function(e) {
          e.stopPropagation();
          this.style.pointerEvents = 'auto';
          this.style.userSelect = 'text';
        }, true);
        
        newPasswordInput.addEventListener('input', function(e) {
          e.stopPropagation();
        }, true);
        
        newPasswordInput.addEventListener('keydown', function(e) {
          e.stopPropagation();
        }, true);
      }
    }

    // Function to ensure all inputs in the page are editable (except disabled/readonly ones)
    function ensureAllInputsEditable() {
      // Get all inputs, textareas, and select elements
      const allInputs = document.querySelectorAll('input:not([readonly]):not([disabled]), textarea:not([readonly]):not([disabled]), select:not([disabled])');
      
      allInputs.forEach(input => {
        // Skip if it's in a hidden overlay
        const overlay = document.getElementById('authOverlay');
        if (overlay && overlay.contains(input) && overlay.style.display === 'none') {
          return;
        }
        
        // Ensure input is editable
        input.style.pointerEvents = 'auto';
        input.style.userSelect = 'text';
        input.style.cursor = input.tagName === 'SELECT' ? 'pointer' : 'text';
        input.removeAttribute('readonly');
        if (input.hasAttribute('disabled') && input.getAttribute('disabled') !== 'true') {
          input.removeAttribute('disabled');
        }
        input.style.opacity = '1';
        input.style.zIndex = '1';
        input.tabIndex = input.tabIndex >= 0 ? input.tabIndex : 0;
        
        // Add click handler to ensure focus
        input.addEventListener('click', function(e) {
          if (!this.disabled && !this.readOnly) {
            this.focus();
          }
        }, { once: false });
      });
    }

    // Function to initialize all inputs
    function initializeInputs() {
      ensureInputFieldsEditable();
      ensureAllInputsEditable();
    }

    // Run immediately when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeInputs);
    } else {
      initializeInputs();
    }
    
    // Run again after a short delay to ensure it works
    setTimeout(initializeInputs, 100);
    
    // Run again after a longer delay as backup
    setTimeout(initializeInputs, 500);
    
    // Also run when the page is fully loaded
    window.addEventListener('load', initializeInputs);
    
    // إعادة تفعيل حقول تسجيل الدخول بشكل دوري عند ظهور الـ overlay
    setInterval(() => {
      const overlay = document.getElementById('authOverlay');
      if (overlay && overlay.style.display !== 'none' && overlay.style.display !== '') {
        ensureInputFieldsEditable();
      }
    }, 1000);
    
    // Additional safety check - run on any click interaction
    document.addEventListener('click', function(e) {
      // استثناء حقول تسجيل الدخول - معالجة خاصة
      if (e.target.id === 'authUsername' || e.target.id === 'authPassword') {
        e.stopPropagation();
        const input = e.target;
        input.style.pointerEvents = 'auto';
        input.style.userSelect = 'text';
        input.style.cursor = 'text';
        input.removeAttribute('readonly');
        input.removeAttribute('disabled');
        input.disabled = false;
        input.readOnly = false;
        input.tabIndex = 0;
        setTimeout(() => {
          try {
            input.focus();
          } catch (err) {
            // Ignore focus errors
          }
        }, 10);
        return;
      }
      
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        // Immediately enable the input
        if (!e.target.disabled && !e.target.readOnly) {
          e.target.style.pointerEvents = 'auto';
          e.target.style.userSelect = 'text';
          e.target.style.cursor = e.target.tagName === 'SELECT' ? 'pointer' : 'text';
          e.target.removeAttribute('readonly');
          e.target.tabIndex = e.target.tabIndex >= 0 ? e.target.tabIndex : 0;
          
          // Force focus after a tiny delay to ensure it works
          setTimeout(() => {
            try {
              e.target.focus();
            } catch (err) {
              // Ignore focus errors
            }
          }, 5);
        }
      }
    }, true);
    
    // Also handle mousedown for better responsiveness
    document.addEventListener('mousedown', function(e) {
      // استثناء حقول تسجيل الدخول
      if (e.target.id === 'authUsername' || e.target.id === 'authPassword') {
        e.stopPropagation();
        e.target.style.pointerEvents = 'auto';
        e.target.disabled = false;
        e.target.readOnly = false;
        return;
      }
      
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        if (!e.target.disabled && !e.target.readOnly) {
          e.target.style.pointerEvents = 'auto';
        }
      }
    }, true);
    
    // معالجة خاصة لحقول تسجيل الدخول عند الكتابة
    document.addEventListener('keydown', function(e) {
      if (e.target.id === 'authUsername' || e.target.id === 'authPassword') {
        e.stopPropagation();
        e.target.style.pointerEvents = 'auto';
        e.target.disabled = false;
        e.target.readOnly = false;
      }
    }, true);
    
    document.addEventListener('input', function(e) {
      if (e.target.id === 'authUsername' || e.target.id === 'authPassword') {
        e.stopPropagation();
        e.target.style.pointerEvents = 'auto';
        e.target.disabled = false;
        e.target.readOnly = false;
      }
    }, true);
    
    // Run when overlay visibility changes
    const overlayObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
          const overlay = document.getElementById('authOverlay');
          if (overlay) {
            if (overlay.style.display === 'none' || overlay.style.display === '') {
              setTimeout(ensureAllInputsEditable, 50);
            } else {
              setTimeout(ensureInputFieldsEditable, 50);
            }
          }
        }
      });
    });
    
    // Observe overlay for style changes
    const authOverlay = document.getElementById('authOverlay');
    if (authOverlay) {
      overlayObserver.observe(authOverlay, { attributes: true, attributeFilter: ['style'] });
    }
    
    // Update modal position on window resize
    window.addEventListener('resize', function() {
      const openModals = document.querySelectorAll('.modal.open');
      openModals.forEach(modal => {
        positionModal(modal);
      });
    });
    
    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.modal.open');
        openModals.forEach(modal => {
          closeModal(modal);
        });
      }
    });

    const SUPABASE_URL = 'https://vpvvjascwgivdjyyhzwp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwdnZqYXNjd2dpdmRqeXloendwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MDYxMjYsImV4cCI6MjA2NTM4MjEyNn0.6AR2-MG4x9ugNTXe9jUqx-IwGEtj1m6MCYwQkTsSbUQ';
    
    const SupabaseManager = {
      _instance: null,
      _isInitialized: false,
      connectionStatus: 'disconnected',
      _creationAttempts: 0,
      _maxAttempts: 3,
      
      getInstance() {
        if (this._instance) {
          return this._instance;
        }
        
        if (this._creationAttempts >= this._maxAttempts) {
          console.warn('Max creation attempts reached, not creating new instance');
          return null;
        }
        
        if (!this._isInitialized) {
          this._isInitialized = true;
          this._creationAttempts++;
          
          try {
            console.log(`Creating Supabase client (Singleton) - Attempt ${this._creationAttempts}...`);
            this._instance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
              auth: {
                persistSession: false,
                autoRefreshToken: false,
                detectSessionInUrl: false
              }
            });
            
          } catch (e) {
            console.error('Failed to create Supabase client:', e);
            this._isInitialized = false;
            return null;
          }
        }
        return this._instance;
      },
      
      reset() {
        
        this.connectionStatus = 'disconnected';
        this._creationAttempts = 0;
        this._isInitialized = false;
      },
      
      isConnected() {
        return this._instance !== null && this.connectionStatus === 'connected';
      },
      
      hasInstance() {
        return this._instance !== null;
      }
    };
    
    function getSupabaseClient() {
      return SupabaseManager.getInstance();
    }
    
    function reinitializeSupabase() {
      try {
        
        
        if (SupabaseManager.hasInstance()) {
          
          SupabaseManager.connectionStatus = 'disconnected';
          return true;
        }
        
        SupabaseManager.reset();
        const client = getSupabaseClient();
        if (client) {
          
          return true;
        } else {
          console.error('Failed to reinitialize Supabase client');
          return false;
        }
      } catch (e) {
        console.error('Failed to reinitialize Supabase client:', e);
        return false;
      }
    }
   
    const STORAGE_KEY = 'agents_dashboard_data_v1';

    window.toggleUserContactPopup = function(event) {
      if (event) {
        event.stopPropagation();
      }
      const popup = document.getElementById('userContactPopup');
      const sidebarUser = document.getElementById('sidebarUser');
      if (!popup || !sidebarUser) {
        return false;
      }
      
      const isShowing = popup.classList.contains('show');
      if (isShowing) {
        popup.style.animation = 'popupFadeOut 0.15s ease-out forwards';
        setTimeout(() => {
          popup.classList.remove('show');
          popup.style.display = 'none';
          popup.style.opacity = '0';
          popup.style.visibility = 'hidden';
          popup.style.pointerEvents = 'none';
          popup.style.animation = '';
          popup.style.transform = '';
          if (sidebarUser) {
            sidebarUser.style.transform = 'scale(1)';
            sidebarUser.style.boxShadow = '0 4px 12px rgba(128, 28, 50, 0.4)';
          }
        }, 150);
      } else {
        const allPopups = document.querySelectorAll('.user-contact-popup.show');
        allPopups.forEach(p => {
          p.classList.remove('show');
          p.style.display = 'none';
          p.style.opacity = '0';
          p.style.visibility = 'hidden';
          p.style.pointerEvents = 'none';
          p.style.animation = '';
          p.style.transform = '';
        });
        
        const rect = sidebarUser.getBoundingClientRect();
        const popupWidth = 250;
        const popupHeight = 200;
        
        const left = rect.left - popupWidth - 10;
        const top = rect.top;
        
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        let finalLeft = left;
        let finalTop = top;
        
        if (finalLeft < 10) {
          finalLeft = rect.right + 10;
        }
        if (finalLeft + popupWidth > windowWidth - 10) {
          finalLeft = windowWidth - popupWidth - 10;
        }
        if (finalTop + popupHeight > windowHeight - 10) {
          finalTop = windowHeight - popupHeight - 10;
        }
        if (finalTop < 10) {
          finalTop = 10;
        }
        
        popup.style.left = finalLeft + 'px';
        popup.style.top = finalTop + 'px';
        popup.style.transform = 'translateY(0)';
        
        popup.style.display = 'block';
        popup.style.visibility = 'visible';
        popup.style.pointerEvents = 'auto';
        popup.style.transform = 'translateY(0)';
        
        setTimeout(() => {
          popup.classList.add('show');
        }, 10);
      }
      return false;
    };
    
    // إغلاق popup عند النقر خارجها
    document.addEventListener('click', (e) => {
      const popup = document.getElementById('userContactPopup');
      const sidebarUser = document.getElementById('sidebarUser');
      if (popup && sidebarUser && popup.classList.contains('show')) {
        if (!popup.contains(e.target) && !sidebarUser.contains(e.target)) {
          toggleUserContactPopup();
        }
      }
    });

    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connectionStatus');
      const iconEl = document.getElementById('statusIcon');
      const textEl = document.getElementById('statusText');
      
      if (!statusEl || !iconEl || !textEl) return;
      
    
      statusEl.className = '';
      
      switch(status) {
        case 'connected':
          statusEl.classList.add('connected');
          iconEl.textContent = '✓';
          textEl.textContent = 'متصل';
          break;
        case 'error':
          statusEl.classList.add('error');
          iconEl.textContent = '💾';
          if (window.location.protocol === 'file:') {
            textEl.textContent = 'وضع محلي فقط';
          } else {
            textEl.textContent = 'وضع محلي فقط';
          }
          break;
        case 'connecting':
          statusEl.classList.add('connecting');
          iconEl.textContent = '🔄';
          textEl.textContent = 'جاري الاتصال...';
          break;
        default:
          statusEl.classList.add('connecting');
          iconEl.textContent = '🔄';
          textEl.textContent = 'جاري الاتصال...';
      }
    }


    function validateAgentData(agent) {
      const errors = [];
      
      if (!agent.name || agent.name.trim() === '') {
        errors.push('اسم الوكيل مطلوب');
      }
      
      if (!agent.contract_date) {
        errors.push('تاريخ العقد مطلوب');
      }
      
      if (!agent.phase || !['PHASE1', 'PHASE2', 'PHASE3', 'OLD'].includes(agent.phase)) {
        errors.push('المرحلة يجب أن تكون PHASE1, PHASE2, PHASE3, أو OLD');
      }
      
      if (typeof agent.total_users !== 'number' || agent.total_users < 0) {
        errors.push('إجمالي المستخدمين يجب أن يكون رقم موجب');
      }
      
      if (typeof agent.active !== 'number' || agent.active < 0) {
        errors.push('المستخدمون النشطون يجب أن يكون رقم موجب');
      }
      
      if (typeof agent.prev_active !== 'number' || agent.prev_active < 0) {
        errors.push('المستخدمون النشطون السابقون يجب أن يكون رقم موجب');
      }
      
      return {
        isValid: errors.length === 0,
        errors: errors
      };
    }

    async function testSupabaseConnection() {
      try {
        // Warn if running from file:// but still try to connect
        if (window.location.protocol === 'file:') {
          console.warn('Running from file:// protocol. Supabase may not work due to CORS, but will try anyway...');
        }
        
        updateConnectionStatus('connecting');
        
        console.log('Supabase Key (first 20 chars):', SUPABASE_ANON_KEY.substring(0, 20) + '...');
        
        const supabase = getSupabaseClient();
        if (!supabase) {
          console.error('Failed to get Supabase client');
          updateConnectionStatus('error');
          return false;
        }
        
        // Add timeout to prevent hanging
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Connection timeout')), 10000)
        );
        
        const queryPromise = supabase
          .from('agents')
          .select('id, name, active, total_users, board_name') 
          .limit(1)
          .then(result => result);
        
        const result = await Promise.race([queryPromise, timeoutPromise]);
        const { data, error } = result;
          
        if (error) {
          console.error('Supabase connection test failed:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          console.error('Error details:', error.details);
          console.error('Error hint:', error.hint);
          
          // Check for network errors
          if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
            console.warn('Network error detected. This might be due to CORS or network issues.');
            console.warn('The application will work with local storage only.');
          }
          
          if (error.message && error.message.includes('board_name')) {
            console.warn('board_name column not found, trying without it...');
            const { data: retryData, error: retryError } = await supabase
              .from('agents')
              .select('id, name, active, total_users')
              .limit(1);
              
            if (retryError) {
              console.error('Retry also failed:', retryError);
              SupabaseManager.connectionStatus = 'error';
              updateConnectionStatus('error');
              return false;
            } else {
              SupabaseManager.connectionStatus = 'connected';
              updateConnectionStatus('connected');
              return true;
            }
          }
          
          console.error('Note: Make sure the database has the required columns: name, note, contract_date, phase, fdt, total_users, active, prev_active');
          SupabaseManager.connectionStatus = 'error';
          updateConnectionStatus('error');
          return false;
        } else {
          if (data && data.length > 0) {
            console.log('Available columns:', Object.keys(data[0]));
          }
          SupabaseManager.connectionStatus = 'connected';
          updateConnectionStatus('connected');
          return true;
        }
      } catch (e) {
        console.error('Supabase connection test error:', e);
        console.error('Error type:', e.name);
        console.error('Error message:', e.message);
        
        // Check if it's a network/CORS error
        if (e.message && (e.message.includes('Failed to fetch') || e.message.includes('NetworkError') || e.message.includes('timeout'))) {
          console.warn('Network/CORS error. The application will work with local storage only.');
          console.warn('To use Supabase, please run the application from a web server (not file://)');
        }
        
        if (e.stack) {
          console.error('Error stack:', e.stack);
        }
        
        SupabaseManager.connectionStatus = 'error';
        updateConnectionStatus('error');
        return false;
      }
    }

    const tbody = document.querySelector('#agentsTable tbody');
    const totalAgentsEl = document.getElementById('totalAgents');
    const totalUsersEl = document.getElementById('totalUsers');
    const totalActiveEl = document.getElementById('totalActive');
    const overallActEl = document.getElementById('overallActivation');
    const phaseFilter = document.getElementById('phaseFilter');
    const searchBox = document.getElementById('searchBox');
    const sortBy = document.getElementById('sortBy');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnAddAgent = document.getElementById('btnAddAgent');
    const btnTheme = document.getElementById('btnTheme');

    const modalEdit = document.getElementById('modalEdit');
    const editName = document.getElementById('editName');
    const editTotal = document.getElementById('editTotal');
    const editActive = document.getElementById('editActive');
    const saveActiveBtn = document.getElementById('saveActive');
    const closeModalBtn = document.getElementById('closeModal');

    const modalAdd = document.getElementById('modalAdd');
    const closeAddModal = document.getElementById('closeAddModal');
    const saveNewAgent = document.getElementById('saveNewAgent');
    const modalEditInfo = document.getElementById('modalEditInfo');
    const closeInfoModal = document.getElementById('closeInfoModal');
    const saveInfo = document.getElementById('saveInfo');

    let barChart=null, pieChart=null;
    let agents = [];
    let dbIdByLocalId = new Map();
    let localIdByDbId = new Map();

    function migrateData(){
      let changed = false;
      agents.forEach(a=>{
        const norm = normalizePhase(a.phase);
        if(a.phase !== norm){ a.phase = norm; changed = true; }
        if((a.name||'').trim() === 'abbas عباس حلواص' && a.phase !== 'PHASE1'){
          a.phase = 'PHASE1';
          changed = true;
        }
      });
      if(changed){ saveToStorage(); }
    }


    function parseDateAuto(s){
      if(!s) return null;
      if(s instanceof Date) return s;
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00');
      if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){
        const parts = s.split('/');
        return new Date(+parts[2], +parts[1]-1, +parts[0]);
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }

    function monthsBetween(d1, d2){
      const y1=d1.getFullYear(), m1=d1.getMonth();
      const y2=d2.getFullYear(), m2=d2.getMonth();
      return Math.max(0, (y2 - y1)*12 + (m2 - m1));
    }

    function normalizePhase(value){
      const s = String(value||'').trim().toLowerCase();
      if(!s) return '';
      if(s.includes('phase2') || s.includes('phase 2') || s.includes('phase-2') || s.includes('المرحلة') && s.includes('2')) return 'PHASE2';
      if(s.includes('phase3') || s.includes('phase 3') || s.includes('phase-3') || (s.includes('المرحلة') && s.includes('3'))) return 'PHASE3';
      if(s.includes('old') || s.includes('قديم') || s.includes('المشروع القديم')) return 'OLD';
      if(s.includes('phase1') || s.includes('phase 1') || s.includes('phase-1') || s.includes('المشروع الجديد')) return 'PHASE1';
      const up = s.toUpperCase();
      if(['PHASE1','PHASE2','PHASE3','OLD'].includes(up)) return up;
      return '';
    }

    function arabicPhaseLabel(phase){
      switch(String(phase||'').toUpperCase()){
        case 'PHASE1': return ' المرحلة الثانية ';
        case 'PHASE2': return ' المرحلة الثانية ';
        case 'PHASE3': return 'المرحلة الثالثة';
        case 'OLD': return 'المشروع القديم';
        default: return '';
      }
    }

    function toYMDLocal(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function genId(){
      return 'a_' + Math.random().toString(36).slice(2,8) + Date.now().toString(36).slice(-4);
    }

    function computeAgent(agent){
      if(!agent._id) agent._id = genId();
      const now = new Date();
      const contract = parseDateAuto(agent.contract_date) || now;
      const months = monthsBetween(contract, now);
      agent.contract_date = toYMDLocal(contract); 
      agent.months_since = months;
      agent.phase = normalizePhase(agent.phase);
      let required = months >= 8 ? 80 : 60;
      agent.required_rate = required;

      agent.total_users = Number(agent.total_users) || 0;
      agent.active = Number(agent.active) || 0;

      // حساب النمو الأسبوعي من قاعدة البيانات
      agent.growth = Math.round(agent.active - Number(agent.prev_active||0));
      agent.activation_rate = agent.total_users ? +( (agent.active / agent.total_users) * 100 ) : 0;
      agent.activation_rate = Math.round(agent.activation_rate*10)/10;
      if(required !== null){
        const rawDeficit = required - agent.activation_rate;
        agent.deficit_percent = Math.max(0, Math.round(rawDeficit*10)/10);
        const neededUsers = Math.round((required/100) * agent.total_users);
        agent.required_users = neededUsers;
        agent.deficit_users = Math.max(0, neededUsers - agent.active);
      } else {
        agent.deficit_percent = 0;
        agent.required_users = 0;
        agent.deficit_users = 0;
      }

      if(months < 6) agent.status='جديد';
      else if(agent.activation_rate >= required + 5) agent.status='متفوق';
      else if(agent.activation_rate >= required) agent.status='مطابق';
      else agent.status='عجز';

      return agent;
    }

    function renderTable(){
      let filtered = agents.slice();
      
      

      const phase = phaseFilter.value;
      if(phase) {
        filtered = filtered.filter(a => (a.phase || '').toUpperCase() === phase.toUpperCase());
        
      }

      const q = (searchBox.value || '').trim().toLowerCase();
      if(q){
        filtered = filtered.filter(a => ((a.name||'') + ' ' + (a.itpc_site||'') + ' ' + arabicPhaseLabel(a.phase)).toLowerCase().includes(q));
        
      }

      const sort = sortBy.value;
      if(sort === 'total_users_desc') filtered.sort((a,b)=>b.total_users - a.total_users);
      else if(sort === 'active_desc') filtered.sort((a,b)=> b.active - a.active );
      else if(sort === 'deficit_desc') filtered.sort((a,b)=>b.deficit_users - a.deficit_users);
      else filtered.sort((a,b)=> (a.name||'').localeCompare(b.name || '', 'ar') );

      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }
      
      // Show message if no data
      if (filtered.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="16" style="text-align:center; padding:40px; color:var(--text-secondary);">
            <div style="font-size:16px; font-weight:600; margin-bottom:8px;">لا توجد بيانات</div>
            <div style="font-size:12px; color:var(--text-tertiary);">
              ${window.location.protocol === 'file:' ? 
                'يمكنك إضافة وكلاء جدد باستخدام زر "إضافة وكيل". البيانات سيتم حفظها محلياً.' : 
                'يمكنك إضافة وكلاء جدد باستخدام زر "إضافة وكيل".'}
            </div>
          </td>
        `;
        tbody.appendChild(emptyRow);
        updateStats([]);
        updateCharts([]);
        return;
      }
      
      const PHASE_ORDER = ['OLD','PHASE2','PHASE3'];
      const phaseToItems = {};
      filtered.forEach((a)=>{
        const key = (a.phase||'').toUpperCase();
        if(!phaseToItems[key]) phaseToItems[key] = [];
        phaseToItems[key].push(a);
      });
      
      
      
      const allPhases = PHASE_ORDER.filter(p=>phaseToItems[p] && phaseToItems[p].length>0);
      
      let runningIndex = 0;
      allPhases.forEach(phaseKey=>{
        const items = phaseToItems[phaseKey];
        
        const hdr = document.createElement('tr');
        hdr.className = 'phase-header';
        hdr.innerHTML = `<td colspan="16" style="text-align:right; font-weight:700; background:transparent; font-size:12px; padding:12px; border-bottom:1px solid var(--border-color); color:var(--text-primary);">${arabicPhaseLabel(phaseKey)}</td>`;
        tbody.appendChild(hdr);

        items.forEach((a)=>{
          const idx = runningIndex++;
          
        const tr = document.createElement('tr');
        const todayStr = toYMDLocal(new Date());
        let phoneDisplay = '-';
        if (a.phone) {
          const phones = a.phone.split(',').map(p => p.trim()).filter(p => p);
          if (phones.length > 0) {
            phoneDisplay = phones.map(p => `<a href="tel:${p}" class="phone-link">${escapeHtml(p)}</a>`).join('<br>');
          }
        }
        tr.innerHTML = `
          <td style="text-align:right; padding-right:8px; white-space:normal; word-wrap:break-word; background:transparent;">
            <div style="line-height:1.1; background:transparent;">
              <strong style="font-size:11px; display:block; word-break:break-word; background:transparent;">${escapeHtml(a.name||'---')}</strong>
              <small style="font-size:8px; color:var(--muted); word-break:break-word; background:transparent;">${escapeHtml(a.note||'')}</small>
            </div>
          </td>
          <td style="font-size:10px;">${phoneDisplay}</td>
          <td>${a.contract_date}</td>
            <td>${todayStr}</td>
            <td>${escapeHtml(a.fdt||'')}</td>
          <td>${escapeHtml(a.board_name||'')}</td>
          <td style="font-weight:600;">${num(a.total_users)}</td>
          <td style="font-weight:600; color: #22c55e;">${num(a.active)}</td>
          <td style="font-weight:700; color: #801c32;">${signedNum(a.growth||0)}</td>
          <td style="font-weight:600;">${a.activation_rate}%</td>
          <td style="font-weight:600;">${a.required_rate === null ? '-' : a.required_rate + '%'}</td>
            <td style="font-weight:600;">${a.required_rate === null ? '-' : num(a.required_users)}</td>
          <td style="${a.required_rate === null ? 'font-weight:600;' : getDeficitColor(a.deficit_percent, a.required_rate)}">${a.required_rate === null ? '-' : a.deficit_percent + '%'}</td>
          <td style="${a.deficit_users ? getDeficitUsersColor(a.deficit_users, a.total_users) : 'font-weight:600;'}">${a.deficit_users ? num(a.deficit_users) : '-'}</td>
          <td>${statusBadge(a.status)}</td>
          <td style="background:transparent;">
              <div class="flex" style="justify-content:center; gap:8px; flex-wrap:wrap; background:transparent;">
                <button class="btn secondary small" data-action="edit" data-id="${a._id}" style="display: ${(typeof authSystem !== 'undefined' && authSystem.canEdit()) ? 'inline-flex' : 'none'};">
                  <span class="icon">🔄</span>
                  تحديث
                </button>
                <button class="btn small" data-action="edit-info" data-id="${a._id}" style="display: ${(typeof authSystem !== 'undefined' && authSystem.canEdit()) ? 'inline-flex' : 'none'};">
                  <span class="icon">✏️</span>
                  تعديل
                </button>
              </div>
          </td>
        `;
        tbody.appendChild(tr);
        });

        const totals = items.reduce((acc, a)=>{
          acc.total += Number(a.total_users||0);
          acc.active += Number(a.active||0);
          acc.deficit_users += Number(a.deficit_users||0);
          return acc;
        }, {total:0, active:0, deficit_users:0});
        const sub = document.createElement('tr');
        sub.className = 'subtotal-title';
        sub.innerHTML = `
          <td colspan="5" style="text-align:right; font-weight:600; font-size:10px; padding:8px;">مجموع ${escapeHtml(arabicPhaseLabel(phaseKey))}</td>
          <td></td>
          <td style="font-weight:600; font-size:10px; padding:8px;">${num(totals.total)}</td>
          <td style="font-weight:600; font-size:10px; padding:8px;">${num(totals.active)}</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td style="font-weight:600; font-size:10px; padding:8px; ${totals.deficit_users ? getDeficitUsersColor(totals.deficit_users, totals.total) : ''}">${totals.deficit_users ? num(totals.deficit_users) : '-'}</td>
          <td></td>
          <td></td>
        `;
        tbody.appendChild(sub);
      });

      updateStats(filtered);
      updateCharts(filtered);
      
      
      
      
      if (typeof authSystem !== 'undefined') {
        authSystem.updateElementVisibility();
      }
    }

    function updateStats(list){
      const totalAgents = list.length;
      const totalUsers = list.reduce((s,a)=>s + Number(a.total_users||0), 0);
      const totalActive = list.reduce((s,a)=>s + Number(a.active||0), 0);
      const overallActivation = totalUsers ? Math.round((totalActive / totalUsers) * 1000)/10 : 0;
      totalAgentsEl.textContent = num(totalAgents);
      totalUsersEl.textContent = num(totalUsers);
      totalActiveEl.textContent = num(totalActive);
      overallActEl.textContent = overallActivation + '%';
    }

    function updateCharts(filtered){
      const top = filtered.slice().sort((a,b)=>b.total_users - a.total_users).slice(0,10);
      const labels = top.map(a=>a.name || a.itpc_site || '—');
      const totalData = top.map(a=>a.total_users);
      const activeData = top.map(a=>a.active);

      // Check if light mode is active
      const isLightMode = !document.documentElement.hasAttribute('data-theme') || document.documentElement.getAttribute('data-theme') !== 'dark';
      const textColor = isLightMode ? '#333333' : '#f5f5f5';
      const gridColor = isLightMode ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';

      const barCtx = document.getElementById('barChart').getContext('2d');
      if(barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type:'bar',
        data:{
          labels,
          datasets:[
            { label:'إجمالي المستخدمين', data: totalData },
            { label:'المستخدمون النشطون', data: activeData }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{
              display:true, 
              position:'top',
              labels:{
                color: textColor,
                font: {
                  size: 14,
                  weight: 'bold'
                }
              }
            }
          },
          scales:{
            x:{
              ticks:{
                color: textColor,
                font: {
                  size: 12,
                  weight: 'bold'
                }
              },
              grid: {
                color: gridColor
              }
            }, 
            y:{
              beginAtZero:true, 
              ticks:{
                color: textColor,
                font: {
                  size: 12,
                  weight: 'bold'
                }
              },
              grid: {
                color: gridColor
              }
            }
          }
        }
      });

      const sumActive = filtered.reduce((s,a)=>s + a.active,0);
      const sumTotal = filtered.reduce((s,a)=>s + a.total_users,0);
      const inactive = Math.max(0, sumTotal - sumActive);
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if(pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type:'doughnut',
        data:{
          labels:['نشطون','غير نشطين'],
          datasets:[{ data:[sumActive, inactive] }]
        },
        options:{
          responsive:true, 
          maintainAspectRatio:false, 
          plugins:{
            legend:{
              position:'bottom',
              labels:{
                color: textColor,
                font: {
                  size: 14,
                  weight: 'bold'
                }
              }
            }
          }
        }
      });
    }

    function num(n){ 
      const formatted = new Intl.NumberFormat('en-US').format(Number(n||0));
      return formatted;
    }
    function signedNum(n){ if(n>0) return '+'+num(n); if(n<0) return num(n); return num(0); }
    function statusBadge(status){
      if(status==='متفوق') return `<span class="badge good" style="font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${status}</span>`;
      if(status==='مطابق') return `<span class="badge ok" style="font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${status}</span>`;
      if(status==='عجز') return `<span class="badge fail" style="font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${status}</span>`;
      if(status==='جديد') return `<span class="badge" style="background:rgba(128,28,50,0.2); color:#801c32; border:1px solid rgba(128,28,50,0.4); font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${status}</span>`;
      return `<span class="badge" style="background:rgba(128,28,50,0.08); color:#801c32; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${status}</span>`;
    }
    
    // Function to determine deficit color based on proximity to required rate
    function getDeficitColor(deficitPercent, requiredRate) {
      if (requiredRate === null || requiredRate === 0) {
        const isDark = document.documentElement.hasAttribute('data-theme') && document.documentElement.getAttribute('data-theme') === 'dark';
        return isDark ? 'color: #ffffff; font-weight: 700;' : 'color: #000000; font-weight: 700;';
      }
      
      const isDark = document.documentElement.hasAttribute('data-theme') && document.documentElement.getAttribute('data-theme') === 'dark';
      return isDark ? 'color: #801c32; font-weight: 700;' : 'color: #801c32; font-weight: 700;';
    }
    
    // Function to determine deficit users color based on total users
    function getDeficitUsersColor(deficitUsers, totalUsers) {
      if (totalUsers === 0 || deficitUsers === 0) {
        const isDark = document.documentElement.hasAttribute('data-theme') && document.documentElement.getAttribute('data-theme') === 'dark';
        return isDark ? 'color: #ffffff; font-weight: 700;' : 'color: #000000; font-weight: 700;';
      }
      
      const isDark = document.documentElement.hasAttribute('data-theme') && document.documentElement.getAttribute('data-theme') === 'dark';
      return isDark ? 'color: #801c32; font-weight: 700;' : 'color: #801c32; font-weight: 700;';
    }
    
    // Function to determine deficit users color for reports (more aggressive coloring)
    function getDeficitUsersColorForReport(deficitUsers, totalUsers) {
      if (totalUsers === 0 || deficitUsers === 0) {
        return 'color: #000000; font-weight: 700;';
      }
      
      return 'color: #801c32; font-weight: 700;';
    }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    tbody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit"]');
      if(!btn) return;
      const id = btn.dataset.id;
      if(!id) return;
      const idx = agents.findIndex(a=>a._id === id);
      openEditModal(idx);
    });

    tbody.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-action="edit-info"]');
      if(!btn) return;
      const id = btn.dataset.id;
      const idx = agents.findIndex(a=>a._id === id);
      if(idx < 0) return;
      const a = agents[idx];
      modalEditInfo.classList.add('open');
      document.getElementById('info_name').value = a.name || '';
      document.getElementById('info_note').value = a.note || '';
      document.getElementById('info_date').value = a.contract_date || '';
      document.getElementById('info_phase').value = a.phase || '';
      document.getElementById('info_site').value = a.itpc_site || '';
      document.getElementById('info_fdt').value = a.fdt || '';
      document.getElementById('info_total').value = a.total_users || 0;
      document.getElementById('info_phone').value = a.phone || '';
      const infoBoardEl = document.getElementById('info_board'); if(infoBoardEl) infoBoardEl.value = a.board_name || '';
      modalEditInfo.dataset.editIndex = String(idx);
      
      // Position modal at current scroll position
      setTimeout(() => positionModal(modalEditInfo), 10);
    });

    tbody.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button[data-action="delete"]');
      if(!btn) return;
      const id = btn.dataset.id;
      const idx = agents.findIndex(a=>a._id === id);
      if(idx < 0) return;
      const a = agents[idx];
      
      if(!confirm(`هل تريد حذف الوكيل: ${a.name || ''} ؟`)) return;
      
      try{
        const dbId = dbIdByLocalId.get(a._id);
        if(dbId){
          const supabase = getSupabaseClient();
          if (supabase) {
            const { error } = await supabase.from('agents').delete().eq('id', dbId);
            if(error) console.error('Delete error:', error);
          }
          localIdByDbId.delete(dbId);
          dbIdByLocalId.delete(a._id);
        }
      }catch(e){ 
        console.error('Error deleting agent from database:', e);
        // Continue with local deletion even if database operation fails
      }
      
      agents.splice(idx,1);
      saveToStorage();
      renderTable();
      
    });

    closeInfoModal.addEventListener('click', ()=> closeModal(modalEditInfo));
    saveInfo.addEventListener('click', async ()=>{
      const idx = Number(modalEditInfo.dataset.editIndex || -1);
      if(idx < 0) return;
      const a = agents[idx];
      
      a.name = document.getElementById('info_name').value.trim() || a.name;
      a.note = document.getElementById('info_note').value.trim();
      a.contract_date = document.getElementById('info_date').value || a.contract_date;
      a.phase = normalizePhase(document.getElementById('info_phase').value);
      a.itpc_site = document.getElementById('info_site').value.trim();
      a.fdt = document.getElementById('info_fdt').value.trim();
      a.total_users = Number(document.getElementById('info_total').value || a.total_users);
      a.phone = (document.getElementById('info_phone')?.value || '').trim();
      a.board_name = (document.getElementById('info_board')?.value || '').trim();
      computeAgent(a);
      
      try{
        const dbId = dbIdByLocalId.get(a._id);
        
        
        if(dbId){
          
          const supabase = getSupabaseClient();
          if (!supabase) {
            console.error('Supabase client not available');
            return;
          }
          
          // Build update data with only essential columns that definitely exist
          const updateData = {
            name: a.name,
            note: a.note || '',
            contract_date: a.contract_date || '',
            phase: a.phase || '',
            total_users: a.total_users || 0,
            active: a.active || 0,
            prev_active: a.prev_active || 0
          };
          
          // Add optional columns if they exist (using 'site' instead of 'itpc_site' for database)
          if (a.itpc_site !== undefined) {
            updateData.site = String(a.itpc_site || '');
          }
          if (a.fdt !== undefined) {
            updateData.fdt = String(a.fdt || '');
          }
          if (a.board_name !== undefined) {
            updateData.board_name = String(a.board_name || '');
          }
          if (a.phone !== undefined) {
            updateData.phone = String(a.phone || '');
          }
          
          // Try to update
          let { error } = await supabase
            .from('agents')
            .update(updateData)
            .eq('id', dbId);
            
          if(error) {
            // If error is due to missing columns, try again without optional columns
            if (error.message && (error.message.includes('site') || error.message.includes('fdt') || error.message.includes('board_name') || error.message.includes('phone') || error.message.includes('column'))) {
              console.warn('Some columns not found, retrying update without optional columns...');
              const updateDataMinimal = {
                name: a.name,
                note: a.note || '',
                contract_date: a.contract_date || '',
                phase: a.phase || '',
                total_users: a.total_users || 0,
                active: a.active || 0,
                prev_active: a.prev_active || 0
              };
              
              const { error: retryError } = await supabase
                .from('agents')
                .update(updateDataMinimal)
                .eq('id', dbId);
                
              if (retryError) {
                console.warn('Database update skipped (columns may not exist):', retryError.message);
              } else {
                console.log('✓ Updated successfully (without optional columns)');
              }
            } else {
              console.warn('Database update skipped:', error.message);
            }
          } else {
            console.log('✓ Updated successfully');
          }
        } else {
          
          console.log('Available dbIdByLocalId:', Array.from(dbIdByLocalId.entries()));
        }
      }catch(e){ 
        console.error('Error updating agent info:', e); 
      }
      
      saveToStorage();
      renderTable();
      closeModal(modalEditInfo);
      
    });

    document.getElementById('deleteFromInfoModal').addEventListener('click', async ()=>{
      const idx = Number(modalEditInfo.dataset.editIndex || -1);
      if(idx < 0) return;
      const a = agents[idx];
      if(!confirm(`هل تريد حذف الوكيل: ${a.name || ''} ؟`)) return;
      try{
        const dbId = dbIdByLocalId.get(a._id);
        if(dbId){
          const supabase = getSupabaseClient();
          if (supabase) {
          const { error } = await supabase.from('agents').delete().eq('id', dbId);
          if(error) console.error('Delete error:', error);
          }
          localIdByDbId.delete(dbId);
          dbIdByLocalId.delete(a._id);
        }
      }catch(e){ 
        console.error('Error deleting agent from database:', e);
        // Continue with local deletion even if database operation fails
      }
      agents.splice(idx,1);
      saveToStorage();
      renderTable();
      modalEditInfo.classList.remove('open');
    });


    function openEditModal(idx){
      const agent = agents[idx];
      if(!agent) return;
      modalEdit.classList.add('open');
      editName.value = agent.name || '';
      editTotal.value = agent.total_users || 0;
      editActive.value = agent.active || 0;
      modalEdit.dataset.editIndex = idx;
      
      // Position modal at current scroll position
      setTimeout(() => positionModal(modalEdit), 10);
    }

    closeModalBtn.addEventListener('click', ()=> closeModal(modalEdit));
    saveActiveBtn.addEventListener('click', async ()=>{
      const idx = Number(modalEdit.dataset.editIndex || -1);
      if(idx < 0) return;
      const agent = agents[idx];
      if(!agent) return;
      const newActive = Number(editActive.value || 0);
      
      if(!Array.isArray(agent.history)) agent.history = [];
      agent.history.push({ date: toYMDLocal(new Date()), active: Number(agent.active||0) });
      agent.prev_active = Number(agent.active||0); // حفظ القيمة السابقة قبل التحديث
      agent.active = newActive;
      computeAgent(agent);
      
      try{
        const dbId = dbIdByLocalId.get(agent._id);
        if(dbId){
          
          const supabase = getSupabaseClient();
          if (supabase) {
          const { error } = await supabase
            .from('agents')
              .update({ 
                active: agent.active, 
                prev_active: agent.prev_active,
                board_name: agent.board_name
              })
            .eq('id', dbId);
          if(error) {
            console.error('Supabase update active error:', error);
          } else {
            
            }
          } else {
            
          }
        } else {
          
        }
      }catch(e){ 
        console.error('Error updating active users:', e); 
      }
      
      saveToStorage();
      renderTable();
      closeModal(modalEdit);
      
    });

    btnAddAgent.addEventListener('click', ()=> {
      modalAdd.classList.add('open');
      
      // Position modal at current scroll position
      setTimeout(() => positionModal(modalAdd), 10);
    });
    
    closeAddModal.addEventListener('click', ()=> closeModal(modalAdd));
    saveNewAgent.addEventListener('click', async ()=>{
      const name = document.getElementById('new_name').value.trim();
      const date = document.getElementById('new_date').value;
      const phase = normalizePhase(document.getElementById('new_phase').value);
      const site = document.getElementById('new_site').value.trim();
      const fdt = document.getElementById('new_fdt').value.trim();
      const note = document.getElementById('new_note').value.trim();
      const board = (document.getElementById('new_board')?.value || '').trim();
      const phone = (document.getElementById('new_phone')?.value || '').trim();
      const total = Number(document.getElementById('new_total').value || 0);
      const active = Number(document.getElementById('new_active').value || 0);
      
      if(!name){
        alert('يرجى إدخال اسم الوكيل');
        return;
      }
      
      const obj = { 
        name, 
        contract_date: date || toYMDLocal(new Date()), 
        phase, 
        itpc_site: site, 
        fdt, 
        note, 
        board_name: board, 
        phone,
        total_users: total, 
        active, 
        prev_active: 0 
      };
      
      console.log('Created obj with keys:', Object.keys(obj));
      
      
      computeAgent(obj);
      
      const validation = validateAgentData(obj);
      if (!validation.isValid) {
        alert('خطأ في البيانات:\n' + validation.errors.join('\n'));
        return;
      }
      
      try{
        
        
        
        const supabase = getSupabaseClient();
        if (!supabase) {
          console.error('Supabase client not available, saving locally only');
          obj._id = genId();
          agents.push(obj);
          saveToStorage();
          renderTable();
          closeModal(modalAdd);
          console.log(`تم إضافة الوكيل "${name}" محلياً فقط (لا يوجد اتصال بقاعدة البيانات)`);
          return;
        }
        
        // Build insert data - start with required fields
        const insertData = {
          name: String(obj.name || ''),
          note: String(obj.note || ''),
          contract_date: String(obj.contract_date || ''),
          phase: String(obj.phase || ''),
          total_users: Number(obj.total_users || 0),
          active: Number(obj.active || 0),
          prev_active: Number(obj.prev_active || 0)
        };
        
        // Add optional columns if they exist (using 'site' instead of 'itpc_site' for database)
        if (obj.itpc_site !== undefined) {
          insertData.site = String(obj.itpc_site || '');
        }
        if (obj.fdt !== undefined) {
          insertData.fdt = String(obj.fdt || '');
        }
        if (obj.board_name !== undefined) {
          insertData.board_name = String(obj.board_name || '');
        }
        if (obj.phone !== undefined) {
          insertData.phone = String(obj.phone || '');
        }
        
        console.log('Insert data (before send):', JSON.stringify(insertData, null, 2));
        console.log('Original obj keys:', Object.keys(obj));
        console.log('Insert data keys:', Object.keys(insertData));
        
        
        
        if (insertData.hasOwnProperty('board_name')) {
          
        } else {
          console.error('ERROR: board_name NOT found in insertData!');
        }
        
        
        
        const { data, error } = await supabase
          .from('agents')
          .insert(insertData)
          .select('*')
          .single();
          
        if(error){
          console.error('Supabase insert error:', error);
          console.error('Error details:', error.message, error.details, error.hint);
          console.error('Error code:', error.code);
          
          if (error.message && (error.message.includes('board_name') || error.message.includes('site') || error.message.includes('fdt') || error.message.includes('phone') || error.message.includes('column'))) {
            console.warn('Some columns not found, inserting without optional columns...');
            const insertDataMinimal = {
              name: String(obj.name || ''),
              note: String(obj.note || ''),
              contract_date: String(obj.contract_date || ''),
              phase: String(obj.phase || ''),
              total_users: Number(obj.total_users || 0),
              active: Number(obj.active || 0),
              prev_active: Number(obj.prev_active || 0)
            };
            
            const { data: retryData, error: retryError } = await supabase
              .from('agents')
              .insert(insertDataMinimal)
              .select('*')
              .single();
              
            if (retryError) {
              console.error('Retry insert also failed:', retryError);
              obj._id = genId();
              agents.push(obj);
              
            } else {
              
              obj._id = genId();
              obj.db_id = retryData.id;
              dbIdByLocalId.set(obj._id, retryData.id);
              localIdByDbId.set(retryData.id, obj._id);
              agents.push(obj);
            }
          } else {
            let errorMessage = 'فشل في حفظ البيانات في قاعدة البيانات:\n';
            if (error.message) errorMessage += error.message + '\n';
            if (error.details) errorMessage += 'التفاصيل: ' + error.details + '\n';
            if (error.hint) errorMessage += 'نصيحة: ' + error.hint;
            
            alert(errorMessage);
            
            obj._id = genId();
            agents.push(obj);
            
          }
        } else {
          
          obj._id = genId();
          obj.db_id = data.id;
          dbIdByLocalId.set(obj._id, data.id);
          localIdByDbId.set(data.id, obj._id);
          agents.push(obj);
        }
      }catch(e){
        console.error('Error inserting agent:', e);
        console.error('Error stack:', e.stack);
        obj._id = genId();
        agents.push(obj);
      }
      
      saveToStorage();
      renderTable();
      
      closeModal(modalAdd);
      document.getElementById('new_name').value='';
      document.getElementById('new_date').value='';
      document.getElementById('new_site').value='';
      document.getElementById('new_fdt').value='';
      document.getElementById('new_note').value='';
      document.getElementById('new_phone').value='';
      document.getElementById('new_total').value='';
      document.getElementById('new_active').value='';
      
      
      
      
    });

    function saveToStorage(){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(agents));
        localStorage.setItem(STORAGE_KEY + '_timestamp', Date.now().toString());
        console.log('Data saved to local storage successfully at:', new Date().toLocaleString());
        
        return true;
      } catch (error) {
        console.error('Error saving to local storage:', error);
        return false;
      }
    }
    function loadFromStorage(){
      try{
        const s = localStorage.getItem(STORAGE_KEY);
        if(!s) {
          console.log('No data found in localStorage with key:', STORAGE_KEY);
          // Try to find any related keys
          const allKeys = Object.keys(localStorage);
          const relatedKeys = allKeys.filter(key => key.includes('agents') || key.includes('dashboard'));
          if(relatedKeys.length > 0) {
            console.log('Found related keys in localStorage:', relatedKeys);
          }
          return null;
        }
        const arr = JSON.parse(s);
        if(!Array.isArray(arr)) {
          console.error('Data in localStorage is not an array:', typeof arr);
          return null;
        }
        if(arr.length === 0) {
          console.log('Data found in localStorage but array is empty');
          return null;
        }
        console.log(`Loading ${arr.length} agents from localStorage...`);
        arr.forEach(a => {
          computeAgent(a);
       
          if(a.db_id) {
            dbIdByLocalId.set(a._id, a.db_id);
            localIdByDbId.set(a.db_id, a._id);
          }
        });
        console.log('Loaded from storage, dbIdByLocalId entries:', Array.from(dbIdByLocalId.entries()));
        return arr;
      }catch(e){ 
        console.error('Error loading from localStorage:', e);
        return null; 
      }
    }

    function computeAll(){
      agents.forEach(a=>computeAgent(a));
      renderTable();
    }


    async function loadFromSupabase(){
      try {
        console.log('Attempting to load data from Supabase...');
        
        const supabase = getSupabaseClient();
        if (!supabase) {
          console.error('Supabase client not available');
          throw new Error('Supabase client not available');
        }
        
        console.log('Querying agents table...');
        const { data, error } = await supabase
          .from('agents')
          .select('*')
          .order('id', { ascending: true });

        if(error){
          console.error('Supabase load error:', error);
          console.error('Error details:', error.message, error.details, error.hint);
          throw error;
        }

        if(!data || data.length === 0){
          console.log('No data found in Supabase database');
          agents = [];
          computeAll();
          return;
        }

        console.log(`Found ${data.length} agents in database, processing...`);
        
        // Debug: Check first agent's structure
        if (data.length > 0) {
          console.log('Sample agent from database:', data[0]);
          console.log('Available columns:', Object.keys(data[0]));
        }
        
        agents = data.map(row=>{
          const obj = {
            _id: genId(),
            db_id: row.id,
            name: row.name,
            note: row.note,
            contract_date: row.contract_date,
            phase: row.phase,
            itpc_site: row.site || row.itpc_site || '', // Use 'site' from DB, fallback to 'itpc_site' for compatibility
            fdt: row.fdt || '',
            board_name: row.board_name || '', 
            phone: row.phone || '', // Keep phone locally even if not in DB
            total_users: row.total_users,
            active: row.active, 
            prev_active: row.prev_active || 0,
            history: []
          };
          
          // Debug: Log ITPC Site data
          if (obj.itpc_site) {
            console.log('Agent', obj.name, 'has itpc_site:', obj.itpc_site);
          } else if (obj.note) {
            console.log('Agent', obj.name, 'has note (may contain ITPC):', obj.note);
          }
          
          dbIdByLocalId.set(obj._id, row.id);
          localIdByDbId.set(row.id, obj._id);
          
          return computeAgent(obj);
        });
        
        console.log(`✓ Successfully loaded ${agents.length} agents from Supabase`);
        console.log('dbIdByLocalId entries:', Array.from(dbIdByLocalId.entries()));
        
        // Save to localStorage as backup
        saveToStorage();
        
        computeAll();
        
      } catch(e) {
        console.error('Error loading from Supabase:', e);
        throw e; // Re-throw to let initializeData handle fallback
      }
    }

    phaseFilter.addEventListener('change', renderTable);
    searchBox.addEventListener('input', renderTable);
    sortBy.addEventListener('change', renderTable);

    function safeNum(x){ return Number(x||0) || 0; }

    
    async function initializeData() {
      try {
        updateConnectionStatus('connecting');
        
        // Try to connect to Supabase first
        let connectionOk = await testSupabaseConnection();
        
        if (!connectionOk && !SupabaseManager.hasInstance()) {
          console.warn('Supabase connection failed, trying to reinitialize...');
          updateConnectionStatus('connecting');
          reinitializeSupabase();
          connectionOk = await testSupabaseConnection();
        } else if (!connectionOk) {
          console.warn('Supabase connection failed, but instance exists - will try to load from database anyway');
        }
        
        // Try to load from Supabase if connection is OK or if we have an instance
        if (connectionOk || SupabaseManager.hasInstance()) {
          try {
            await loadFromSupabase();
            // If loadFromSupabase succeeded, we're done
            return;
          } catch (e) {
            console.error('Error loading from Supabase:', e);
            // Fall through to load from localStorage
          }
        }
        
        // If Supabase failed, try to load from local storage
        console.warn('Loading from local storage as fallback');
        updateConnectionStatus('error');
        const localData = loadFromStorage();
        if (localData && localData.length > 0) {
          agents = localData;
          console.log(`✓ Loaded ${agents.length} agents from local storage`);
        } else {
          agents = [];
          console.log('No local data found, starting with empty table');
        }
        computeAll();
      } catch (e) {
        console.error('Error initializing data:', e);
        // Try to load from local storage as fallback
        const localData = loadFromStorage();
        if (localData && localData.length > 0) {
          agents = localData;
          console.log(`Loaded ${agents.length} agents from local storage (fallback)`);
        } else {
          agents = [];
        }
        computeAll();
      }
    }
    
    function initializeSupabase() {
      
      const client = getSupabaseClient();
      if (client) {
        
        return true;
      } else {
        console.error('Failed to initialize Supabase client');
        return false;
      }
    }

    window.addEventListener('beforeunload', function() {
      
      SupabaseManager.reset();
    });

    
    initializeSupabase();
    initializeData();
    
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof authSystem !== 'undefined') {
        authSystem.updateUI();
      }
    });
    
    function applyTheme(theme){
      const html = document.documentElement;
      btnTheme.textContent = '';
      if(theme === 'dark'){
        html.setAttribute('data-theme', 'dark');
        const moonIcon = document.createElement('span');
        moonIcon.className = 'icon';
        moonIcon.textContent = '🌙';
        btnTheme.appendChild(moonIcon);
        btnTheme.appendChild(document.createTextNode(''));
      } else {
        html.removeAttribute('data-theme');
        const sunIcon = document.createElement('span');
        sunIcon.className = 'icon';
        sunIcon.textContent = '☀️';
        btnTheme.appendChild(sunIcon);
        btnTheme.appendChild(document.createTextNode(''));
      }
    }
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    btnTheme.addEventListener('click', ()=>{
      const current = localStorage.getItem('theme') || 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });


    document.addEventListener('click', (e)=>{
      if(e.target === modalEdit) {
        closeModal(modalEdit);
      }
      if(e.target === modalAdd) {
        closeModal(modalAdd);
      }
      if(e.target === modalEditInfo) {
        closeModal(modalEditInfo);
      }
    });


    const STORAGE_KEY_NOTIFICATIONS = 'agents_notifications_v1';
    
    let notifications = JSON.parse(localStorage.getItem(STORAGE_KEY_NOTIFICATIONS) || '[]');
    
    function saveNotifications() {
      localStorage.setItem(STORAGE_KEY_NOTIFICATIONS, JSON.stringify(notifications));
    }
    
    function getUniqueITPCSites() {
      const sites = new Set();
      console.log('getUniqueITPCSites: Total agents:', agents.length);
      
      agents.forEach(a => {
        let site = '';
        // First check itpc_site field
        if (a.itpc_site && a.itpc_site.trim()) {
          site = a.itpc_site.trim();
          console.log('Found ITPC Site in itpc_site field:', site, 'for agent:', a.name);
        } 
        // Then check note field for ITPC Site
        else if (a.note && a.note.trim()) {
          const noteText = a.note.trim();
          console.log('Checking note field for agent:', a.name, 'note:', noteText);
          
          // Try multiple patterns to extract ITPC Site from note
          // Examples: "Said Al-shohdaa ITPC", "Al-Mualmeen ITPC", "ABS ITPC", "IQCELL_29"
          const patterns = [
            // Pattern: "[name] ITPC" - Most common format (e.g., "Said Al-shohdaa ITPC")
            /^([A-Za-z0-9][A-Za-z0-9\s\-_]+?)\s+(?:ITPC|itpc)$/i,
            // Pattern: "[name] ITPC" anywhere in text
            /([A-Za-z0-9][A-Za-z0-9\s\-_]+?)\s+(?:ITPC|itpc)/i,
            // Pattern: "ITPC Site: [name]" or "ITPC Site [name]"
            /(?:ITPC|itpc)[\s:]*Site[\s:]*([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: "ITPC: [name]" or "ITPC [name]"
            /(?:ITPC|itpc)[\s:]+([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: "Site: [name]" or "Site [name]"
            /Site[\s:]+([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: Just the site name if note is simple (e.g., "IQCELL_29")
            /^([A-Za-z0-9][A-Za-z0-9\s\-_]+)$/i
          ];
          
          for (const pattern of patterns) {
            const noteMatch = noteText.match(pattern);
            if (noteMatch && noteMatch[1]) {
              site = noteMatch[1].trim();
              // Clean up common prefixes/suffixes
              site = site.replace(/^(ITPC|itpc|Site|site)[\s:]*/i, '').trim();
              // Remove trailing ITPC if exists
              site = site.replace(/\s+(?:ITPC|itpc)$/i, '').trim();
              if (site && site.length > 0 && site.length < 50) { // Reasonable length check
                console.log('Found ITPC Site in note:', site, 'for agent:', a.name);
                break;
              }
            }
          }
        }
        
        if (site) {
          sites.add(site);
        } else {
          console.log('No ITPC Site found for agent:', a.name, 'itpc_site:', a.itpc_site, 'note:', a.note);
        }
      });
      
      const sitesArray = Array.from(sites).sort();
      console.log('getUniqueITPCSites: Found sites:', sitesArray);
      return sitesArray;
    }
    
    function getAgentsByITPCSite(site) {
      const targetSite = site.trim();
      console.log('getAgentsByITPCSite: Looking for site:', targetSite);
      
      return agents.filter(a => {
        let agentSite = '';
        // First check itpc_site field
        if (a.itpc_site && a.itpc_site.trim()) {
          agentSite = a.itpc_site.trim();
        } 
        // Then check note field for ITPC Site
        else if (a.note && a.note.trim()) {
          const noteText = a.note.trim();
          // Try multiple patterns to extract ITPC Site from note
          // Examples: "Said Al-shohdaa ITPC", "Al-Mualmeen ITPC", "ABS ITPC", "IQCELL_29"
          const patterns = [
            // Pattern: "[name] ITPC" - Most common format (e.g., "Said Al-shohdaa ITPC")
            /^([A-Za-z0-9][A-Za-z0-9\s\-_]+?)\s+(?:ITPC|itpc)$/i,
            // Pattern: "[name] ITPC" anywhere in text
            /([A-Za-z0-9][A-Za-z0-9\s\-_]+?)\s+(?:ITPC|itpc)/i,
            // Pattern: "ITPC Site: [name]" or "ITPC Site [name]"
            /(?:ITPC|itpc)[\s:]*Site[\s:]*([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: "ITPC: [name]" or "ITPC [name]"
            /(?:ITPC|itpc)[\s:]+([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: "Site: [name]" or "Site [name]"
            /Site[\s:]+([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: Just the site name if note is simple (e.g., "IQCELL_29")
            /^([A-Za-z0-9][A-Za-z0-9\s\-_]+)$/i
          ];
          
          for (const pattern of patterns) {
            const noteMatch = noteText.match(pattern);
            if (noteMatch && noteMatch[1]) {
              agentSite = noteMatch[1].trim();
              // Clean up common prefixes/suffixes
              agentSite = agentSite.replace(/^(ITPC|itpc|Site|site)[\s:]*/i, '').trim();
              // Remove trailing ITPC if exists
              agentSite = agentSite.replace(/\s+(?:ITPC|itpc)$/i, '').trim();
              if (agentSite && agentSite.length > 0 && agentSite.length < 50) {
                break;
              }
            }
          }
        }
        
        const matches = agentSite && agentSite.toLowerCase() === targetSite.toLowerCase();
        if (matches) {
          console.log('Matched agent:', a.name, 'with site:', agentSite);
        }
        return matches;
      });
    }
    
    function getAllAgents() {
      return agents.slice();
    }
    
    function sendNotificationToAgents(agentIds, message) {
      const timestamp = new Date().toISOString();
      agentIds.forEach(agentId => {
        notifications.push({
          id: 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          agentId: agentId,
          message: message,
          timestamp: timestamp,
          read: false
        });
      });
      saveNotifications();
      updateNotificationBadge();
    }
    
    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const btn = document.getElementById('btnNotifications');
      if (btn) {
        if (unreadCount > 0) {
          btn.classList.add('has-notifications');
          btn.title = `${unreadCount} إشعار غير مقروء`;
        } else {
          btn.classList.remove('has-notifications');
          btn.title = 'الإشعارات';
        }
      }
    }
    
    function renderNotificationGroups() {
      const select = document.getElementById('notificationGroup');
      const groupsList = document.getElementById('agentGroupsList');
      
      if (!select || !groupsList) {
        console.error('renderNotificationGroups: select or groupsList not found');
        return;
      }
      
      console.log('renderNotificationGroups: Starting, agents count:', agents.length);
      
      // Remove old event listeners by cloning the select
      const newSelect = select.cloneNode(true);
      select.parentNode.replaceChild(newSelect, select);
      
      newSelect.innerHTML = '<option value="">-- اختر ITPC Site --</option>';
      newSelect.innerHTML += '<option value="ALL">جميع الوكلاء</option>';
      
      const sites = getUniqueITPCSites();
      console.log('renderNotificationGroups: Found', sites.length, 'unique sites');
      
      if (sites.length > 0) {
        sites.forEach(site => {
          const option = document.createElement('option');
          option.value = site;
          const siteAgents = getAgentsByITPCSite(site);
          console.log('Site:', site, 'has', siteAgents.length, 'agents');
          option.textContent = `${site} (${siteAgents.length} وكيل)`;
          newSelect.appendChild(option);
        });
      } else {
        console.warn('renderNotificationGroups: No ITPC sites found! Check agents data.');
        // Add a debug option to show all agents
        const debugOption = document.createElement('option');
        debugOption.value = 'DEBUG';
        debugOption.textContent = `[DEBUG] لا توجد مواقع - إجمالي الوكلاء: ${agents.length}`;
        newSelect.appendChild(debugOption);
      }
      
      // Show message to select a site by default
      groupsList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);"><div style="font-size:16px; margin-bottom:8px;">👆</div><div>يرجى اختيار ITPC Site من القائمة أعلاه</div></div>';
      updateSelectedCount();
      
      newSelect.addEventListener('change', (e) => {
        const selectedSite = e.target.value;
        groupsList.innerHTML = '';
        
        if (!selectedSite || selectedSite === '') {
          groupsList.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);"><div style="font-size:16px; margin-bottom:8px;">👆</div><div>يرجى اختيار ITPC Site من القائمة أعلاه</div></div>';
          updateSelectedCount();
          return;
        }
        
        if (selectedSite === 'ALL') {
          displayAgentsBySite(groupsList);
          return;
        }
        
        if (selectedSite === 'DEBUG') {
          // Show all agents for debugging
          groupsList.innerHTML = '';
          const debugHeader = document.createElement('div');
          debugHeader.style.cssText = 'font-weight:700; font-size:16px; padding:16px; background:var(--warning); color:white; border-radius:8px; margin-bottom:12px; text-align:center;';
          debugHeader.innerHTML = `🔍 وضع DEBUG - جميع الوكلاء (${agents.length})`;
          groupsList.appendChild(debugHeader);
          
          agents.forEach(agent => {
            const item = createAgentItem(agent);
            const debugInfo = document.createElement('div');
            debugInfo.style.cssText = 'font-size:10px; color:var(--text-tertiary); margin-top:4px;';
            debugInfo.innerHTML = `itpc_site: "${agent.itpc_site || '(فارغ)'}" | note: "${agent.note || '(فارغ)'}"`;
            item.appendChild(debugInfo);
            groupsList.appendChild(item);
          });
          updateSelectedCount();
          return;
        }
        
        const siteAgents = getAgentsByITPCSite(selectedSite);
        if (siteAgents.length === 0) {
          groupsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">لا يوجد وكلاء في هذا الموقع</div>';
          updateSelectedCount();
          return;
        }
        
        const siteHeader = document.createElement('div');
        siteHeader.style.cssText = 'font-weight:700; font-size:16px; padding:16px; background:var(--primary-color); color:white; border-radius:8px; margin-bottom:12px; text-align:center;';
        siteHeader.innerHTML = `📍 ${selectedSite}<br><small style="font-size:12px; opacity:0.9;">${siteAgents.length} وكيل</small>`;
        groupsList.appendChild(siteHeader);
        
        siteAgents.forEach(agent => {
          const item = createAgentItem(agent);
          groupsList.appendChild(item);
        });
        updateSelectedCount();
      });
    }
    
    function displayAgentsBySite(container) {
      container.innerHTML = '';
      
      if (agents.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">لا يوجد وكلاء</div>';
        updateSelectedCount();
        return;
      }
      
      // Group agents by ITPC Site
      const agentsBySite = {};
      const agentsWithoutSite = [];
      
      agents.forEach(agent => {
        // Check both itpc_site and note fields (note might contain ITPC Site info)
        let site = '';
        // First check itpc_site field
        if (agent.itpc_site && agent.itpc_site.trim()) {
          site = agent.itpc_site.trim();
        } 
        // Then check note field for ITPC Site
        else if (agent.note && agent.note.trim()) {
          const noteText = agent.note.trim();
          // Try multiple patterns to extract ITPC Site from note
          // Examples: "Said Al-shohdaa ITPC", "Al-Mualmeen ITPC", "ABS ITPC", "IQCELL_29"
          const patterns = [
            // Pattern: "[name] ITPC" - Most common format (e.g., "Said Al-shohdaa ITPC")
            /^([A-Za-z0-9][A-Za-z0-9\s\-_]+?)\s+(?:ITPC|itpc)$/i,
            // Pattern: "[name] ITPC" anywhere in text
            /([A-Za-z0-9][A-Za-z0-9\s\-_]+?)\s+(?:ITPC|itpc)/i,
            // Pattern: "ITPC Site: [name]" or "ITPC Site [name]"
            /(?:ITPC|itpc)[\s:]*Site[\s:]*([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: "ITPC: [name]" or "ITPC [name]"
            /(?:ITPC|itpc)[\s:]+([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: "Site: [name]" or "Site [name]"
            /Site[\s:]+([A-Za-z0-9][A-Za-z0-9\s\-_]+)/i,
            // Pattern: Just the site name if note is simple (e.g., "IQCELL_29")
            /^([A-Za-z0-9][A-Za-z0-9\s\-_]+)$/i
          ];
          
          for (const pattern of patterns) {
            const noteMatch = noteText.match(pattern);
            if (noteMatch && noteMatch[1]) {
              site = noteMatch[1].trim();
              // Clean up common prefixes/suffixes
              site = site.replace(/^(ITPC|itpc|Site|site)[\s:]*/i, '').trim();
              // Remove trailing ITPC if exists
              site = site.replace(/\s+(?:ITPC|itpc)$/i, '').trim();
              if (site && site.length > 0 && site.length < 50) {
                break;
              }
            }
          }
        }
        
        // Debug: log agent data
        console.log('displayAgentsBySite - Agent:', agent.name, 'itpc_site:', agent.itpc_site, 'note:', agent.note, 'extracted site:', site);
        
        if (!site || site === '') {
          agentsWithoutSite.push(agent);
        } else {
          if (!agentsBySite[site]) {
            agentsBySite[site] = [];
          }
          agentsBySite[site].push(agent);
        }
      });
      
      console.log('Agents by site:', agentsBySite);
      console.log('Agents without site:', agentsWithoutSite.length);
      
      // Display agents grouped by site
      const sortedSites = Object.keys(agentsBySite).sort();
      sortedSites.forEach(site => {
        const siteHeader = document.createElement('div');
        siteHeader.style.cssText = 'font-weight:700; font-size:14px; padding:12px; background:var(--bg-tertiary); border-radius:8px; margin-top:12px; margin-bottom:8px; color:var(--text-primary); border:1px solid var(--border-color);';
        siteHeader.textContent = `📍 ${site} (${agentsBySite[site].length} وكيل)`;
        container.appendChild(siteHeader);
        
        agentsBySite[site].forEach(agent => {
          const item = createAgentItem(agent);
          container.appendChild(item);
        });
      });
      
      // Display agents without site
      if (agentsWithoutSite.length > 0) {
        const siteHeader = document.createElement('div');
        siteHeader.style.cssText = 'font-weight:700; font-size:14px; padding:12px; background:var(--bg-tertiary); border-radius:8px; margin-top:12px; margin-bottom:8px; color:var(--text-primary); border:1px solid var(--border-color);';
        siteHeader.textContent = `📍 بدون موقع (${agentsWithoutSite.length} وكيل)`;
        container.appendChild(siteHeader);
        
        agentsWithoutSite.forEach(agent => {
          const item = createAgentItem(agent);
          container.appendChild(item);
        });
      }
      
      updateSelectedCount();
    }
    
    function displayAllAgents(container) {
      container.innerHTML = '';
      
      if (agents.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">لا يوجد وكلاء</div>';
        updateSelectedCount();
        return;
      }
      
      agents.forEach(agent => {
        const item = createAgentItem(agent);
        container.appendChild(item);
      });
      updateSelectedCount();
    }
    
    function updateSelectedCount() {
      const selectedItems = document.querySelectorAll('.agent-group-item.selected');
      const countEl = document.getElementById('selectedCount');
      if (countEl) {
        countEl.textContent = `${selectedItems.length} وكيل محدد`;
      }
    }
    
    function createAgentItem(agent) {
      const item = document.createElement('div');
      item.className = 'agent-group-item';
      let phoneInfo = '';
      if (agent.phone) {
        const phones = agent.phone.split(',').map(p => p.trim()).filter(p => p);
        if (phones.length > 0) {
          phoneInfo = `<br><small style="color:var(--info);">📞 ${phones.map(p => escapeHtml(p)).join(' | ')}</small>`;
        }
      }
      item.innerHTML = `
        <strong>${escapeHtml(agent.name || '---')}</strong>
        ${phoneInfo}
      `;
      item.dataset.agentId = agent._id;
      item.addEventListener('click', () => {
        item.classList.toggle('selected');
        updateSelectedCount();
      });
      return item;
    }
    
    async function sendWhatsAppToSingleAgent(phone, agentName, message) {
      if (!phone || phone.length < 12) {
        return false;
      }
      
      const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
      
      if (!whatsappUrl.includes('wa.me/') || whatsappUrl.split('wa.me/')[1].split('?')[0].length < 12) {
        return false;
      }
      
      const link = document.createElement('a');
      link.href = whatsappUrl;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.style.display = 'none';
      document.body.appendChild(link);
      
      try {
        link.click();
        setTimeout(() => {
          if (link.parentNode) {
            link.parentNode.removeChild(link);
          }
        }, 100);
        return true;
      } catch (error) {
        try {
          const newWindow = window.open(whatsappUrl, '_blank');
          setTimeout(() => {
            if (link.parentNode) {
              link.parentNode.removeChild(link);
            }
          }, 100);
          return !!newWindow;
        } catch (e) {
          if (link.parentNode) {
            link.parentNode.removeChild(link);
          }
          return false;
        }
      }
    }

    async function sendWhatsAppNotificationAuto(affectedAgents, message) {
      if (!affectedAgents || affectedAgents.length === 0) {
        return { sent: 0, failed: 0 };
      }
      
      const phoneMap = new Map();
      affectedAgents.forEach(agent => {
        if (agent.phone) {
          const phones = agent.phone.split(',').map(p => p.trim()).filter(p => p);
          phones.forEach(phone => {
            const formattedPhone = formatPhoneForWhatsApp(phone);
            if (formattedPhone && !phoneMap.has(formattedPhone)) {
              phoneMap.set(formattedPhone, {
                phone: formattedPhone,
                agentName: agent.name,
                originalPhone: phone
              });
            }
          });
        }
      });
      
      const phoneNumbers = Array.from(phoneMap.values());
      
      if (phoneNumbers.length === 0) {
        return { sent: 0, failed: 0 };
      }
      
      let sentCount = 0;
      let failedCount = 0;
      
      for (let i = 0; i < phoneNumbers.length; i++) {
        const phoneData = phoneNumbers[i];
        
        setTimeout(() => {
          sendWhatsAppToSingleAgent(phoneData.phone, phoneData.agentName, message).then(success => {
            if (success) {
              sentCount++;
            } else {
              failedCount++;
            }
          });
        }, i * 150);
      }
      
      return { sent: phoneNumbers.length, failed: 0 };
    }

    // Event Listeners
    document.getElementById('btnNotifications')?.addEventListener('click', () => {
      if (agents.length === 0) {
        alert('لا يوجد وكلاء في النظام');
        return;
      }
      renderNotificationGroups();
      document.getElementById('modalNotifications').classList.add('open');
      positionModal(document.getElementById('modalNotifications'));
    });
    
    document.getElementById('closeNotificationsModal')?.addEventListener('click', () => {
      document.getElementById('notificationMessage').value = '';
      document.getElementById('notificationGroup').value = '';
      document.getElementById('agentGroupsList').innerHTML = '';
      updateSelectedCount();
      closeModal(document.getElementById('modalNotifications'));
    });
    
    // متغيرات التحكم في الإرسال
    let isSending = false;
    let shouldStopSending = false;
    let sendingInterval = null;
    
    // دالة لتنسيق رقم الهاتف لواتساب
    function formatPhoneForWhatsApp(phone) {
      if (!phone) return null;
      
      // إزالة جميع الأحرف غير الرقمية
      let cleaned = phone.toString().replace(/[^0-9]/g, '');
      
      // التحقق من أن الرقم ليس فارغاً
      if (!cleaned || cleaned.length === 0) {
        console.warn('Empty phone number after cleaning:', phone);
        return null;
      }
      
      // التحقق من طول الرقم (يجب أن يكون على الأقل 9 أرقام)
      if (cleaned.length < 9) {
        console.warn('Phone number too short:', phone, 'cleaned:', cleaned);
        return null;
      }
      
      // إذا كان الرقم يبدأ بـ 0، استبدله بـ 964 (كود العراق)
      if (cleaned.startsWith('0')) {
        cleaned = '964' + cleaned.substring(1);
      }
      // إذا كان الرقم يبدأ بـ 964، اتركه كما هو
      // إذا كان الرقم يبدأ برقم آخر، أضف 964
      else if (!cleaned.startsWith('964')) {
        cleaned = '964' + cleaned;
      }
      
      // التحقق النهائي من طول الرقم (يجب أن يكون بين 12 و 15 رقم)
      if (cleaned.length < 12 || cleaned.length > 15) {
        console.warn('Invalid phone number length:', phone, 'formatted:', cleaned, 'length:', cleaned.length);
        return null;
      }
      
      return cleaned;
    }
    
    document.getElementById('sendNotification')?.addEventListener('click', async () => {
      const message = document.getElementById('notificationMessage').value.trim();
      if (!message) {
        alert('يرجى إدخال الرسالة');
        return;
      }
      
      const selectedSite = document.getElementById('notificationGroup').value;
      const selectedItems = document.querySelectorAll('.agent-group-item.selected');
      
      let selectedAgents = [];
      
      // إذا تم اختيار وكلاء محددين، استخدمهم
      if (selectedItems.length > 0) {
        const agentIds = Array.from(selectedItems).map(item => item.dataset.agentId).filter(id => id);
        selectedAgents = agents.filter(a => agentIds.includes(a._id));
      } 
      // إذا تم اختيار موقع ITPC Site
      else if (selectedSite && selectedSite !== '' && selectedSite !== 'DEBUG') {
        if (selectedSite === 'ALL') {
          selectedAgents = getAllAgents();
        } else {
          selectedAgents = getAgentsByITPCSite(selectedSite);
        }
      }
      // إذا لم يتم اختيار شيء
      else {
        alert('يرجى اختيار ITPC Site أو تحديد وكلاء أولاً');
        return;
      }
      
      if (selectedAgents.length === 0) {
        alert('لا يوجد وكلاء لإرسال الرسالة إليهم');
        return;
      }
      
      // جمع جميع أرقام الهواتف مع تجنب التكرار
      const phoneMap = new Map();
      selectedAgents.forEach(agent => {
        if (agent.phone) {
          const phones = agent.phone.split(',').map(p => p.trim()).filter(p => p);
          phones.forEach(phone => {
            const formattedPhone = formatPhoneForWhatsApp(phone);
            if (formattedPhone && !phoneMap.has(formattedPhone)) {
              phoneMap.set(formattedPhone, {
                phone: formattedPhone,
                agentName: agent.name,
                originalPhone: phone
              });
            }
          });
        }
      });
      
      const phoneNumbers = Array.from(phoneMap.values());
      
      if (phoneNumbers.length === 0) {
        alert('لا توجد أرقام هواتف صحيحة للوكلاء المحددين');
        return;
      }
      
      // إعداد واجهة الإرسال
      isSending = true;
      shouldStopSending = false;
      const sendBtn = document.getElementById('sendNotification');
      const progressDiv = document.getElementById('sendingProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStats = document.getElementById('progressStats');
      const progressDetails = document.getElementById('progressDetails');
      const stopBtn = document.getElementById('stopSending');
      
      const originalText = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = 'جاري الإرسال...';
      
      // إظهار شريط التقدم
      progressDiv.style.display = 'block';
      stopBtn.style.display = 'none';
      
      try {
        let sentCount = 0;
        let failedCount = 0;
        const startTime = Date.now();
        
        // فتح جميع المحادثات دفعة واحدة مع تأخير صغير جداً
        for (let i = 0; i < phoneNumbers.length; i++) {
          const phoneData = phoneNumbers[i];
          
          setTimeout(() => {
            if (!shouldStopSending) {
              sendWhatsAppToSingleAgent(phoneData.phone, phoneData.agentName, message).then(success => {
                if (success) {
                  sentCount++;
                } else {
                  failedCount++;
                }
                
                const progress = ((sentCount + failedCount) / phoneNumbers.length) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `جاري الإرسال... (${sentCount + failedCount}/${phoneNumbers.length})`;
                progressDetails.textContent = `${phoneData.agentName} - ${phoneData.originalPhone}`;
                
                if (sentCount + failedCount === phoneNumbers.length) {
                  selectedAgents.forEach(agent => {
                    sendNotificationToAgents([agent._id], message);
                  });
                  
                  const endTime = Date.now();
                  const totalTime = Math.round((endTime - startTime) / 1000);
                  
                  progressBar.style.width = '100%';
                  progressText.textContent = 'اكتمل الإرسال';
                  progressDetails.textContent = `تم فتح ${sentCount} نافذة واتساب${failedCount > 0 ? ` (فشل: ${failedCount})` : ''}`;
                  
                  setTimeout(() => {
                    document.getElementById('notificationMessage').value = '';
                    document.getElementById('notificationGroup').value = '';
                    document.getElementById('agentGroupsList').innerHTML = '';
                    updateSelectedCount();
                    progressDiv.style.display = 'none';
                    closeModal(document.getElementById('modalNotifications'));
                    sendBtn.disabled = false;
                    sendBtn.textContent = originalText;
                    isSending = false;
                  }, 2000);
                }
              });
            }
          }, i * 150);
        }
        
      } catch (error) {
        console.error('Error sending notifications:', error);
        progressText.textContent = '❌ حدث خطأ';
        progressDetails.textContent = 'حدث خطأ أثناء الإرسال. يرجى المحاولة مرة أخرى.';
        alert('حدث خطأ أثناء الإرسال: ' + error.message);
      } finally {
        isSending = false;
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
        stopBtn.style.display = 'none';
      }
    });
    
    // معالج زر الإيقاف
    document.getElementById('stopSending')?.addEventListener('click', () => {
      if (confirm('هل أنت متأكد من إيقاف الإرسال؟')) {
        shouldStopSending = true;
        document.getElementById('stopSending').disabled = true;
        document.getElementById('stopSending').textContent = 'جاري الإيقاف...';
      }
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      updateNotificationBadge();
    });

    document.getElementById('btnWeeklyReport').addEventListener('click', ()=>{
      const todayStr = toYMDLocal(new Date());
      const headers = ['الوكيل','تاريخ العقد','تاريخ اليوم','FDT',' اللوحة','إجمالي المستخدمين','النشط الحالي','النمو الأسبوعي','معدل التفعيل','النسبة المطلوبة','المطلوب للوصول','نسبة العجز','عدد العجز','الحالة'];

      const PHASE_ORDER = ['OLD','PHASE2','PHASE3'];
      let list = agents.slice();
      const sort = (document.getElementById('sortBy')||{}).value || 'name';
      if(sort === 'total_users_desc') list.sort((a,b)=> b.total_users - a.total_users);
      else if(sort === 'active_desc') list.sort((a,b)=> b.active - a.active);
      else if(sort === 'deficit_desc') list.sort((a,b)=> b.deficit_users - a.deficit_users);
      else list.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ar'));

      const phaseToItems = {};
      list.forEach(a=>{
        const key = (a.phase||'').toUpperCase();
        if(!phaseToItems[key]) phaseToItems[key] = [];
        phaseToItems[key].push(a);
      });

      let html = '';
      html += `<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تقرير متابعة الوكلاء</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      width: 100%; 
      height: 100vh; 
      margin: 0; 
      padding: 0; 
      font-family: "Arial", "Helvetica", sans-serif;
      color: #000;
      overflow: hidden;
    }
    @page { 
      size: A4 landscape; 
      margin: 5mm; 
    }
    table { 
      width: calc(100vw - 10mm); 
      height: calc(100vh - 10mm); 
      border-collapse: collapse; 
      table-layout: fixed; 
      font-size: 10px; 
      font-weight: bold;
      margin: 5mm;
    }
    th, td { 
      border: 1px solid #000; 
      padding: 3px 4px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
      vertical-align: middle;
    }
    th { 
      background: #000; 
      color: #fff; 
      font-weight: bold;
      font-size: 11px;
      height: 25px;
    }
    td:nth-child(1) { 
      text-align: right; 
      width: 10%;
    }
    td:nth-child(2), td:nth-child(3) { 
      width: 5%;
    }
    td:nth-child(4) { 
      width: 6%;
    }
    td:nth-child(5) { 
      width: 5%;
    }
    td:nth-child(6) { 
      width: 7%;
    }
    td:nth-child(7) { 
      width: 5%;
    }
    td:nth-child(8) { 
      width: 6%;
    }
    td:nth-child(9) { 
      width: 6%;
    }
    td:nth-child(10) { 
      width: 7%;
    }
    td:nth-child(11) { 
      width: 5%;
    }
    td:nth-child(12) { 
      width: 7%;
    }
    td:nth-child(13) { 
      width: 3%;
    }
    td:nth-child(14) { 
      width: 5%;
    }
    tr.phase-row td { 
      background: #d0d0d0; 
      font-weight: bold; 
      text-align: right; 
      color: #000;
      font-size: 10px;
      height: 20px;
      border: none;
    }
    
    tr.phase-row td:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    tr.phase-row td:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    tr.subtotal-title td { 
      background: #c0c0c0; 
      font-weight: bold; 
      text-align: right; 
      color: #000;
      height: 18px;
      border: none;
    }
    
    tr.subtotal-title td:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    tr.subtotal-title td:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    tr.subtotal-values td { 
      background: #e0e0e0; 
      font-weight: bold; 
      color: #000;
      height: 16px;
      border: none;
    }
    
    tr.subtotal-values td:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    tr.subtotal-values td:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    tr.grand-total td { 
      background: #a0a0a0; 
      font-weight: bold; 
      color: #000;
      height: 18px;
      border: none;
    }
    
    tr.grand-total td:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }
    
    /* تحسين صفوف المشروع للوضع المضيء */
    :root:not([data-theme="dark"]) tr.phase-row td { 
      background: #e2e8f0; 
      color: #333333;
    }
    
    :root:not([data-theme="dark"]) tr.subtotal-title td { 
      background: #cbd5e1; 
      color: #333333;
    }
    
    :root:not([data-theme="dark"]) tr.subtotal-values td { 
      background: #f1f5f9; 
      color: #333333;
    }
    
    :root:not([data-theme="dark"]) tr.grand-total td { 
      background: #94a3b8; 
      color: #333333;
    }
    .left { text-align: right; }
    @media print { 
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }
      html, body { 
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        font-family: "Arial", "Helvetica", sans-serif !important;
        color: #000 !important;
        position: relative !important;
      } 
      table {
        width: calc(100% - 10mm) !important;
        height: calc(100% - 10mm) !important;
        font-size: 9px !important;
        font-weight: bold !important;
        border-collapse: collapse !important;
        margin: 5mm !important;
        table-layout: fixed !important;
      }
      th, td {
        padding: 3px 4px !important;
        font-size: 9px !important;
        font-weight: bold !important;
        border: 1px solid #000 !important;
        color: #000 !important;
        vertical-align: top !important;
      }
      
      td:nth-child(1) { width: 15% !important; text-align: right !important; }
      td:nth-child(2), td:nth-child(3) { width: 7% !important; }
      td:nth-child(4) { width: 10% !important; }
      td:nth-child(5) { width: 10% !important; }
      td:nth-child(6) { width: 10% !important; }
      td:nth-child(7) { width: 10% !important; }
      td:nth-child(8) { width: 6% !important; }
      td:nth-child(9) { width: 8% !important; }
      td:nth-child(10) { width: 6% !important; }
      td:nth-child(11) { width: 8% !important; }
      td:nth-child(12) { width: 6% !important; }
      td:nth-child(13) { width: 8% !important; }
      td:nth-child(14) { width: 10% !important; }
      
      td:nth-child(4), td:nth-child(5) {
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow: visible !important;
        text-overflow: unset !important;
      }
      th {
        font-size: 10px !important;
        height: 30px !important;
        background: #000 !important;
        color: #fff !important;
        font-weight: bold !important;
        text-align: center !important;
        vertical-align: middle !important;
        white-space: nowrap !important;
        padding: 5px 4px !important;
      }
      tr.phase-row td {
        height: 20px !important;
        font-size: 10px !important;
        background: #d0d0d0 !important;
        color: #000 !important;
      }
      tr.subtotal-title td {
        height: 18px !important;
        background: #c0c0c0 !important;
        color: #000 !important;
      }
      tr.subtotal-values td {
        height: 16px !important;
        background: #e0e0e0 !important;
        color: #000 !important;
      }
      tr.grand-total td {
        height: 18px !important;
        background: #a0a0a0 !important;
        color: #000 !important;
      }
      thead { display: table-header-group !important; } 
      tfoot { display: table-footer-group !important; } 
      tr, td, th { page-break-inside: avoid !important; } 
      @page {
        size: A4 landscape !important;
        margin: 5mm !important;
      }
      .signature { position: fixed; bottom: 20px; left: 20px; font-size: 8px; font-weight: normal; color: #999; z-index: 9999; background: white; padding: 5px; }
    }
  </style>
</head>
<body>`;
      html += '<table><thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';

      let grand = { total:0, active:0, deficit_users:0 };

      PHASE_ORDER.forEach(phaseKey=>{
        const items = phaseToItems[phaseKey];
        if(!items || items.length===0) return;

        html += `<tr class=\"phase-row\"><td colspan=\"${headers.length}\" class=\"left\">${arabicPhaseLabel(phaseKey)}</td></tr>`;

        items.forEach(a=>{
          html += '<tr>' + [
            escapeHtml(a.name || ''),
            a.contract_date || '',
            todayStr,
            a.fdt || '',
            (a.board_name || ''),
            num(a.total_users),
            num(a.active),
            `<span style="font-weight:700; color: #801c32;">${signedNum(a.growth||0)}</span>`,
            (a.activation_rate||0) + '%',
            (a.required_rate === null ? '-' : a.required_rate + '%'),
            (a.required_rate === null ? '-' : num(a.required_users)),
            (a.required_rate === null ? '-' : `<span style="${getDeficitColor(a.deficit_percent||0, a.required_rate)}">${(a.deficit_percent||0) + '%'}</span>`),
            (a.deficit_users ? `<span style="${getDeficitUsersColorForReport(a.deficit_users, a.total_users)}">${num(a.deficit_users)}</span>` : '-'),
            statusBadge(a.status || '')
          ].map(v=>`<td>${v}</td>`).join('') + '</tr>';
        });

        const totals = items.reduce((acc, a)=>{
          acc.total += Number(a.total_users||0);
          acc.active += Number(a.active||0);
          acc.deficit_users += Number(a.deficit_users||0);
          return acc;
        }, {total:0, active:0, deficit_users:0});
        grand.total += totals.total; grand.active += totals.active; grand.deficit_users += totals.deficit_users;

        html += `<tr class=\"subtotal-title\"><td colspan=\"${headers.length}\" class=\"left\">مجموع ${arabicPhaseLabel(phaseKey)}</td></tr>`;
        const cells = new Array(headers.length).fill('');
        cells[6] = num(totals.total);
        cells[7] = num(totals.active);
        cells[12] = totals.deficit_users ? `<span style="${getDeficitUsersColorForReport(totals.deficit_users, totals.total)}">${num(totals.deficit_users)}</span>` : '-';
        html += '<tr class=\"subtotal-values\">' + cells.map(v=>`<td>${v}</td>`).join('') + '</tr>';
      });

      const grandCells = new Array(headers.length).fill('');
      grandCells[6] = num(grand.total);
      grandCells[7] = num(grand.active);
      grandCells[12] = grand.deficit_users ? `<span style="${getDeficitUsersColorForReport(grand.deficit_users, grand.total)}">${num(grand.deficit_users)}</span>` : '-';
      html += `<tr class=\"grand-total\"><td colspan=\"${headers.length}\" class=\"left\">المجموع الكل</td></tr>`;
      html += '<tr class=\"grand-total\">' + grandCells.map(v=>`<td>${v}</td>`).join('') + '</tr>';

      html += '</tbody></table>';
      html += '</body>';
      html += '<script>setTimeout(function(){ if(window.print) window.print(); }, 300);<\/script>';
      html += '</html>';

      const w = window.open('about:blank','_blank');
      if(w){ w.document.open(); w.document.write(html); w.document.close(); }
    });


  </script>
</body>
</html>
